<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>街景行为问卷调研</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .image-container {
            width: 666px;
            height: 500px;
        }
        .survey-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
        .timer-warning {
            background-color: #fef3c7;
            color: #d97706;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .consent-text {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 管理员入口 -->
    <div class="admin-panel">
        <button onclick="showAdminPanel()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
            管理员
        </button>
    </div>

    <!-- 调试面板 -->
    <div id="debugPanel" class="debug-panel">
        <div>🔧 调试信息</div>
        <div id="debugLog"></div>
        <button onclick="toggleDebug()" style="background: #333; color: #fff; border: none; padding: 2px 5px; margin-top: 5px;">隐藏</button>
    </div>

    <!-- 语言选择页面 -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">街景行为感知问卷</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">语言选择</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    中文
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- 基础信息收集页面 -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-3xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">窗景感知问卷：第一部分</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="space-y-6">
                    <!-- 昵称输入 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="nicknameLabel">您的昵称是：</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nicknameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="">
                        <p id="nicknameHint" class="text-sm text-gray-500 mt-1">用于兑换被试费用</p>
                    </div>

                    <!-- 性别选择 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">您的性别是：</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">男</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">女</span>
                            </label>
                        </div>
                    </div>

                    <!-- 年龄输入 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">您的年龄：</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- 专业背景 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">您来自城市规划/建筑/风景园林相关专业吗？</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">是</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">否</span>
                            </label>
                        </div>
                    </div>

                    <!-- 知情同意 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="consentTitle">实验知情同意</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="consent-text">
                            <div id="consentText">
                                <p class="mb-3"><strong>实验主体：</strong>香港科技大学（广州）城市治理与设计学域Urban Morphology Studio (UMS)</p>
                                <p class="mb-3"><strong>实验目的：</strong>本实验旨在了解人们对不同街景环境中行为适宜性的感知和偏好。通过系统性的街景图片对比，我们希望识别个体如何评估空间对各种人类活动的支持性，从而为循证城市设计实践做出贡献。</p>
                                <p class="mb-3"><strong>实验过程：</strong>在实验过程中，我们将记录：</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>您的基本信息（昵称、性别、年龄、专业背景）</li>
                                    <li>您对不同街景图片的行为适宜性选择</li>
                                    <li>您的选择时间和浏览时长</li>
                                    <li>参与实验的时间戳</li>
                                </ul>
                                <p class="mb-3"><strong>数据使用：</strong>收集的所有数据将仅用于城市设计和空间感知相关的科学研究。我们承诺：</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>您的个人信息将被严格保密</li>
                                    <li>数据仅用于学术研究目的</li>
                                    <li>研究结果将以匿名化的形式发表</li>
                                    <li>您有权在任何时候退出实验</li>
                                </ul>
                                <p class="mb-3"><strong>联系方式：</strong>如有任何疑问，请联系研究团队。</p>
                                <p class="font-semibold">参与本实验即表示您已充分了解上述内容并自愿参加。</p>
                            </div>
                        </div>
                        <label class="flex items-start mt-3">
                            <input type="checkbox" id="consentCheckbox" class="mt-1 mr-3">
                            <span id="consentAgree">我已阅读并理解上述说明，同意参与本实验</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        下一部分
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片对比页面 -->
    <div id="comparisonPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between text-gray-800 mb-4">
                <div>
                    <span id="groupCounter">第 1 组</span>
                </div>
                <div>
                    <span id="progressCounter">1/50</span>
                </div>
            </div>
            
            <!-- 顶部提示 -->
            <div class="bg-white rounded-lg p-4 mb-6">
                <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">提示</h3>
                <p id="instructions" class="text-sm text-gray-600">
                    在此调研中，您需要对每对图片回答四个不同的行为问题。请根据您的直觉选择您认为更加适合进行各种活动的街景。所有问题都必须回答完毕才能进入下一对图片。
                </p>
            </div>
            
            <!-- 图片展示区域 -->
            <div class="flex justify-center mb-6 space-x-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageALabel" class="font-bold text-gray-800">图片 A</span>
                    </div>
                    <div class="image-container">
                        <img id="imageA_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageBLabel" class="font-bold text-gray-800">图片 B</span>
                    </div>
                    <div class="image-container">
                        <img id="imageB_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
            </div>
            
            <!-- 问题区域 -->
            <div class="bg-white rounded-lg p-6 mb-6">
                <div class="space-y-6">
                    <!-- 问题1：坐 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question1" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"坐"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题2：行走 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question2" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"行走"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题3：慢跑 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question3" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"慢跑"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题4：集合 -->
                    <div>
                        <h3 id="question4" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"集合"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 确认按钮 -->
            <div class="text-center">
                <button id="confirmButton" onclick="confirmAllSelections()" disabled class="px-8 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed">
                    <span id="confirmButtonText">确认并继续</span>
                </button>
                
                <!-- 时间提示 - 移动到确认按钮下方 -->
                <div id="timeWarning" class="timer-warning mt-4 mx-auto max-w-md hidden">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="timeWarningText">请仔细观察图片至少6秒后再进行选择</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 继续询问页面 -->
    <div id="continuePage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="continueTitle" class="text-2xl font-bold text-gray-800 mb-4">本组对比已完成</h2>
            <p id="continueMessage" class="text-gray-600 mb-8">您已完成了50组图片对比，感谢您的参与！<br>是否继续进行下一组对比？</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="continueNextGroup()" id="continueButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    继续下一组
                </button>
                <button onclick="finishSurvey()" id="finishButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    结束调研
                </button>
            </div>
        </div>
    </div>

    <!-- 感谢页面 -->
    <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="thankYouTitle" class="text-2xl font-bold text-gray-800 mb-4">感谢您的参与！</h2>
            <p id="thankYouMessage" class="text-gray-600 mb-8">您的数据已成功提交，感谢您为街景感知研究做出的贡献！</p>
            
            <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                重新开始
            </button>
        </div>
    </div>

    <!-- 管理员界面 -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">管理员面板</h2>
                    <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800">总参与人数</h3>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">总对比次数</h3>
                        <p id="totalComparisons" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h3 class="font-semibent text-purple-800">平均每人对比次数</h3>
                        <p id="avgGroups" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-6">
                    <button onclick="exportData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        导出对比数据表格
                    </button>
                    <button onclick="clearData()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        清空数据
                    </button>
                    <button onclick="refreshStats()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        刷新统计
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">最近的对比数据</h3>
                    <div id="comparisonData" class="overflow-auto max-h-96">
                        <!-- 对比数据将在这里显示 -->
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">用户详情</h3>
                    <div id="userDetails" class="overflow-auto max-h-64">
                        <!-- 用户详情将在这里显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // 配置和全局变量
        // ====================================================================
        const DEBUG_MODE = false; // 关闭调试模式
        let debugVisible = false;

        // 示例图片URL列表
        const DEMO_IMAGES = [
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff11158-a3d5-4e96-9c02-92dd8a42566a_5344.png'
        ];

        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { nickname: '', gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;
        let comparisonPairs = [];
        let currentComparisonIndex = 0;
        let currentGroupNumber = 1;
        let sessionId = generateSessionId();
        let preloadedImages = new Map(); // 存储预加载的图片
        
        // 时间控制变量
        let comparisonStartTime = null;
        let minimumViewTime = 6000; // 6秒最小观看时间
        let timeWarningShown = false;

        // ====================================================================
        // 数据存储管理
        // ====================================================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveUserSession() {
            const sessions = JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
            
            const sessionData = {
                sessionId: sessionId,
                userData: userData,
                groupsCompleted: currentGroupNumber,
                totalComparisons: comparisons.length,
                comparisons: comparisons,
                timestamp: new Date().toISOString(),
                language: currentLanguage
            };
            
            sessions.push(sessionData);
            localStorage.setItem('surveySessionsData', JSON.stringify(sessions));
            
            // 更新累计对比数据
            updateComparisonData(sessionData);
            
            debugLog(`💾 用户会话已保存: ${sessionId}, 完成组数: ${currentGroupNumber}`);
        }

        function updateComparisonData(sessionData) {
            let comparisonRecords = JSON.parse(localStorage.getItem('comparisonRecords') || '[]');
            
            // 为每个对比记录创建一行数据
            sessionData.comparisons.forEach(comparison => {
                const record = {
                    sessionId: sessionData.sessionId,
                    nickname: sessionData.userData.nickname,
                    gender: sessionData.userData.gender,
                    age: sessionData.userData.age,
                    isProfessional: sessionData.userData.isProfessional,
                    groupNumber: comparison.groupNumber,
                    comparisonIndex: comparison.comparisonIndex,
                    image1_url: comparison.imageA.url,
                    image2_url: comparison.imageB.url,
                    image1_name: comparison.imageA.name,
                    image2_name: comparison.imageB.name,
                    sitting: comparison.answers.sitting ? (comparison.answers.sitting.choice === 'A' ? 0 : 1) : null,
                    walking: comparison.answers.walking ? (comparison.answers.walking.choice === 'A' ? 0 : 1) : null,
                    jogging: comparison.answers.jogging ? (comparison.answers.jogging.choice === 'A' ? 0 : 1) : null,
                    gathering: comparison.answers.gathering ? (comparison.answers.gathering.choice === 'A' ? 0 : 1) : null,
                    viewTime: comparison.viewTime || 0,
                    timestamp: comparison.timestamp
                };
                comparisonRecords.push(record);
            });
            
            localStorage.setItem('comparisonRecords', JSON.stringify(comparisonRecords));
            debugLog(`📊 对比记录已更新，新增 ${sessionData.comparisons.length} 条记录`);
        }

        function getComparisonRecords() {
            return JSON.parse(localStorage.getItem('comparisonRecords') || '[]');
        }

        function getAllSessions() {
            return JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
        }

        // ====================================================================
        // 调试和诊断函数
        // ====================================================================
        function debugLog(message) {
            if (DEBUG_MODE) {
                console.log(message);
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<div>' + message + '</div>';
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            debugVisible = !debugVisible;
            panel.style.display = debugVisible ? 'block' : 'none';
        }

        // ====================================================================
        // 时间控制函数
        // ====================================================================
        function startComparisonTimer() {
            comparisonStartTime = Date.now();
            timeWarningShown = false;
            hideTimeWarning();
        }

        function checkMinimumViewTime() {
            if (!comparisonStartTime) return true;
            
            const elapsed = Date.now() - comparisonStartTime;
            return elapsed >= minimumViewTime;
        }

        function showTimeWarning() {
            const warning = document.getElementById('timeWarning');
            const warningText = document.getElementById('timeWarningText');
            
            if (currentLanguage === 'zh') {
                warningText.textContent = '请仔细观察图片至少6秒后再进行选择';
            } else {
                warningText.textContent = 'Please observe the images carefully for at least 6 seconds before making a selection';
            }
            
            warning.classList.remove('hidden');
            timeWarningShown = true;
            
            // 3秒后自动隐藏警告
            setTimeout(() => {
                hideTimeWarning();
            }, 3000);
        }

        function hideTimeWarning() {
            document.getElementById('timeWarning').classList.add('hidden');
        }

        // ====================================================================
        // URL处理函数
        // ====================================================================
        function extractImageName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1];
            return filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        }

        function buildFallbackUrl(originalUrl) {
            const hash = hashCode(originalUrl);
            const id = Math.abs(hash) % 1000;
            return `https://picsum.photos/seed/${id}/666/500`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // 图片库初始化
        // ====================================================================
        async function initializeImageLibrary() {
            debugLog('🚀 初始化图片库...');
            
            let imageUrls = await loadImageUrlsFromFile();
            
            if (!imageUrls || imageUrls.length === 0) {
                debugLog('📁 文件加载失败，使用演示图片列表');
                imageUrls = DEMO_IMAGES;
            }
            
            imageLibrary = imageUrls.map((url, index) => ({
                id: index + 1,
                name: extractImageName(url),
                url: url.trim(),
                fallbackUrl: buildFallbackUrl(url)
            }));
            
            // 确保有足够的图片进行50组对比
            const minImagesNeeded = 50;
            
            if (imageLibrary.length < minImagesNeeded) {
                debugLog(`⚠️ 图片数量不足(${imageLibrary.length}张)，需要至少${minImagesNeeded}张`);
                // 重复图片库直到达到最少要求
                const originalLibrary = [...imageLibrary];
                while (imageLibrary.length < minImagesNeeded) {
                    imageLibrary.push(...originalLibrary);
                }
                // 截取到恰好50张
                imageLibrary = imageLibrary.slice(0, minImagesNeeded);
                debugLog(`✅ 已调整图片库到${imageLibrary.length}张图片`);
            } else {
                // 随机选择50张图片用于对比
                imageLibrary = imageLibrary.sort(() => 0.5 - Math.random()).slice(0, minImagesNeeded);
            }
            
            isImageLibraryLoaded = true;
            debugLog(`✅ 图片库初始化完成，共 ${imageLibrary.length} 张图片`);
        }

        async function loadImageUrlsFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('文件不存在');
                
                const text = await response.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'))
                    .filter(line => line.startsWith('http'));
                
                debugLog(`📋 从文件加载了 ${urls.length} 个图片URL`);
                return urls;
            } catch (error) {
                debugLog(`❌ 加载图片列表文件失败: ${error.message}`);
                return null;
            }
        }

        function loadImageWithFallback(imgElement, imageData, callback) {
            debugLog(`🖼️ 加载图片: ${imageData.name}`);
            
            // 检查是否已有预加载的图片
            const preloadedImageKey = `${imageData.id}_${imageData.url}`;
            if (preloadedImages.has(preloadedImageKey)) {
                const preloadedImg = preloadedImages.get(preloadedImageKey);
                if (preloadedImg.complete && preloadedImg.naturalHeight !== 0) {
                    debugLog(`✅ 使用预加载的图片: ${imageData.name}`);
                    imgElement.src = preloadedImg.src;
                    if (callback) callback(true);
                    return;
                }
            }
            
            imgElement.onload = function() {
                debugLog(`✅ 图片 ${imageData.name} 原始URL加载成功`);
                if (callback) callback(true);
            };
            
            imgElement.onerror = function() {
                debugLog(`❌ 图片 ${imageData.name} 原始URL加载失败，尝试备用图片`);
                
                imgElement.onload = function() {
                    debugLog(`✅ 图片 ${imageData.name} 通过备用源加载成功`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    debugLog(`❌ 图片 ${imageData.name} 所有源都无法加载`);
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aaguaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                };
                
                imgElement.src = imageData.fallbackUrl;
            };
            
            imgElement.src = imageData.url;
        }

        // 预加载图片函数
        function preloadImage(imageData) {
            return new Promise((resolve) => {
                const preloadedImageKey = `${imageData.id}_${imageData.url}`;
                
                // 如果已经预加载过，直接返回
                if (preloadedImages.has(preloadedImageKey)) {
                    resolve(preloadedImages.get(preloadedImageKey));
                    return;
                }
                
                const img = new Image();
                
                img.onload = function() {
                    debugLog(`🚀 预加载成功: ${imageData.name}`);
                    preloadedImages.set(preloadedImageKey, img);
                    resolve(img);
                };
                
                img.onerror = function() {
                    debugLog(`❌ 预加载原始URL失败，尝试备用URL: ${imageData.name}`);
                    
                    // 尝试备用URL
                    const fallbackImg = new Image();
                    fallbackImg.onload = function() {
                        debugLog(`🚀 预加载备用URL成功: ${imageData.name}`);
                        preloadedImages.set(preloadedImageKey, fallbackImg);
                        resolve(fallbackImg);
                    };
                    
                    fallbackImg.onerror = function() {
                        debugLog(`❌ 预加载所有URL都失败: ${imageData.name}`);
                        resolve(null);
                    };
                    
                    fallbackImg.src = imageData.fallbackUrl;
                };
                
                img.src = imageData.url;
            });
        }

        // 预加载下一对图片
        function preloadNextPair() {
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                debugLog(`🔄 开始预加载下一对图片 (${nextIndex + 1}/${comparisonPairs.length})`);
                
                // 同时预加载两张图片
                Promise.all([
                    preloadImage(nextPair.imageA),
                    preloadImage(nextPair.imageB)
                ]).then(() => {
                    debugLog(`✅ 下一对图片预加载完成`);
                }).catch((error) => {
                    debugLog(`❌ 预加载失败: ${error}`);
                });
            }
        }

        // 清理预加载缓存（避免内存占用过多）
        function cleanupPreloadCache() {
            // 只保留当前和下一对的预加载图片
            const keepKeys = new Set();
            
            if (currentComparisonIndex < comparisonPairs.length) {
                const currentPair = comparisonPairs[currentComparisonIndex];
                keepKeys.add(`${currentPair.imageA.id}_${currentPair.imageA.url}`);
                keepKeys.add(`${currentPair.imageB.id}_${currentPair.imageB.url}`);
            }
            
            if (currentComparisonIndex + 1 < comparisonPairs.length) {
                const nextPair = comparisonPairs[currentComparisonIndex + 1];
                keepKeys.add(`${nextPair.imageA.id}_${nextPair.imageA.url}`);
                keepKeys.add(`${nextPair.imageB.id}_${nextPair.imageB.url}`);
            }
            
            // 删除不需要的预加载图片
            for (const key of preloadedImages.keys()) {
                if (!keepKeys.has(key)) {
                    preloadedImages.delete(key);
                }
            }
        }

        // ====================================================================
        // 问卷逻辑
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: '街景感知问卷：第一部分',
                nicknameLabel: '您的昵称是：',
                nicknameHint: '用于兑换被试费用',
                genderLabel: '您的性别是：',
                maleLabel: '男',
                femaleLabel: '女',
                ageLabel: '您的年龄：',
                professionalLabel: '您来自城市规划/建筑/风景园林相关专业吗？',
                yesLabel: '是',
                noLabel: '否',
                consentTitle: '实验知情同意',
                consentAgree: '我已阅读并理解上述说明，同意参与本实验',
                nextButton: '下一部分',
                compareTitle: '以下两张街景中，您认为哪张更加适合"坐"的行为：',
                hintTitle: '提示',
                instructions: '在此调研中，您需要对每对图片回答四个不同的行为问题。请根据您的直觉选择您认为更加适合进行各种活动的街景。所有问题都必须回答完毕才能进入下一对图片。',
                continueTitle: '本组对比已完成',
                continueMessage: '您已完成了50组图片对比，感谢您的参与！<br>是否继续进行下一组对比？',
                continueButton: '继续下一组',
                finishButton: '结束调研',
                thankYouTitle: '感谢您的参与！',
                thankYouMessage: '您的数据已成功提交，感谢您为街景感知研究做出的贡献！',
                restartButton: '重新开始',
                // 图片和选项标签
                imageALabel: '图片 A',
                imageBLabel: '图片 B',
                optionA: '图片 A',
                optionB: '图片 B',
                // 四个问题
                question1: '以下两张街景中，您认为哪张更加适合"坐"的行为：',
                question2: '以下两张街景中，您认为哪张更加适合"行走"的行为：',
                question3: '以下两张街景中，您认为哪张更加适合"慢跑"的行为：',
                question4: '以下两张街景中，您认为哪张更加适合"集合"的行为：',
                confirmButtonText: '确认并继续',
                timeWarningText: '请仔细观察图片至少6秒后再进行选择'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                nicknameLabel: 'Your nickname is:',
                nicknameHint: 'For reimbursement purposes',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                consentTitle: 'Informed Consent',
                consentAgree: 'I have read and understood the above information and agree to participate in this experiment',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to answer four different behavioral questions for each pair of images. Please choose the street view you think is more suitable for various activities based on your intuition. All questions must be answered before proceeding to the next pair of images.',
                continueTitle: 'Group Comparison Completed',
                continueMessage: 'You have completed 50 image comparisons, thank you for your participation!<br>Would you like to continue with the next group?',
                continueButton: 'Continue Next Group',
                finishButton: 'Finish Survey',
                thankYouTitle: 'Thank You for Your Participation!',
                thankYouMessage: 'Your data has been successfully submitted. Thank you for contributing to street view perception research!',
                restartButton: 'Start Over',
                // 图片和选项标签
                imageALabel: 'Image A',
                imageBLabel: 'Image B',
                optionA: 'Image A',
                optionB: 'Image B',
                // 四个问题
                question1: 'Which of the following two street views do you think is more suitable for "sitting":',
                question2: 'Which of the following two street views do you think is more suitable for "walking":',
                question3: 'Which of the following two street views do you think is more suitable for "jogging":',
                question4: 'Which of the following two street views do you think is more suitable for "gathering":',
                confirmButtonText: 'Confirm and Continue',
                timeWarningText: 'Please observe the images carefully for at least 6 seconds before making a selection'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            
            // 更新基础文本元素
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'continueMessage' || key === 'thankYouMessage') {
                        element.innerHTML = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            // 更新选项文字（使用类选择器）
            const optionAElements = document.querySelectorAll('.optionA');
            const optionBElements = document.querySelectorAll('.optionB');
            
            optionAElements.forEach(element => {
                element.textContent = t.optionA;
            });
            
            optionBElements.forEach(element => {
                element.textContent = t.optionB;
            });

            // 更新知情同意书内容
            if (currentLanguage === 'en') {
                document.getElementById('consentText').innerHTML = `
                    <p class="mb-3"><strong>Research Institution:</strong> Urban Morphology Studio (UMS), Urban Governance and Design Th'rust, Hong Kong University of Science and Technology (Guangzhou)</p>
                    <p class="mb-3"><strong>Research Purpose:</strong> This experiment aims to understand people's perception and preference for behavioral suitability in different street environments. Through systematic comparison of street view images, we seek to identify patterns in how individuals assess spatial affordances for various human activities, contributing to evidence-based urban design practices.</p>
                    <p class="mb-3"><strong>Experimental Process:</strong> During the experiment, we will record:</p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Your basic information (nickname, gender, age, professional background)</li>hrust
                        <li>Your choices regarding behavioral suitability of different street view images</li>
                        <li>Your response time and viewing duration</li>
                        <li>Timestamps of your participation</li>
                    </ul>
                    <p class="mb-3"><strong>Data Usage:</strong> All collected data will be used solely for scientific research related to urban design and spatial perception.</p>
                    <p class="mb-3"><strong>We commit to:</strong></p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Strict confidentiality of your personal information</li>
                        <li>Use of data for academic research purposes only</li>
                        <li>Publication of research results in anonymized form</li>
                        <li>Your right to withdraw from the experiment at any time</li>
                    </ul>
                    <p class="mb-3"><strong>Contact Information:</strong> If you have any questions, please contact the research team.</p>
                    <p class="font-semibold">Participation in this experiment indicates that you have fully understood the above content and voluntarily participate.</p>
                `;
            }
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'continuePage', 'thankYouPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');
            const consent = document.getElementById('consentCheckbox').checked;

            if (!nickname || !gender || !age || !professional || !consent) {
                alert(currentLanguage === 'zh' ? '请完整填写所有必填项并同意参与实验！' : 'Please fill in all required fields and agree to participate!');
                return;
            }

            userData = {
                nickname: nickname,
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (imageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? '图片库加载失败或图片数量不足！' : 'Image library failed to load or insufficient images!');
                return;
            }

            startNewGroup();
        }

        function startNewGroup() {
            // 清空预加载缓存
            preloadedImages.clear();
            
            generateComparisonPairs();
            currentComparisonIndex = 0;
            comparisons = []; // 重置当前组的对比记录
            generateNewComparison();
            showPage('comparisonPage');
            updateGroupCounter();
        }

        function updateGroupCounter() {
            const groupText = currentLanguage === 'zh' ? `第 ${currentGroupNumber} 组` : `Group ${currentGroupNumber}`;
            document.getElementById('groupCounter').textContent = groupText;
        }

        function generateComparisonPairs() {
            comparisonPairs = [];
            
            // 创建一个数组，每张图片的ID出现恰好2次
            let imagePool = [];
            imageLibrary.forEach(img => {
                imagePool.push(img.id);
                imagePool.push(img.id);
            });
            
            // 随机打乱图片池
            for (let i = imagePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imagePool[i], imagePool[j]] = [imagePool[j], imagePool[i]];
            }
            
            debugLog(`📊 图片池创建完成，共 ${imagePool.length} 个图片实例`);
            
            // 成对组合，确保每对不是同一张图片
            for (let i = 0; i < imagePool.length - 1; i += 2) {
                let imageAId = imagePool[i];
                let imageBId = imagePool[i + 1];
                
                // 如果是同一张图片，尝试与后面的图片交换
                if (imageAId === imageBId && i + 2 < imagePool.length) {
                    for (let k = i + 2; k < imagePool.length; k++) {
                        if (imagePool[k] !== imageAId) {
                            [imagePool[i + 1], imagePool[k]] = [imagePool[k], imagePool[i + 1]];
                            imageBId = imagePool[i + 1];
                            break;
                        }
                    }
                }
                
                // 如果仍然是同一张图片，跳过这一对
                if (imageAId !== imageBId) {
                    const imageA = imageLibrary.find(img => img.id === imageAId);
                    const imageB = imageLibrary.find(img => img.id === imageBId);
                    
                    if (imageA && imageB) {
                        comparisonPairs.push({ imageA, imageB });
                    }
                }
                
                // 确保不超过50组对比
                if (comparisonPairs.length >= 50) {
                    break;
                }
            }
            
            debugLog(`✅ 第${currentGroupNumber}组生成了 ${comparisonPairs.length} 组配对`);
        }

        function generateNewComparison() {
            if (currentComparisonIndex >= 50) {
                completeCurrentGroup();
                return;
            }
            
            currentPair = comparisonPairs[currentComparisonIndex];

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            // 加载当前图片
            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            // 开始预加载下一对图片
            preloadNextPair();

            document.getElementById('progressCounter').textContent = `${currentComparisonIndex + 1}/50`;
            
            resetAllSelections();
            
            // 启动计时器
            startComparisonTimer();
        }

        function resetAllSelections() {
            // 重置所有单选按钮
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
            });
            
            // 重置确认按钮
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function checkAllAnswered() {
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const allAnswered = radioGroups.every(group => {
                return document.querySelector(`input[name="${group}"]:checked`) !== null;
            });
            
            const confirmButton = document.getElementById('confirmButton');
            if (allAnswered) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                confirmButton.disabled = true;
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function confirmAllSelections() {
            // 检查最小观看时间
            if (!checkMinimumViewTime()) {
                showTimeWarning();
                return;
            }
            
            // 收集所有问题的答案
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const behaviors = ['坐', '行走', '慢跑', '集合'];
            const answers = {};
            
            let allAnswered = true;
            radioGroups.forEach((group, index) => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    answers[group] = {
                        behavior: behaviors[index],
                        choice: selected.value,
                        winner: selected.value === 'A' ? currentPair.imageA.id : currentPair.imageB.id,
                        loser: selected.value === 'A' ? currentPair.imageB.id : currentPair.imageA.id,
                        winnerImage: selected.value === 'A' ? currentPair.imageA.name : currentPair.imageB.name,
                        loserImage: selected.value === 'A' ? currentPair.imageB.name : currentPair.imageA.name
                    };
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert(currentLanguage === 'zh' ? '请回答所有问题！' : 'Please answer all questions!');
                return;
            }

            // 记录对比结果
            comparisons.push({
                imageA: currentPair.imageA,
                imageB: currentPair.imageB,
                answers: answers,
                timestamp: new Date().toISOString(),
                groupNumber: currentGroupNumber,
                comparisonIndex: currentComparisonIndex + 1,
                viewTime: Date.now() - comparisonStartTime // 记录观看时间
            });

            currentComparisonIndex++;
            
            // 清理预加载缓存，避免内存占用过多
            cleanupPreloadCache();
            
            generateNewComparison();
        }

        function completeCurrentGroup() {
            debugLog(`✅ 第${currentGroupNumber}组对比完成，共${comparisons.length}次对比`);
            
            // 保存当前组数据
            saveUserSession();
            
            // 显示继续询问页面
            showPage('continuePage');
        }

        function continueNextGroup() {
            currentGroupNumber++;
            startNewGroup();
        }

        function finishSurvey() {
            showPage('thankYouPage');
        }

        function restart() {
            userData = { nickname: '', gender: '', age: '', isProfessional: '' };
            comparisons = [];
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            comparisonPairs = [];
            currentComparisonIndex = 0;
            currentGroupNumber = 1;
            sessionId = generateSessionId();
            preloadedImages.clear(); // 清空预加载缓存
            comparisonStartTime = null; // 重置时间
            timeWarningShown = false;
            
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('nicknameInput').value = '';
            document.getElementById('ageInput').value = '';
            document.getElementById('consentCheckbox').checked = false;
            
            showPage('languagePage');
        }

        // ====================================================================
        // 管理员界面
        // ====================================================================
        const ADMIN_PASSWORD = 'UMS2025ygs';
        
        function showAdminPanel() {
            // 密码验证
            const password = prompt('请输入管理员密码：');
            
            if (password === null) {
                return;
            }
            
            if (password !== ADMIN_PASSWORD) {
                alert('密码错误！');
                return;
            }
            
            // 密码正确，显示管理员界面
            refreshStats();
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function refreshStats() {
            const sessions = getAllSessions();
            const comparisonRecords = getComparisonRecords();
            
            // 更新基本统计
            document.getElementById('totalUsers').textContent = sessions.length;
            document.getElementById('totalComparisons').textContent = comparisonRecords.length;
            
            const avgComparisonsPerUser = sessions.length > 0 ? (comparisonRecords.length / sessions.length).toFixed(1) : '0';
            document.getElementById('avgGroups').textContent = avgComparisonsPerUser;
            
            // 显示对比数据
            displayComparisonData(comparisonRecords);
            
            // 更新用户详情
            displayUserDetails(sessions);
        }

        function displayComparisonData(records) {
            const comparisonData = document.getElementById('comparisonData');
            
            if (records.length === 0) {
                comparisonData.innerHTML = '<p class="text-gray-500">暂无对比数据</p>';
                return;
            }
            
            // 显示最近的20条记录
            const recentRecords = records.slice(-20).reverse();
            
            const html = `
                <div class="space-y-2">
                    <h4 class="font-semibold text-gray-800 mb-3">最近20条对比记录</h4>
                    <div class="grid grid-cols-10 gap-1 text-xs font-semibold text-gray-700 border-b pb-2">
                        <div>昵称</div>
                        <div>组序</div>
                        <div>图片1</div>
                        <div>图片2</div>
                        <div>坐</div>
                        <div>行走</div>
                        <div>慢跑</div>
                        <div>集合</div>
                        <div>时长(s)</div>
                        <div>时间</div>
                    </div>
                    ${recentRecords.map(record => `
                        <div class="grid grid-cols-10 gap-1 text-xs">
                            <div class="truncate" title="${record.nickname}">${record.nickname}</div>
                            <div>${record.groupNumber}-${record.comparisonIndex}</div>
                            <div class="truncate" title="${record.image1_name}">${record.image1_name.substring(0, 8)}...</div>
                            <div class="truncate" title="${record.image2_name}">${record.image2_name.substring(0, 8)}...</div>
                            <div class="text-center ${record.sitting === 0 ? 'text-green-600' : 'text-blue-600'}">${record.sitting}</div>
                            <div class="text-center ${record.walking === 0 ? 'text-green-600' : 'text-blue-600'}">${record.walking}</div>
                            <div class="text-center ${record.jogging === 0 ? 'text-green-600' : 'text-blue-600'}">${record.jogging}</div>
                            <div class="text-center ${record.gathering === 0 ? 'text-green-600' : 'text-blue-600'}">${record.gathering}</div>
                            <div>${(record.viewTime / 1000).toFixed(1)}</div>
                            <div>${new Date(record.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p><span class="text-green-600">0</span> = 选择图片1，<span class="text-blue-600">1</span> = 选择图片2</p>
                </div>
            `;
            
            comparisonData.innerHTML = html;
        }

        function displayUserDetails(sessions) {
            const userDetails = document.getElementById('userDetails');
            
            if (sessions.length === 0) {
                userDetails.innerHTML = '<p class="text-gray-500">暂无用户数据</p>';
                return;
            }
            
            const html = `
                <div class="space-y-2">
                    <div class="grid grid-cols-6 gap-2 text-sm font-semibold text-gray-700 border-b pb-2">
                        <div>昵称</div>
                        <div>性别</div>
                        <div>年龄</div>
                        <div>专业</div>
                        <div>完成组数</div>
                        <div>时间</div>
                    </div>
                    ${sessions.slice(-20).map(session => `
                        <div class="grid grid-cols-6 gap-2 text-sm">
                            <div class="truncate">${session.userData.nickname}</div>
                            <div>${session.userData.gender === 'male' ? '男' : '女'}</div>
                            <div>${session.userData.age}</div>
                            <div>${session.userData.isProfessional === 'yes' ? '是' : '否'}</div>
                            <div>${session.groupsCompleted}</div>
                            <div>${new Date(session.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            userDetails.innerHTML = html;
        }

        function exportData() {
            const comparisonRecords = getComparisonRecords();
            
            if (comparisonRecords.length === 0) {
                alert('暂无数据可导出！');
                return;
            }
            
            // 创建CSV内容
            const headers = [
                'sessionId', 'nickname', 'gender', 'age', 'isProfessional',
                'groupNumber', 'comparisonIndex', 'image1_url', 'image2_url',
                'image1_name', 'image2_name', 'sitting', 'walking', 'jogging', 'gathering',
                'viewTime_ms', 'timestamp'
            ];
            
            const csvContent = [
                headers.join(','),
                ...comparisonRecords.map(record => [
                    record.sessionId,
                    `"${record.nickname}"`,
                    record.gender,
                    record.age,
                    record.isProfessional,
                    record.groupNumber,
                    record.comparisonIndex,
                    `"${record.image1_url}"`,
                    `"${record.image2_url}"`,
                    `"${record.image1_name}"`,
                    `"${record.image2_name}"`,
                    record.sitting,
                    record.walking,
                    record.jogging,
                    record.gathering,
                    record.viewTime,
                    record.timestamp
                ].join(','))
            ].join('\n');
            
            // 下载CSV文件
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `街景问卷对比数据_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('数据已导出为CSV格式！');
        }

        function clearData() {
            if (confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                localStorage.removeItem('surveySessionsData');
                localStorage.removeItem('comparisonRecords');
                refreshStats();
                alert('数据已清空！');
            }
        }

        // ====================================================================
        // 页面初始化
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('🚀 街景问卷系统启动 - 改进版');
            
            await initializeImageLibrary();
            
            // 添加事件监听器到所有单选按钮
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', checkAllAnswered);
                });
            });
            
            if (isImageLibraryLoaded) {
                debugLog(`✅ 系统就绪，图片库包含 ${imageLibrary.length} 张图片`);
            } else {
                debugLog('⚠️ 图片库初始化有问题，但系统仍可运行');
            }
        });
    </script>
</body>
</html>

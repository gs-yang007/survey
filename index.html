<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—æ™¯è¡Œä¸ºé—®å·è°ƒç ”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .image-container {
            width: 666px;
            height: 500px;
        }
        .survey-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
        .timer-warning {
            background-color: #fef3c7;
            color: #d97706;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .consent-text {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ç®¡ç†å‘˜å…¥å£ -->
    <div class="admin-panel">
        <button onclick="showAdminPanel()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
            ç®¡ç†å‘˜
        </button>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debugPanel" class="debug-panel">
        <div>ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
        <div id="debugLog"></div>
        <button onclick="toggleDebug()" style="background: #333; color: #fff; border: none; padding: 2px 5px; margin-top: 5px;">éšè—</button>
    </div>

    <!-- è¯­è¨€é€‰æ‹©é¡µé¢ -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è¡—æ™¯è¡Œä¸ºæ„ŸçŸ¥é—®å·</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">è¯­è¨€é€‰æ‹©</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ä¸­æ–‡
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯æ”¶é›†é¡µé¢ -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-3xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">çª—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="space-y-6">
                    <!-- æ˜µç§°è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="nicknameLabel">æ‚¨çš„æ˜µç§°æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nicknameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="">
                        <p id="nicknameHint" class="text-sm text-gray-500 mt-1">ç”¨äºå…‘æ¢è¢«è¯•è´¹ç”¨</p>
                    </div>

                    <!-- æ€§åˆ«é€‰æ‹© -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">æ‚¨çš„æ€§åˆ«æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">ç”·</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">å¥³</span>
                            </label>
                        </div>
                    </div>

                    <!-- å¹´é¾„è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">æ‚¨çš„å¹´é¾„ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- ä¸“ä¸šèƒŒæ™¯ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">æ˜¯</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">å¦</span>
                            </label>
                        </div>
                    </div>

                    <!-- çŸ¥æƒ…åŒæ„ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="consentTitle">å®éªŒçŸ¥æƒ…åŒæ„</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="consent-text">
                            <div id="consentText">
                                <p class="mb-3"><strong>å®éªŒä¸»ä½“ï¼š</strong>é¦™æ¸¯ç§‘æŠ€å¤§å­¦ï¼ˆå¹¿å·ï¼‰åŸå¸‚æ²»ç†ä¸è®¾è®¡å­¦åŸŸUrban Morphology Studio (UMS)</p>
                                <p class="mb-3"><strong>å®éªŒç›®çš„ï¼š</strong>æœ¬å®éªŒæ—¨åœ¨äº†è§£äººä»¬å¯¹ä¸åŒè¡—æ™¯ç¯å¢ƒä¸­è¡Œä¸ºé€‚å®œæ€§çš„æ„ŸçŸ¥å’Œåå¥½ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„è¡—æ™¯å›¾ç‰‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å¸Œæœ›è¯†åˆ«ä¸ªä½“å¦‚ä½•è¯„ä¼°ç©ºé—´å¯¹å„ç§äººç±»æ´»åŠ¨çš„æ”¯æŒæ€§ï¼Œä»è€Œä¸ºå¾ªè¯åŸå¸‚è®¾è®¡å®è·µåšå‡ºè´¡çŒ®ã€‚</p>
                                <p class="mb-3"><strong>å®éªŒè¿‡ç¨‹ï¼š</strong>åœ¨å®éªŒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†è®°å½•ï¼š</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>æ‚¨çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€å¹´é¾„ã€ä¸“ä¸šèƒŒæ™¯ï¼‰</li>
                                    <li>æ‚¨å¯¹ä¸åŒè¡—æ™¯å›¾ç‰‡çš„è¡Œä¸ºé€‚å®œæ€§é€‰æ‹©</li>
                                    <li>æ‚¨çš„é€‰æ‹©æ—¶é—´å’Œæµè§ˆæ—¶é•¿</li>
                                    <li>å‚ä¸å®éªŒçš„æ—¶é—´æˆ³</li>
                                </ul>
                                <p class="mb-3"><strong>æ•°æ®ä½¿ç”¨ï¼š</strong>æ”¶é›†çš„æ‰€æœ‰æ•°æ®å°†ä»…ç”¨äºåŸå¸‚è®¾è®¡å’Œç©ºé—´æ„ŸçŸ¥ç›¸å…³çš„ç§‘å­¦ç ”ç©¶ã€‚æˆ‘ä»¬æ‰¿è¯ºï¼š</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>æ‚¨çš„ä¸ªäººä¿¡æ¯å°†è¢«ä¸¥æ ¼ä¿å¯†</li>
                                    <li>æ•°æ®ä»…ç”¨äºå­¦æœ¯ç ”ç©¶ç›®çš„</li>
                                    <li>ç ”ç©¶ç»“æœå°†ä»¥åŒ¿ååŒ–çš„å½¢å¼å‘è¡¨</li>
                                    <li>æ‚¨æœ‰æƒåœ¨ä»»ä½•æ—¶å€™é€€å‡ºå®éªŒ</li>
                                </ul>
                                <p class="mb-3"><strong>è”ç³»æ–¹å¼ï¼š</strong>å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·è”ç³»ç ”ç©¶å›¢é˜Ÿã€‚</p>
                                <p class="font-semibold">å‚ä¸æœ¬å®éªŒå³è¡¨ç¤ºæ‚¨å·²å……åˆ†äº†è§£ä¸Šè¿°å†…å®¹å¹¶è‡ªæ„¿å‚åŠ ã€‚</p>
                            </div>
                        </div>
                        <label class="flex items-start mt-3">
                            <input type="checkbox" id="consentCheckbox" class="mt-1 mr-3">
                            <span id="consentAgree">æˆ‘å·²é˜…è¯»å¹¶ç†è§£ä¸Šè¿°è¯´æ˜ï¼ŒåŒæ„å‚ä¸æœ¬å®éªŒ</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        ä¸‹ä¸€éƒ¨åˆ†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å¯¹æ¯”é¡µé¢ -->
    <div id="comparisonPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between text-gray-800 mb-4">
                <div>
                    <span id="groupCounter">ç¬¬ 1 ç»„</span>
                </div>
                <div>
                    <span id="progressCounter">1/50</span>
                </div>
            </div>
            
            <!-- é¡¶éƒ¨æç¤º -->
            <div class="bg-white rounded-lg p-4 mb-6">
                <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">æç¤º</h3>
                <p id="instructions" class="text-sm text-gray-600">
                    åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚
                </p>
            </div>
            
            <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <div class="flex justify-center mb-6 space-x-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageALabel" class="font-bold text-gray-800">å›¾ç‰‡ A</span>
                    </div>
                    <div class="image-container">
                        <img id="imageA_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageBLabel" class="font-bold text-gray-800">å›¾ç‰‡ B</span>
                    </div>
                    <div class="image-container">
                        <img id="imageB_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
            </div>
            
            <!-- é—®é¢˜åŒºåŸŸ -->
            <div class="bg-white rounded-lg p-6 mb-6">
                <div class="space-y-6">
                    <!-- é—®é¢˜1ï¼šå -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question1" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜2ï¼šè¡Œèµ° -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question2" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"è¡Œèµ°"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜3ï¼šæ…¢è·‘ -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question3" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜4ï¼šé›†åˆ -->
                    <div>
                        <h3 id="question4" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"é›†åˆ"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¡®è®¤æŒ‰é’® -->
            <div class="text-center">
                <button id="confirmButton" onclick="confirmAllSelections()" disabled class="px-8 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed">
                    <span id="confirmButtonText">ç¡®è®¤å¹¶ç»§ç»­</span>
                </button>
                
                <!-- æ—¶é—´æç¤º - ç§»åŠ¨åˆ°ç¡®è®¤æŒ‰é’®ä¸‹æ–¹ -->
                <div id="timeWarning" class="timer-warning mt-4 mx-auto max-w-md hidden">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="timeWarningText">è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»§ç»­è¯¢é—®é¡µé¢ -->
    <div id="continuePage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="continueTitle" class="text-2xl font-bold text-gray-800 mb-4">æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ</h2>
            <p id="continueMessage" class="text-gray-600 mb-8">æ‚¨å·²å®Œæˆäº†50ç»„å›¾ç‰‡å¯¹æ¯”ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼<br>æ˜¯å¦ç»§ç»­è¿›è¡Œä¸‹ä¸€ç»„å¯¹æ¯”ï¼Ÿ</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="continueNextGroup()" id="continueButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ç»§ç»­ä¸‹ä¸€ç»„
                </button>
                <button onclick="finishSurvey()" id="finishButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    ç»“æŸè°ƒç ”
                </button>
            </div>
        </div>
    </div>

    <!-- æ„Ÿè°¢é¡µé¢ -->
    <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="thankYouTitle" class="text-2xl font-bold text-gray-800 mb-4">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</h2>
            <p id="thankYouMessage" class="text-gray-600 mb-8">æ‚¨çš„æ•°æ®å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼</p>
            
            <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                é‡æ–°å¼€å§‹
            </button>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ç®¡ç†å‘˜é¢æ¿</h2>
                    <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800">æ€»å‚ä¸äººæ•°</h3>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">æ€»å¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="totalComparisons" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h3 class="font-semibent text-purple-800">å¹³å‡æ¯äººå¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="avgGroups" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-6">
                    <button onclick="exportData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        å¯¼å‡ºå¯¹æ¯”æ•°æ®è¡¨æ ¼
                    </button>
                    <button onclick="clearData()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        æ¸…ç©ºæ•°æ®
                    </button>
                    <button onclick="refreshStats()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">æœ€è¿‘çš„å¯¹æ¯”æ•°æ®</h3>
                    <div id="comparisonData" class="overflow-auto max-h-96">
                        <!-- å¯¹æ¯”æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">ç”¨æˆ·è¯¦æƒ…</h3>
                    <div id="userDetails" class="overflow-auto max-h-64">
                        <!-- ç”¨æˆ·è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // é…ç½®å’Œå…¨å±€å˜é‡
        // ====================================================================
        const DEBUG_MODE = false; // å…³é—­è°ƒè¯•æ¨¡å¼
        let debugVisible = false;

        // ç¤ºä¾‹å›¾ç‰‡URLåˆ—è¡¨
        const DEMO_IMAGES = [
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff11158-a3d5-4e96-9c02-92dd8a42566a_5344.png'
        ];

        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { nickname: '', gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;
        let comparisonPairs = [];
        let currentComparisonIndex = 0;
        let currentGroupNumber = 1;
        let sessionId = generateSessionId();
        let preloadedImages = new Map(); // å­˜å‚¨é¢„åŠ è½½çš„å›¾ç‰‡
        
        // æ—¶é—´æ§åˆ¶å˜é‡
        let comparisonStartTime = null;
        let minimumViewTime = 6000; // 6ç§’æœ€å°è§‚çœ‹æ—¶é—´
        let timeWarningShown = false;

        // ====================================================================
        // æ•°æ®å­˜å‚¨ç®¡ç†
        // ====================================================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveUserSession() {
            const sessions = JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
            
            const sessionData = {
                sessionId: sessionId,
                userData: userData,
                groupsCompleted: currentGroupNumber,
                totalComparisons: comparisons.length,
                comparisons: comparisons,
                timestamp: new Date().toISOString(),
                language: currentLanguage
            };
            
            sessions.push(sessionData);
            localStorage.setItem('surveySessionsData', JSON.stringify(sessions));
            
            // æ›´æ–°ç´¯è®¡å¯¹æ¯”æ•°æ®
            updateComparisonData(sessionData);
            
            debugLog(`ğŸ’¾ ç”¨æˆ·ä¼šè¯å·²ä¿å­˜: ${sessionId}, å®Œæˆç»„æ•°: ${currentGroupNumber}`);
        }

        function updateComparisonData(sessionData) {
            let comparisonRecords = JSON.parse(localStorage.getItem('comparisonRecords') || '[]');
            
            // ä¸ºæ¯ä¸ªå¯¹æ¯”è®°å½•åˆ›å»ºä¸€è¡Œæ•°æ®
            sessionData.comparisons.forEach(comparison => {
                const record = {
                    sessionId: sessionData.sessionId,
                    nickname: sessionData.userData.nickname,
                    gender: sessionData.userData.gender,
                    age: sessionData.userData.age,
                    isProfessional: sessionData.userData.isProfessional,
                    groupNumber: comparison.groupNumber,
                    comparisonIndex: comparison.comparisonIndex,
                    image1_url: comparison.imageA.url,
                    image2_url: comparison.imageB.url,
                    image1_name: comparison.imageA.name,
                    image2_name: comparison.imageB.name,
                    sitting: comparison.answers.sitting ? (comparison.answers.sitting.choice === 'A' ? 0 : 1) : null,
                    walking: comparison.answers.walking ? (comparison.answers.walking.choice === 'A' ? 0 : 1) : null,
                    jogging: comparison.answers.jogging ? (comparison.answers.jogging.choice === 'A' ? 0 : 1) : null,
                    gathering: comparison.answers.gathering ? (comparison.answers.gathering.choice === 'A' ? 0 : 1) : null,
                    viewTime: comparison.viewTime || 0,
                    timestamp: comparison.timestamp
                };
                comparisonRecords.push(record);
            });
            
            localStorage.setItem('comparisonRecords', JSON.stringify(comparisonRecords));
            debugLog(`ğŸ“Š å¯¹æ¯”è®°å½•å·²æ›´æ–°ï¼Œæ–°å¢ ${sessionData.comparisons.length} æ¡è®°å½•`);
        }

        function getComparisonRecords() {
            return JSON.parse(localStorage.getItem('comparisonRecords') || '[]');
        }

        function getAllSessions() {
            return JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
        }

        // ====================================================================
        // è°ƒè¯•å’Œè¯Šæ–­å‡½æ•°
        // ====================================================================
        function debugLog(message) {
            if (DEBUG_MODE) {
                console.log(message);
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<div>' + message + '</div>';
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            debugVisible = !debugVisible;
            panel.style.display = debugVisible ? 'block' : 'none';
        }

        // ====================================================================
        // æ—¶é—´æ§åˆ¶å‡½æ•°
        // ====================================================================
        function startComparisonTimer() {
            comparisonStartTime = Date.now();
            timeWarningShown = false;
            hideTimeWarning();
        }

        function checkMinimumViewTime() {
            if (!comparisonStartTime) return true;
            
            const elapsed = Date.now() - comparisonStartTime;
            return elapsed >= minimumViewTime;
        }

        function showTimeWarning() {
            const warning = document.getElementById('timeWarning');
            const warningText = document.getElementById('timeWarningText');
            
            if (currentLanguage === 'zh') {
                warningText.textContent = 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©';
            } else {
                warningText.textContent = 'Please observe the images carefully for at least 6 seconds before making a selection';
            }
            
            warning.classList.remove('hidden');
            timeWarningShown = true;
            
            // 3ç§’åè‡ªåŠ¨éšè—è­¦å‘Š
            setTimeout(() => {
                hideTimeWarning();
            }, 3000);
        }

        function hideTimeWarning() {
            document.getElementById('timeWarning').classList.add('hidden');
        }

        // ====================================================================
        // URLå¤„ç†å‡½æ•°
        // ====================================================================
        function extractImageName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1];
            return filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        }

        function buildFallbackUrl(originalUrl) {
            const hash = hashCode(originalUrl);
            const id = Math.abs(hash) % 1000;
            return `https://picsum.photos/seed/${id}/666/500`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // å›¾ç‰‡åº“åˆå§‹åŒ–
        // ====================================================================
        async function initializeImageLibrary() {
            debugLog('ğŸš€ åˆå§‹åŒ–å›¾ç‰‡åº“...');
            
            let imageUrls = await loadImageUrlsFromFile();
            
            if (!imageUrls || imageUrls.length === 0) {
                debugLog('ğŸ“ æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºå›¾ç‰‡åˆ—è¡¨');
                imageUrls = DEMO_IMAGES;
            }
            
            imageLibrary = imageUrls.map((url, index) => ({
                id: index + 1,
                name: extractImageName(url),
                url: url.trim(),
                fallbackUrl: buildFallbackUrl(url)
            }));
            
            // ç¡®ä¿æœ‰è¶³å¤Ÿçš„å›¾ç‰‡è¿›è¡Œ50ç»„å¯¹æ¯”
            const minImagesNeeded = 50;
            
            if (imageLibrary.length < minImagesNeeded) {
                debugLog(`âš ï¸ å›¾ç‰‡æ•°é‡ä¸è¶³(${imageLibrary.length}å¼ )ï¼Œéœ€è¦è‡³å°‘${minImagesNeeded}å¼ `);
                // é‡å¤å›¾ç‰‡åº“ç›´åˆ°è¾¾åˆ°æœ€å°‘è¦æ±‚
                const originalLibrary = [...imageLibrary];
                while (imageLibrary.length < minImagesNeeded) {
                    imageLibrary.push(...originalLibrary);
                }
                // æˆªå–åˆ°æ°å¥½50å¼ 
                imageLibrary = imageLibrary.slice(0, minImagesNeeded);
                debugLog(`âœ… å·²è°ƒæ•´å›¾ç‰‡åº“åˆ°${imageLibrary.length}å¼ å›¾ç‰‡`);
            } else {
                // éšæœºé€‰æ‹©50å¼ å›¾ç‰‡ç”¨äºå¯¹æ¯”
                imageLibrary = imageLibrary.sort(() => 0.5 - Math.random()).slice(0, minImagesNeeded);
            }
            
            isImageLibraryLoaded = true;
            debugLog(`âœ… å›¾ç‰‡åº“åˆå§‹åŒ–å®Œæˆï¼Œå…± ${imageLibrary.length} å¼ å›¾ç‰‡`);
        }

        async function loadImageUrlsFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
                
                const text = await response.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'))
                    .filter(line => line.startsWith('http'));
                
                debugLog(`ğŸ“‹ ä»æ–‡ä»¶åŠ è½½äº† ${urls.length} ä¸ªå›¾ç‰‡URL`);
                return urls;
            } catch (error) {
                debugLog(`âŒ åŠ è½½å›¾ç‰‡åˆ—è¡¨æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return null;
            }
        }

        function loadImageWithFallback(imgElement, imageData, callback) {
            debugLog(`ğŸ–¼ï¸ åŠ è½½å›¾ç‰‡: ${imageData.name}`);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é¢„åŠ è½½çš„å›¾ç‰‡
            const preloadedImageKey = `${imageData.id}_${imageData.url}`;
            if (preloadedImages.has(preloadedImageKey)) {
                const preloadedImg = preloadedImages.get(preloadedImageKey);
                if (preloadedImg.complete && preloadedImg.naturalHeight !== 0) {
                    debugLog(`âœ… ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡: ${imageData.name}`);
                    imgElement.src = preloadedImg.src;
                    if (callback) callback(true);
                    return;
                }
            }
            
            imgElement.onload = function() {
                debugLog(`âœ… å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½æˆåŠŸ`);
                if (callback) callback(true);
            };
            
            imgElement.onerror = function() {
                debugLog(`âŒ å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨å›¾ç‰‡`);
                
                imgElement.onload = function() {
                    debugLog(`âœ… å›¾ç‰‡ ${imageData.name} é€šè¿‡å¤‡ç”¨æºåŠ è½½æˆåŠŸ`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    debugLog(`âŒ å›¾ç‰‡ ${imageData.name} æ‰€æœ‰æºéƒ½æ— æ³•åŠ è½½`);
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aaguaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                };
                
                imgElement.src = imageData.fallbackUrl;
            };
            
            imgElement.src = imageData.url;
        }

        // é¢„åŠ è½½å›¾ç‰‡å‡½æ•°
        function preloadImage(imageData) {
            return new Promise((resolve) => {
                const preloadedImageKey = `${imageData.id}_${imageData.url}`;
                
                // å¦‚æœå·²ç»é¢„åŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
                if (preloadedImages.has(preloadedImageKey)) {
                    resolve(preloadedImages.get(preloadedImageKey));
                    return;
                }
                
                const img = new Image();
                
                img.onload = function() {
                    debugLog(`ğŸš€ é¢„åŠ è½½æˆåŠŸ: ${imageData.name}`);
                    preloadedImages.set(preloadedImageKey, img);
                    resolve(img);
                };
                
                img.onerror = function() {
                    debugLog(`âŒ é¢„åŠ è½½åŸå§‹URLå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL: ${imageData.name}`);
                    
                    // å°è¯•å¤‡ç”¨URL
                    const fallbackImg = new Image();
                    fallbackImg.onload = function() {
                        debugLog(`ğŸš€ é¢„åŠ è½½å¤‡ç”¨URLæˆåŠŸ: ${imageData.name}`);
                        preloadedImages.set(preloadedImageKey, fallbackImg);
                        resolve(fallbackImg);
                    };
                    
                    fallbackImg.onerror = function() {
                        debugLog(`âŒ é¢„åŠ è½½æ‰€æœ‰URLéƒ½å¤±è´¥: ${imageData.name}`);
                        resolve(null);
                    };
                    
                    fallbackImg.src = imageData.fallbackUrl;
                };
                
                img.src = imageData.url;
            });
        }

        // é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡
        function preloadNextPair() {
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                debugLog(`ğŸ”„ å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡ (${nextIndex + 1}/${comparisonPairs.length})`);
                
                // åŒæ—¶é¢„åŠ è½½ä¸¤å¼ å›¾ç‰‡
                Promise.all([
                    preloadImage(nextPair.imageA),
                    preloadImage(nextPair.imageB)
                ]).then(() => {
                    debugLog(`âœ… ä¸‹ä¸€å¯¹å›¾ç‰‡é¢„åŠ è½½å®Œæˆ`);
                }).catch((error) => {
                    debugLog(`âŒ é¢„åŠ è½½å¤±è´¥: ${error}`);
                });
            }
        }

        // æ¸…ç†é¢„åŠ è½½ç¼“å­˜ï¼ˆé¿å…å†…å­˜å ç”¨è¿‡å¤šï¼‰
        function cleanupPreloadCache() {
            // åªä¿ç•™å½“å‰å’Œä¸‹ä¸€å¯¹çš„é¢„åŠ è½½å›¾ç‰‡
            const keepKeys = new Set();
            
            if (currentComparisonIndex < comparisonPairs.length) {
                const currentPair = comparisonPairs[currentComparisonIndex];
                keepKeys.add(`${currentPair.imageA.id}_${currentPair.imageA.url}`);
                keepKeys.add(`${currentPair.imageB.id}_${currentPair.imageB.url}`);
            }
            
            if (currentComparisonIndex + 1 < comparisonPairs.length) {
                const nextPair = comparisonPairs[currentComparisonIndex + 1];
                keepKeys.add(`${nextPair.imageA.id}_${nextPair.imageA.url}`);
                keepKeys.add(`${nextPair.imageB.id}_${nextPair.imageB.url}`);
            }
            
            // åˆ é™¤ä¸éœ€è¦çš„é¢„åŠ è½½å›¾ç‰‡
            for (const key of preloadedImages.keys()) {
                if (!keepKeys.has(key)) {
                    preloadedImages.delete(key);
                }
            }
        }

        // ====================================================================
        // é—®å·é€»è¾‘
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: 'è¡—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†',
                nicknameLabel: 'æ‚¨çš„æ˜µç§°æ˜¯ï¼š',
                nicknameHint: 'ç”¨äºå…‘æ¢è¢«è¯•è´¹ç”¨',
                genderLabel: 'æ‚¨çš„æ€§åˆ«æ˜¯ï¼š',
                maleLabel: 'ç”·',
                femaleLabel: 'å¥³',
                ageLabel: 'æ‚¨çš„å¹´é¾„ï¼š',
                professionalLabel: 'æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ',
                yesLabel: 'æ˜¯',
                noLabel: 'å¦',
                consentTitle: 'å®éªŒçŸ¥æƒ…åŒæ„',
                consentAgree: 'æˆ‘å·²é˜…è¯»å¹¶ç†è§£ä¸Šè¿°è¯´æ˜ï¼ŒåŒæ„å‚ä¸æœ¬å®éªŒ',
                nextButton: 'ä¸‹ä¸€éƒ¨åˆ†',
                compareTitle: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š',
                hintTitle: 'æç¤º',
                instructions: 'åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚',
                continueTitle: 'æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ',
                continueMessage: 'æ‚¨å·²å®Œæˆäº†50ç»„å›¾ç‰‡å¯¹æ¯”ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼<br>æ˜¯å¦ç»§ç»­è¿›è¡Œä¸‹ä¸€ç»„å¯¹æ¯”ï¼Ÿ',
                continueButton: 'ç»§ç»­ä¸‹ä¸€ç»„',
                finishButton: 'ç»“æŸè°ƒç ”',
                thankYouTitle: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼',
                thankYouMessage: 'æ‚¨çš„æ•°æ®å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼',
                restartButton: 'é‡æ–°å¼€å§‹',
                // å›¾ç‰‡å’Œé€‰é¡¹æ ‡ç­¾
                imageALabel: 'å›¾ç‰‡ A',
                imageBLabel: 'å›¾ç‰‡ B',
                optionA: 'å›¾ç‰‡ A',
                optionB: 'å›¾ç‰‡ B',
                // å››ä¸ªé—®é¢˜
                question1: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š',
                question2: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"è¡Œèµ°"çš„è¡Œä¸ºï¼š',
                question3: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š',
                question4: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"é›†åˆ"çš„è¡Œä¸ºï¼š',
                confirmButtonText: 'ç¡®è®¤å¹¶ç»§ç»­',
                timeWarningText: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                nicknameLabel: 'Your nickname is:',
                nicknameHint: 'For reimbursement purposes',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                consentTitle: 'Informed Consent',
                consentAgree: 'I have read and understood the above information and agree to participate in this experiment',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to answer four different behavioral questions for each pair of images. Please choose the street view you think is more suitable for various activities based on your intuition. All questions must be answered before proceeding to the next pair of images.',
                continueTitle: 'Group Comparison Completed',
                continueMessage: 'You have completed 50 image comparisons, thank you for your participation!<br>Would you like to continue with the next group?',
                continueButton: 'Continue Next Group',
                finishButton: 'Finish Survey',
                thankYouTitle: 'Thank You for Your Participation!',
                thankYouMessage: 'Your data has been successfully submitted. Thank you for contributing to street view perception research!',
                restartButton: 'Start Over',
                // å›¾ç‰‡å’Œé€‰é¡¹æ ‡ç­¾
                imageALabel: 'Image A',
                imageBLabel: 'Image B',
                optionA: 'Image A',
                optionB: 'Image B',
                // å››ä¸ªé—®é¢˜
                question1: 'Which of the following two street views do you think is more suitable for "sitting":',
                question2: 'Which of the following two street views do you think is more suitable for "walking":',
                question3: 'Which of the following two street views do you think is more suitable for "jogging":',
                question4: 'Which of the following two street views do you think is more suitable for "gathering":',
                confirmButtonText: 'Confirm and Continue',
                timeWarningText: 'Please observe the images carefully for at least 6 seconds before making a selection'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            
            // æ›´æ–°åŸºç¡€æ–‡æœ¬å…ƒç´ 
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'continueMessage' || key === 'thankYouMessage') {
                        element.innerHTML = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            // æ›´æ–°é€‰é¡¹æ–‡å­—ï¼ˆä½¿ç”¨ç±»é€‰æ‹©å™¨ï¼‰
            const optionAElements = document.querySelectorAll('.optionA');
            const optionBElements = document.querySelectorAll('.optionB');
            
            optionAElements.forEach(element => {
                element.textContent = t.optionA;
            });
            
            optionBElements.forEach(element => {
                element.textContent = t.optionB;
            });

            // æ›´æ–°çŸ¥æƒ…åŒæ„ä¹¦å†…å®¹
            if (currentLanguage === 'en') {
                document.getElementById('consentText').innerHTML = `
                    <p class="mb-3"><strong>Research Institution:</strong> Urban Morphology Studio (UMS), Urban Governance and Design Th'rust, Hong Kong University of Science and Technology (Guangzhou)</p>
                    <p class="mb-3"><strong>Research Purpose:</strong> This experiment aims to understand people's perception and preference for behavioral suitability in different street environments. Through systematic comparison of street view images, we seek to identify patterns in how individuals assess spatial affordances for various human activities, contributing to evidence-based urban design practices.</p>
                    <p class="mb-3"><strong>Experimental Process:</strong> During the experiment, we will record:</p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Your basic information (nickname, gender, age, professional background)</li>hrust
                        <li>Your choices regarding behavioral suitability of different street view images</li>
                        <li>Your response time and viewing duration</li>
                        <li>Timestamps of your participation</li>
                    </ul>
                    <p class="mb-3"><strong>Data Usage:</strong> All collected data will be used solely for scientific research related to urban design and spatial perception.</p>
                    <p class="mb-3"><strong>We commit to:</strong></p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Strict confidentiality of your personal information</li>
                        <li>Use of data for academic research purposes only</li>
                        <li>Publication of research results in anonymized form</li>
                        <li>Your right to withdraw from the experiment at any time</li>
                    </ul>
                    <p class="mb-3"><strong>Contact Information:</strong> If you have any questions, please contact the research team.</p>
                    <p class="font-semibold">Participation in this experiment indicates that you have fully understood the above content and voluntarily participate.</p>
                `;
            }
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'continuePage', 'thankYouPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');
            const consent = document.getElementById('consentCheckbox').checked;

            if (!nickname || !gender || !age || !professional || !consent) {
                alert(currentLanguage === 'zh' ? 'è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹å¹¶åŒæ„å‚ä¸å®éªŒï¼' : 'Please fill in all required fields and agree to participate!');
                return;
            }

            userData = {
                nickname: nickname,
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (imageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? 'å›¾ç‰‡åº“åŠ è½½å¤±è´¥æˆ–å›¾ç‰‡æ•°é‡ä¸è¶³ï¼' : 'Image library failed to load or insufficient images!');
                return;
            }

            startNewGroup();
        }

        function startNewGroup() {
            // æ¸…ç©ºé¢„åŠ è½½ç¼“å­˜
            preloadedImages.clear();
            
            generateComparisonPairs();
            currentComparisonIndex = 0;
            comparisons = []; // é‡ç½®å½“å‰ç»„çš„å¯¹æ¯”è®°å½•
            generateNewComparison();
            showPage('comparisonPage');
            updateGroupCounter();
        }

        function updateGroupCounter() {
            const groupText = currentLanguage === 'zh' ? `ç¬¬ ${currentGroupNumber} ç»„` : `Group ${currentGroupNumber}`;
            document.getElementById('groupCounter').textContent = groupText;
        }

        function generateComparisonPairs() {
            comparisonPairs = [];
            
            // åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯å¼ å›¾ç‰‡çš„IDå‡ºç°æ°å¥½2æ¬¡
            let imagePool = [];
            imageLibrary.forEach(img => {
                imagePool.push(img.id);
                imagePool.push(img.id);
            });
            
            // éšæœºæ‰“ä¹±å›¾ç‰‡æ± 
            for (let i = imagePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imagePool[i], imagePool[j]] = [imagePool[j], imagePool[i]];
            }
            
            debugLog(`ğŸ“Š å›¾ç‰‡æ± åˆ›å»ºå®Œæˆï¼Œå…± ${imagePool.length} ä¸ªå›¾ç‰‡å®ä¾‹`);
            
            // æˆå¯¹ç»„åˆï¼Œç¡®ä¿æ¯å¯¹ä¸æ˜¯åŒä¸€å¼ å›¾ç‰‡
            for (let i = 0; i < imagePool.length - 1; i += 2) {
                let imageAId = imagePool[i];
                let imageBId = imagePool[i + 1];
                
                // å¦‚æœæ˜¯åŒä¸€å¼ å›¾ç‰‡ï¼Œå°è¯•ä¸åé¢çš„å›¾ç‰‡äº¤æ¢
                if (imageAId === imageBId && i + 2 < imagePool.length) {
                    for (let k = i + 2; k < imagePool.length; k++) {
                        if (imagePool[k] !== imageAId) {
                            [imagePool[i + 1], imagePool[k]] = [imagePool[k], imagePool[i + 1]];
                            imageBId = imagePool[i + 1];
                            break;
                        }
                    }
                }
                
                // å¦‚æœä»ç„¶æ˜¯åŒä¸€å¼ å›¾ç‰‡ï¼Œè·³è¿‡è¿™ä¸€å¯¹
                if (imageAId !== imageBId) {
                    const imageA = imageLibrary.find(img => img.id === imageAId);
                    const imageB = imageLibrary.find(img => img.id === imageBId);
                    
                    if (imageA && imageB) {
                        comparisonPairs.push({ imageA, imageB });
                    }
                }
                
                // ç¡®ä¿ä¸è¶…è¿‡50ç»„å¯¹æ¯”
                if (comparisonPairs.length >= 50) {
                    break;
                }
            }
            
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„ç”Ÿæˆäº† ${comparisonPairs.length} ç»„é…å¯¹`);
        }

        function generateNewComparison() {
            if (currentComparisonIndex >= 50) {
                completeCurrentGroup();
                return;
            }
            
            currentPair = comparisonPairs[currentComparisonIndex];

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            // åŠ è½½å½“å‰å›¾ç‰‡
            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            // å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡
            preloadNextPair();

            document.getElementById('progressCounter').textContent = `${currentComparisonIndex + 1}/50`;
            
            resetAllSelections();
            
            // å¯åŠ¨è®¡æ—¶å™¨
            startComparisonTimer();
        }

        function resetAllSelections() {
            // é‡ç½®æ‰€æœ‰å•é€‰æŒ‰é’®
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
            });
            
            // é‡ç½®ç¡®è®¤æŒ‰é’®
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function checkAllAnswered() {
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const allAnswered = radioGroups.every(group => {
                return document.querySelector(`input[name="${group}"]:checked`) !== null;
            });
            
            const confirmButton = document.getElementById('confirmButton');
            if (allAnswered) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                confirmButton.disabled = true;
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function confirmAllSelections() {
            // æ£€æŸ¥æœ€å°è§‚çœ‹æ—¶é—´
            if (!checkMinimumViewTime()) {
                showTimeWarning();
                return;
            }
            
            // æ”¶é›†æ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆ
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const behaviors = ['å', 'è¡Œèµ°', 'æ…¢è·‘', 'é›†åˆ'];
            const answers = {};
            
            let allAnswered = true;
            radioGroups.forEach((group, index) => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    answers[group] = {
                        behavior: behaviors[index],
                        choice: selected.value,
                        winner: selected.value === 'A' ? currentPair.imageA.id : currentPair.imageB.id,
                        loser: selected.value === 'A' ? currentPair.imageB.id : currentPair.imageA.id,
                        winnerImage: selected.value === 'A' ? currentPair.imageA.name : currentPair.imageB.name,
                        loserImage: selected.value === 'A' ? currentPair.imageB.name : currentPair.imageA.name
                    };
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert(currentLanguage === 'zh' ? 'è¯·å›ç­”æ‰€æœ‰é—®é¢˜ï¼' : 'Please answer all questions!');
                return;
            }

            // è®°å½•å¯¹æ¯”ç»“æœ
            comparisons.push({
                imageA: currentPair.imageA,
                imageB: currentPair.imageB,
                answers: answers,
                timestamp: new Date().toISOString(),
                groupNumber: currentGroupNumber,
                comparisonIndex: currentComparisonIndex + 1,
                viewTime: Date.now() - comparisonStartTime // è®°å½•è§‚çœ‹æ—¶é—´
            });

            currentComparisonIndex++;
            
            // æ¸…ç†é¢„åŠ è½½ç¼“å­˜ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤š
            cleanupPreloadCache();
            
            generateNewComparison();
        }

        function completeCurrentGroup() {
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„å¯¹æ¯”å®Œæˆï¼Œå…±${comparisons.length}æ¬¡å¯¹æ¯”`);
            
            // ä¿å­˜å½“å‰ç»„æ•°æ®
            saveUserSession();
            
            // æ˜¾ç¤ºç»§ç»­è¯¢é—®é¡µé¢
            showPage('continuePage');
        }

        function continueNextGroup() {
            currentGroupNumber++;
            startNewGroup();
        }

        function finishSurvey() {
            showPage('thankYouPage');
        }

        function restart() {
            userData = { nickname: '', gender: '', age: '', isProfessional: '' };
            comparisons = [];
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            comparisonPairs = [];
            currentComparisonIndex = 0;
            currentGroupNumber = 1;
            sessionId = generateSessionId();
            preloadedImages.clear(); // æ¸…ç©ºé¢„åŠ è½½ç¼“å­˜
            comparisonStartTime = null; // é‡ç½®æ—¶é—´
            timeWarningShown = false;
            
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('nicknameInput').value = '';
            document.getElementById('ageInput').value = '';
            document.getElementById('consentCheckbox').checked = false;
            
            showPage('languagePage');
        }

        // ====================================================================
        // ç®¡ç†å‘˜ç•Œé¢
        // ====================================================================
        const ADMIN_PASSWORD = 'UMS2025ygs';
        
        function showAdminPanel() {
            // å¯†ç éªŒè¯
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
            
            if (password === null) {
                return;
            }
            
            if (password !== ADMIN_PASSWORD) {
                alert('å¯†ç é”™è¯¯ï¼');
                return;
            }
            
            // å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢
            refreshStats();
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function refreshStats() {
            const sessions = getAllSessions();
            const comparisonRecords = getComparisonRecords();
            
            // æ›´æ–°åŸºæœ¬ç»Ÿè®¡
            document.getElementById('totalUsers').textContent = sessions.length;
            document.getElementById('totalComparisons').textContent = comparisonRecords.length;
            
            const avgComparisonsPerUser = sessions.length > 0 ? (comparisonRecords.length / sessions.length).toFixed(1) : '0';
            document.getElementById('avgGroups').textContent = avgComparisonsPerUser;
            
            // æ˜¾ç¤ºå¯¹æ¯”æ•°æ®
            displayComparisonData(comparisonRecords);
            
            // æ›´æ–°ç”¨æˆ·è¯¦æƒ…
            displayUserDetails(sessions);
        }

        function displayComparisonData(records) {
            const comparisonData = document.getElementById('comparisonData');
            
            if (records.length === 0) {
                comparisonData.innerHTML = '<p class="text-gray-500">æš‚æ— å¯¹æ¯”æ•°æ®</p>';
                return;
            }
            
            // æ˜¾ç¤ºæœ€è¿‘çš„20æ¡è®°å½•
            const recentRecords = records.slice(-20).reverse();
            
            const html = `
                <div class="space-y-2">
                    <h4 class="font-semibold text-gray-800 mb-3">æœ€è¿‘20æ¡å¯¹æ¯”è®°å½•</h4>
                    <div class="grid grid-cols-10 gap-1 text-xs font-semibold text-gray-700 border-b pb-2">
                        <div>æ˜µç§°</div>
                        <div>ç»„åº</div>
                        <div>å›¾ç‰‡1</div>
                        <div>å›¾ç‰‡2</div>
                        <div>å</div>
                        <div>è¡Œèµ°</div>
                        <div>æ…¢è·‘</div>
                        <div>é›†åˆ</div>
                        <div>æ—¶é•¿(s)</div>
                        <div>æ—¶é—´</div>
                    </div>
                    ${recentRecords.map(record => `
                        <div class="grid grid-cols-10 gap-1 text-xs">
                            <div class="truncate" title="${record.nickname}">${record.nickname}</div>
                            <div>${record.groupNumber}-${record.comparisonIndex}</div>
                            <div class="truncate" title="${record.image1_name}">${record.image1_name.substring(0, 8)}...</div>
                            <div class="truncate" title="${record.image2_name}">${record.image2_name.substring(0, 8)}...</div>
                            <div class="text-center ${record.sitting === 0 ? 'text-green-600' : 'text-blue-600'}">${record.sitting}</div>
                            <div class="text-center ${record.walking === 0 ? 'text-green-600' : 'text-blue-600'}">${record.walking}</div>
                            <div class="text-center ${record.jogging === 0 ? 'text-green-600' : 'text-blue-600'}">${record.jogging}</div>
                            <div class="text-center ${record.gathering === 0 ? 'text-green-600' : 'text-blue-600'}">${record.gathering}</div>
                            <div>${(record.viewTime / 1000).toFixed(1)}</div>
                            <div>${new Date(record.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-4 text-sm text-gray-600">
                    <p><span class="text-green-600">0</span> = é€‰æ‹©å›¾ç‰‡1ï¼Œ<span class="text-blue-600">1</span> = é€‰æ‹©å›¾ç‰‡2</p>
                </div>
            `;
            
            comparisonData.innerHTML = html;
        }

        function displayUserDetails(sessions) {
            const userDetails = document.getElementById('userDetails');
            
            if (sessions.length === 0) {
                userDetails.innerHTML = '<p class="text-gray-500">æš‚æ— ç”¨æˆ·æ•°æ®</p>';
                return;
            }
            
            const html = `
                <div class="space-y-2">
                    <div class="grid grid-cols-6 gap-2 text-sm font-semibold text-gray-700 border-b pb-2">
                        <div>æ˜µç§°</div>
                        <div>æ€§åˆ«</div>
                        <div>å¹´é¾„</div>
                        <div>ä¸“ä¸š</div>
                        <div>å®Œæˆç»„æ•°</div>
                        <div>æ—¶é—´</div>
                    </div>
                    ${sessions.slice(-20).map(session => `
                        <div class="grid grid-cols-6 gap-2 text-sm">
                            <div class="truncate">${session.userData.nickname}</div>
                            <div>${session.userData.gender === 'male' ? 'ç”·' : 'å¥³'}</div>
                            <div>${session.userData.age}</div>
                            <div>${session.userData.isProfessional === 'yes' ? 'æ˜¯' : 'å¦'}</div>
                            <div>${session.groupsCompleted}</div>
                            <div>${new Date(session.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            userDetails.innerHTML = html;
        }

        function exportData() {
            const comparisonRecords = getComparisonRecords();
            
            if (comparisonRecords.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            
            // åˆ›å»ºCSVå†…å®¹
            const headers = [
                'sessionId', 'nickname', 'gender', 'age', 'isProfessional',
                'groupNumber', 'comparisonIndex', 'image1_url', 'image2_url',
                'image1_name', 'image2_name', 'sitting', 'walking', 'jogging', 'gathering',
                'viewTime_ms', 'timestamp'
            ];
            
            const csvContent = [
                headers.join(','),
                ...comparisonRecords.map(record => [
                    record.sessionId,
                    `"${record.nickname}"`,
                    record.gender,
                    record.age,
                    record.isProfessional,
                    record.groupNumber,
                    record.comparisonIndex,
                    `"${record.image1_url}"`,
                    `"${record.image2_url}"`,
                    `"${record.image1_name}"`,
                    `"${record.image2_name}"`,
                    record.sitting,
                    record.walking,
                    record.jogging,
                    record.gathering,
                    record.viewTime,
                    record.timestamp
                ].join(','))
            ].join('\n');
            
            // ä¸‹è½½CSVæ–‡ä»¶
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¡—æ™¯é—®å·å¯¹æ¯”æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å·²å¯¼å‡ºä¸ºCSVæ ¼å¼ï¼');
        }

        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('surveySessionsData');
                localStorage.removeItem('comparisonRecords');
                refreshStats();
                alert('æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // ====================================================================
        // é¡µé¢åˆå§‹åŒ–
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('ğŸš€ è¡—æ™¯é—®å·ç³»ç»Ÿå¯åŠ¨ - æ”¹è¿›ç‰ˆ');
            
            await initializeImageLibrary();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åˆ°æ‰€æœ‰å•é€‰æŒ‰é’®
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', checkAllAnswered);
                });
            });
            
            if (isImageLibraryLoaded) {
                debugLog(`âœ… ç³»ç»Ÿå°±ç»ªï¼Œå›¾ç‰‡åº“åŒ…å« ${imageLibrary.length} å¼ å›¾ç‰‡`);
            } else {
                debugLog('âš ï¸ å›¾ç‰‡åº“åˆå§‹åŒ–æœ‰é—®é¢˜ï¼Œä½†ç³»ç»Ÿä»å¯è¿è¡Œ');
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—æ™¯è¡Œä¸ºé—®å·è°ƒç ”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- è¯­è¨€é€‰æ‹©é¡µé¢ -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è¡—æ™¯è¡Œä¸ºæ„ŸçŸ¥é—®å·</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">è¯­è¨€é€‰æ‹©</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ä¸­æ–‡
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯æ”¶é›†é¡µé¢ -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-2xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">çª—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="space-y-6">
                    <!-- æ€§åˆ«é€‰æ‹© -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">æ‚¨çš„æ€§åˆ«æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">ç”·</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">å¥³</span>
                            </label>
                        </div>
                    </div>

                    <!-- å¹´é¾„è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">æ‚¨çš„å¹´é¾„ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- ä¸“ä¸šèƒŒæ™¯ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">æ˜¯</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">å¦</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="emergencyImageTest()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium mr-4">
                        ğŸš¨ ç´§æ€¥å›¾ç‰‡æµ‹è¯•
                    </button>
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        ä¸‹ä¸€éƒ¨åˆ†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å¯¹æ¯”é¡µé¢ -->
    <div id="comparisonPage" class="hidden min-h-screen bg-green-500 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="text-right text-white mb-4">
                <span id="timerLabel">è‡ªåŠ¨è·³è½¬ï¼š</span>                 <span id="progressCounter">1/50</span>
            </div>
            
            <h1 id="compareTitle" class="text-white text-xl font-medium text-center mb-6">
                ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š
            </h1>
            
            <div class="flex justify-between items-start">
                <!-- å·¦ä¾§æç¤º -->
                <div class="w-48 bg-white rounded-lg p-4 mr-4">
                    <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">æç¤º</h3>
                    <p id="instructions" class="text-sm text-gray-600">
                        åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦åœ¨æˆå¯¹çš„å›¾ç‰‡ä¸­åšå‡ºé€‰æ‹©ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡ŒæŒ‡å®šæ´»åŠ¨çš„è¡—æ™¯ã€‚
                    </p>
                </div>
                
                <!-- å›¾ç‰‡å¯¹æ¯”åŒºåŸŸ -->
                <div class="flex-1 space-y-4">
                    <div id="imageA" class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <img id="imageA_img" src="" alt="" class="w-full h-64 object-cover rounded">
                        <div class="text-center mt-2 flex justify-end">
                            <div id="radioA" class="w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors" onclick="selectOption('A')"></div>
                        </div>
                    </div>
                    
                    <div id="imageB" class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <img id="imageB_img" src="" alt="" class="w-full h-64 object-cover rounded">
                        <div class="text-center mt-2 flex justify-end">
                            <div id="radioB" class="w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors" onclick="selectOption('B')"></div>
                        </div>
                    </div>
                </div>
                
                <!-- å³ä¾§ç¡®è®¤æŒ‰é’® -->
                <div class="w-32 ml-4">
                    <button id="confirmButton" onclick="confirmSelection()" disabled class="w-full bg-gray-400 text-white py-3 rounded-lg transition-colors font-medium cursor-not-allowed">
                        ç¡®è®¤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»“æœé¡µé¢ -->
    <div id="resultsPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-4xl mx-auto">
            <h1 id="resultsTitle" class="text-3xl font-bold text-center text-gray-800 mb-8">è°ƒç ”ç»“æœ</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 id="rankingTitle" class="text-xl font-semibold mb-4">å›¾ç‰‡æ’åæƒ…å†µï¼š</h2>
                <div id="rankingList" class="space-y-4">
                    <!-- æ’ååˆ—è¡¨å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ç”¨æˆ·ä¿¡æ¯</h2>
                <div id="userInfo" class="grid grid-cols-3 gap-4 text-sm">
                    <!-- ç”¨æˆ·ä¿¡æ¯å°†ç”±JavaScriptç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="text-center mt-8">
                <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    é‡æ–°å¼€å§‹
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // å…¨å±€é…ç½® - æ”¾åœ¨æœ€å‰é¢é¿å…æœªå®šä¹‰é”™è¯¯
        // ====================================================================
        const LOADING_METHOD = 3; // 1=é¢„å®šä¹‰æ•°ç»„, 2=JSONæ–‡ä»¶, 3=æ–‡æœ¬æ–‡ä»¶
        const DEBUG_MODE = true;   // è°ƒè¯•æ¨¡å¼

        // Cloudinaryé…ç½®
        const CLOUDINARY_CONFIG = {
            cloudName: 'dw3huanrk',
            folderName: 'my_website_images/batch_upload',
            versionNumber: 'v1754902800',
            transformations: 'w_666,h_500,c_fill,q_auto,f_auto'
        };

        // å…¨å±€å˜é‡
        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentComparison = null;
        let imageRankings = {};
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;

        // ====================================================================
        // æ ¸å¿ƒå‡½æ•°å®šä¹‰
        // ====================================================================
        
        // ç´§æ€¥å›¾ç‰‡æµ‹è¯•å‡½æ•°
        function emergencyImageTest() {
            console.log('ğŸš¨ ç´§æ€¥å›¾ç‰‡æµ‹è¯•å¼€å§‹...');
            
            if (!isImageLibraryLoaded || imageLibrary.length === 0) {
                alert('å›¾ç‰‡åº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥ image_list.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”åŒ…å«PNGæ–‡ä»¶å');
                return;
            }
            
            const testImage = imageLibrary[0];
            console.log('ğŸ§ª æµ‹è¯•å›¾ç‰‡:', testImage.filename);
            
            // ç§»é™¤å·²å­˜åœ¨çš„æµ‹è¯•çª—å£
            const existingTest = document.getElementById('emergencyTest');
            if (existingTest) {
                existingTest.remove();
            }
            
            // åˆ›å»ºæµ‹è¯•åŒºåŸŸ
            const testArea = document.createElement('div');
            testArea.id = 'emergencyTest';
            testArea.style.cssText = `
                position: fixed; top: 50px; right: 10px; width: 350px; height: 450px; 
                background: white; border: 3px solid #ff0000; padding: 15px; z-index: 9999;
                overflow-y: auto; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            testArea.innerHTML = `
                <h3 style="margin:0 0 10px 0;">ğŸš¨ ç´§æ€¥å›¾ç‰‡æµ‹è¯•</h3>
                <button onclick="document.getElementById('emergencyTest').remove()" style="float:right; margin-top:-30px;">âŒ å…³é—­</button>
                <p style="font-size:12px; color:#666;">æµ‹è¯•ç¬¬ä¸€å¼ å›¾ç‰‡: <br><code>${testImage.filename}</code></p>
                <hr>
            `;
            
            // æµ‹è¯•å¤šç§URLæ ¼å¼
            const testUrls = [
                `https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/c_fill,w_200,h_150/v1754902800/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/f_auto,c_scale,w_200/my_website_images/batch_upload/${testImage.filename}`
            ];
            
            testUrls.forEach((url, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.cssText = 'margin: 10px 0; padding: 8px; border: 1px solid #eee;';
                imgContainer.innerHTML = `
                    <p style="margin:0 0 5px 0;"><strong>æ ¼å¼ ${index + 1}:</strong></p>
                    <img src="${url}" style="width: 100%; max-height: 60px; object-fit: cover; border: 1px solid #ccc;" 
                         onload="console.log('âœ… æ ¼å¼ ${index + 1} æˆåŠŸ!', '${url}'); this.nextElementSibling.innerHTML = 'âœ… æˆåŠŸï¼'; this.nextElementSibling.style.color = 'green';"
                         onerror="console.log('âŒ æ ¼å¼ ${index + 1} å¤±è´¥', '${url}'); this.nextElementSibling.innerHTML = 'âŒ å¤±è´¥'; this.nextElementSibling.style.color = 'red';">
                    <p style="margin:5px 0 0 0; font-weight:bold;">â³ åŠ è½½ä¸­...</p>
                `;
                testArea.appendChild(imgContainer);
            });
            
            const instruction = document.createElement('div');
            instruction.innerHTML = `
                <hr>
                <div style="background:#f0f8ff; padding:8px; border-radius:4px; font-size:12px;">
                    <strong>ğŸ“ ä½¿ç”¨è¯´æ˜:</strong><br>
                    1. ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ<br>
                    2. æ‰¾åˆ°æ˜¾ç¤º"âœ… æˆåŠŸï¼"çš„æ ¼å¼<br>
                    3. è®°ä¸‹æˆåŠŸçš„æ ¼å¼ç¼–å·<br>
                    4. å‘Šè¯‰æˆ‘å“ªä¸ªæ ¼å¼æˆåŠŸäº†
                </div>
            `;
            testArea.appendChild(instruction);
            
            document.body.appendChild(testArea);
        }

        // æ·»åŠ ç›´æ¥ä¿®å¤é€‰é¡¹ - å¦‚æœæµ‹è¯•æˆåŠŸï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä½¿ç”¨
        /*
        // é€‰é¡¹1ï¼šå¦‚æœåŸºç¡€URLæ ¼å¼å·¥ä½œ (æ ¼å¼1æˆåŠŸæ—¶ä½¿ç”¨)
        function buildCloudinaryUrl(filename) {
            return {
                primary: `https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/${filename.trim()}`,
                alternatives: []
            };
        }
        */
        
        /*
        // é€‰é¡¹2ï¼šå¦‚æœæ— ç‰ˆæœ¬å·æ ¼å¼å·¥ä½œ (æ ¼å¼2æˆåŠŸæ—¶ä½¿ç”¨)
        function buildCloudinaryUrl(filename) {
            return {
                primary: `https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/${filename.trim()}`,
                alternatives: []
            };
        }
        */

        // æ„å»ºCloudinary URLçš„å‡½æ•°
        function buildCloudinaryUrl(filename) {
            const cleanFilename = filename.trim();
            const urls = [];
            
            // åŸºäºå®é™…æµ‹è¯•ç»“æœï¼ŒæŒ‰æˆåŠŸç‡æ’åºçš„URLæ ¼å¼
            urls.push(`https://res.cloudinary.com/${CLOUDINARY_CONFIG.cloudName}/image/upload/${CLOUDINARY_CONFIG.versionNumber}/${CLOUDINARY_CONFIG.folderName}/${cleanFilename}`);
            urls.push(`https://res.cloudinary.com/${CLOUDINARY_CONFIG.cloudName}/image/upload/${CLOUDINARY_CONFIG.folderName}/${cleanFilename}`);
            urls.push(`https://res.cloudinary.com/${CLOUDINARY_CONFIG.cloudName}/image/upload/c_fill,w_666,h_500/${CLOUDINARY_CONFIG.versionNumber}/${CLOUDINARY_CONFIG.folderName}/${cleanFilename}`);
            urls.push(`https://res.cloudinary.com/${CLOUDINARY_CONFIG.cloudName}/image/upload/f_auto,c_fill,w_666,h_500/${CLOUDINARY_CONFIG.versionNumber}/${CLOUDINARY_CONFIG.folderName}/${cleanFilename}`);
            
            if (DEBUG_MODE) {
                console.log(`ğŸ”— Building URLs for "${cleanFilename}":`);
                urls.forEach((url, index) => {
                    console.log(`  ${index + 1}. ${url}`);
                });
            }
            
            return {
                primary: urls[0],
                alternatives: urls.slice(1)
            };
        }

        // ä»æ–‡ä»¶ååˆ—è¡¨ç”Ÿæˆå›¾ç‰‡åº“
        function generateImageLibraryFromFilenames(filenames) {
            return filenames.map((filename, index) => {
                const urlData = buildCloudinaryUrl(filename);
                return {
                    id: index + 1,
                    url: urlData.primary,
                    alternativeUrls: urlData.alternatives,
                    name: filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, ''),
                    filename: filename
                };
            });
        }

        // é¢„å®šä¹‰å›¾ç‰‡åˆ—è¡¨
        const PREDEFINED_IMAGE_LIST = [
            'fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'b7d2da36-4d32-41ae-b9b7-e1be90cc1c49.png',
            '022fed74-9510-40e2-bc92-cd237677a4fb.png'
        ];

        // å¤–éƒ¨æ–‡ä»¶URLs
        const IMAGE_LIST_JSON_URL = 'image_list.json';
        const IMAGE_LIST_TXT_URL = 'image_list.txt';

        // ä»é¢„å®šä¹‰æ•°ç»„åŠ è½½å›¾ç‰‡å
        async function loadFromPredefinedArray() {
            if (PREDEFINED_IMAGE_LIST.length > 0) {
                console.log(`Loading ${PREDEFINED_IMAGE_LIST.length} images from predefined array`);
                return PREDEFINED_IMAGE_LIST;
            }
            return null;
        }

        // ä»JSONæ–‡ä»¶åŠ è½½å›¾ç‰‡å
        async function loadFromJSONFile() {
            try {
                const response = await fetch(IMAGE_LIST_JSON_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log(`Loaded ${data.images.length} images from JSON file`);
                return data.images;
            } catch (error) {
                console.error('Error loading from JSON file:', error);
                return null;
            }
        }

        // ä»æ–‡æœ¬æ–‡ä»¶åŠ è½½å›¾ç‰‡å
        async function loadFromTextFile() {
            try {
                const response = await fetch(IMAGE_LIST_TXT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const text = await response.text();
                const filenames = text
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'));
                console.log(`Loaded ${filenames.length} images from text file`);
                return filenames;
            } catch (error) {
                console.error('Error loading from text file:', error);
                return null;
            }
        }

        // ç¨‹åºåŒ–ç”Ÿæˆå›¾ç‰‡åï¼ˆä½œä¸ºåå¤‡æ–¹æ¡ˆï¼‰
        function generateImageNames(count = 100, prefix = 'image_', extension = '.jpg', startNumber = 1) {
            const filenames = [];
            for (let i = startNumber; i < startNumber + count; i++) {
                const paddedNumber = i.toString().padStart(4, '0');
                filenames.push(`${prefix}${paddedNumber}${extension}`);
            }
            console.log(`Generated ${filenames.length} image names programmatically`);
            return filenames;
        }

        // ä»å¯ç”¨çš„å›¾ç‰‡ä¸­éšæœºé€‰æ‹©æŒ‡å®šæ•°é‡è¿›è¡Œå¯¹æ¯”
        function selectRandomImagesForComparison(totalImages, comparisonCount = 100) {
            const selectedImages = [];
            const imageCount = totalImages.length;
            
            const maxPossibleComparisons = Math.min(comparisonCount, imageCount);
            
            const shuffledIndices = Array.from({length: imageCount}, (_, i) => i)
                .sort(() => 0.5 - Math.random())
                .slice(0, maxPossibleComparisons);
            
            shuffledIndices.forEach(index => {
                selectedImages.push(totalImages[index]);
            });
            
            return selectedImages;
        }

        // åˆå§‹åŒ–å›¾ç‰‡åº“çš„ä¸»å‡½æ•°
        async function initializeImageLibrary() {
            let filenames = null;
            
            console.log(`Attempting to load image names using method ${LOADING_METHOD}...`);
            
            try {
                // æ ¹æ®é€‰æ‹©çš„æ–¹æ¡ˆåŠ è½½å›¾ç‰‡å
                switch (LOADING_METHOD) {
                    case 1:
                        filenames = await loadFromPredefinedArray();
                        break;
                    case 2:
                        filenames = await loadFromJSONFile();
                        break;
                    case 3:
                        filenames = await loadFromTextFile();
                        break;
                    default:
                        console.error('Invalid loading method specified');
                        break;
                }

                // å¦‚æœä¸»è¦æ–¹æ¡ˆå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ¡ˆ
                if (!filenames || filenames.length === 0) {
                    console.log('Primary method failed, trying text file...');
                    filenames = await loadFromTextFile();
                }

                if (!filenames || filenames.length === 0) {
                    console.log('Text file failed, trying predefined array...');
                    filenames = await loadFromPredefinedArray();
                }

                // å¦‚æœä»ç„¶å¤±è´¥ï¼Œä½¿ç”¨ç¨‹åºåŒ–ç”Ÿæˆä½œä¸ºæœ€åçš„åå¤‡æ–¹æ¡ˆ
                if (!filenames || filenames.length === 0) {
                    console.log('All file methods failed, generating names programmatically...');
                    filenames = generateImageNames(100, 'street_', '.jpg', 1);
                }

                if (filenames && filenames.length > 0) {
                    const fullImageLibrary = generateImageLibraryFromFilenames(filenames);
                    // ä»æ‰€æœ‰å›¾ç‰‡ä¸­éšæœºé€‰æ‹©100å¼ ç”¨äºå¯¹æ¯”
                    imageLibrary = selectRandomImagesForComparison(fullImageLibrary, 100);
                    isImageLibraryLoaded = true;
                    console.log(`Image library initialized with ${imageLibrary.length} images for comparison (from ${filenames.length} total images)`);
                    console.log('Sample URLs:', imageLibrary.slice(0, 2).map(img => img.url));
                } else {
                    console.error('Failed to load any image names');
                    isImageLibraryLoaded = false;
                }
            } catch (error) {
                console.error('Error during image library initialization:', error);
                isImageLibraryLoaded = false;
            }
        }

        // å…¨å±€å˜é‡
        let currentLanguage = 'zh';
        let userData = { gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentComparison = null;
        let imageRankings = {};
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;

        // ç´§æ€¥å›¾ç‰‡æµ‹è¯•å‡½æ•°
        function emergencyImageTest() {
            console.log('ğŸš¨ ç´§æ€¥å›¾ç‰‡æµ‹è¯•å¼€å§‹...');
            
            if (!isImageLibraryLoaded || imageLibrary.length === 0) {
                alert('å›¾ç‰‡åº“æœªåŠ è½½ï¼è¯·æ£€æŸ¥ image_list.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”åŒ…å«PNGæ–‡ä»¶å');
                return;
            }
            
            const testImage = imageLibrary[0];
            console.log('ğŸ§ª æµ‹è¯•å›¾ç‰‡:', testImage.filename);
            
            // ç§»é™¤å·²å­˜åœ¨çš„æµ‹è¯•çª—å£
            const existingTest = document.getElementById('emergencyTest');
            if (existingTest) {
                existingTest.remove();
            }
            
            // åˆ›å»ºæµ‹è¯•åŒºåŸŸ
            const testArea = document.createElement('div');
            testArea.id = 'emergencyTest';
            testArea.style.cssText = `
                position: fixed; top: 50px; right: 10px; width: 350px; height: 450px; 
                background: white; border: 3px solid #ff0000; padding: 15px; z-index: 9999;
                overflow-y: auto; font-size: 13px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            `;
            testArea.innerHTML = `
                <h3 style="margin:0 0 10px 0;">ğŸš¨ ç´§æ€¥å›¾ç‰‡æµ‹è¯•</h3>
                <button onclick="document.getElementById('emergencyTest').remove()" style="float:right; margin-top:-30px;">âŒ å…³é—­</button>
                <p style="font-size:12px; color:#666;">æµ‹è¯•ç¬¬ä¸€å¼ å›¾ç‰‡: <br><code>${testImage.filename}</code></p>
                <hr>
            `;
            
            // æµ‹è¯•å¤šç§URLæ ¼å¼
            const testUrls = [
                `https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/c_fill,w_200,h_150/v1754902800/my_website_images/batch_upload/${testImage.filename}`,
                `https://res.cloudinary.com/dw3huanrk/image/upload/f_auto,c_scale,w_200/my_website_images/batch_upload/${testImage.filename}`
            ];
            
            testUrls.forEach((url, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.style.cssText = 'margin: 10px 0; padding: 8px; border: 1px solid #eee;';
                imgContainer.innerHTML = `
                    <p style="margin:0 0 5px 0;"><strong>æ ¼å¼ ${index + 1}:</strong></p>
                    <img src="${url}" style="width: 100%; max-height: 60px; object-fit: cover; border: 1px solid #ccc;" 
                         onload="console.log('âœ… æ ¼å¼ ${index + 1} æˆåŠŸ!', '${url}'); this.nextElementSibling.innerHTML = 'âœ… æˆåŠŸï¼'; this.nextElementSibling.style.color = 'green';"
                         onerror="console.log('âŒ æ ¼å¼ ${index + 1} å¤±è´¥', '${url}'); this.nextElementSibling.innerHTML = 'âŒ å¤±è´¥'; this.nextElementSibling.style.color = 'red';">
                    <p style="margin:5px 0 0 0; font-weight:bold;">â³ åŠ è½½ä¸­...</p>
                `;
                testArea.appendChild(imgContainer);
            });
            
            const instruction = document.createElement('div');
            instruction.innerHTML = `
                <hr>
                <div style="background:#f0f8ff; padding:8px; border-radius:4px; font-size:12px;">
                    <strong>ğŸ“ ä½¿ç”¨è¯´æ˜:</strong><br>
                    1. ç­‰å¾…å›¾ç‰‡åŠ è½½å®Œæˆ<br>
                    2. æ‰¾åˆ°æ˜¾ç¤º"âœ… æˆåŠŸï¼"çš„æ ¼å¼<br>
                    3. è®°ä¸‹æˆåŠŸçš„æ ¼å¼ç¼–å·<br>
                    4. å‘Šè¯‰æˆ‘å“ªä¸ªæ ¼å¼æˆåŠŸäº†
                </div>
            `;
            testArea.appendChild(instruction);
            
            document.body.appendChild(testArea);
        }

        // æ–‡æœ¬å†…å®¹
        const texts = {
            zh: {
                surveyTitle: 'çª—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†',
                genderLabel: 'æ‚¨çš„æ€§åˆ«æ˜¯ï¼š',
                maleLabel: 'ç”·',
                femaleLabel: 'å¥³',
                ageLabel: 'æ‚¨çš„å¹´é¾„ï¼š',
                professionalLabel: 'æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ',
                yesLabel: 'æ˜¯',
                noLabel: 'å¦',
                nextButton: 'ä¸‹ä¸€éƒ¨åˆ†',
                compareTitle: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"ï¼š',
                timerLabel: 'è‡ªåŠ¨è·³è½¬ï¼š',
                hintTitle: 'æç¤º',
                instructions: 'åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦åœ¨æˆå¯¹çš„å›¾ç‰‡ä¸­åšå‡ºé€‰æ‹©ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆç‰¹å®šè¡Œä¸ºçš„è¡—æ™¯ã€‚',
                resultsTitle: 'è°ƒç ”ç»“æœ',
                rankingTitle: 'å›¾ç‰‡æ’åæƒ…å†µï¼š',
                restartButton: 'é‡æ–°å¼€å§‹'
            },
            en: {
                surveyTitle: 'Window View Perception Questionnaire: Part 1',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                timerLabel: 'Auto redirect:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to make choices between pairs of images. Please choose the street view you think is more suitable for certain behaviours based on your intuition.',
                resultsTitle: 'Survey Results',
                rankingTitle: 'Image Rankings:',
                restartButton: 'Start Over'
            }
        };

        // åˆå§‹åŒ–æ’åç³»ç»Ÿ
        function initializeRankings() {
            imageRankings = {};
            imageLibrary.forEach(img => {
                imageRankings[img.id] = { score: 1000, wins: 0, losses: 0 };
            });
        }

        // è¯­è¨€é€‰æ‹©
        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        // æ›´æ–°æ–‡æœ¬å†…å®¹
        function updateTexts() {
            const t = texts[currentLanguage];
            document.getElementById('surveyTitle').textContent = t.surveyTitle;
            document.getElementById('genderLabel').textContent = t.genderLabel;
            document.getElementById('maleLabel').textContent = t.maleLabel;
            document.getElementById('femaleLabel').textContent = t.femaleLabel;
            document.getElementById('ageLabel').textContent = t.ageLabel;
            document.getElementById('professionalLabel').textContent = t.professionalLabel;
            document.getElementById('yesLabel').textContent = t.yesLabel;
            document.getElementById('noLabel').textContent = t.noLabel;
            document.getElementById('nextButton').textContent = t.nextButton;
            document.getElementById('compareTitle').textContent = t.compareTitle;
            document.getElementById('timerLabel').textContent = t.timerLabel;
            document.getElementById('hintTitle').textContent = t.hintTitle;
            document.getElementById('instructions').textContent = t.instructions;
            document.getElementById('resultsTitle').textContent = t.resultsTitle;
            document.getElementById('rankingTitle').textContent = t.rankingTitle;
            document.getElementById('restartButton').textContent = t.restartButton;
        }

        // æ˜¾ç¤ºé¡µé¢
        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'resultsPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        // å¼€å§‹å¯¹æ¯”
        async function startComparisons() {
            // éªŒè¯è¡¨å•
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');

            if (!gender || !age || !professional) {
                alert(currentLanguage === 'zh' ? 'è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼' : 'Please fill in all required fields!');
                return;
            }

            userData = {
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const button = document.getElementById('nextButton');
            button.disabled = true;
            button.textContent = currentLanguage === 'zh' ? 'æ­£åœ¨å‡†å¤‡å›¾ç‰‡å¯¹æ¯”...' : 'Preparing image comparisons...';

            // ç¡®ä¿å›¾ç‰‡åº“å·²åŠ è½½
            if (!isImageLibraryLoaded) {
                try {
                    await initializeImageLibrary();
                } catch (error) {
                    console.error('Failed to initialize image library:', error);
                }
            }

            // æ¢å¤æŒ‰é’®çŠ¶æ€
            button.disabled = false;
            button.textContent = currentLanguage === 'zh' ? 'ä¸‹ä¸€éƒ¨åˆ†' : 'Next Part';

            if (!isImageLibraryLoaded || imageLibrary.length < 2) {
                const errorMessage = currentLanguage === 'zh' ? 
                    'å›¾ç‰‡åº“åŠ è½½å¤±è´¥ã€‚è¯·æ£€æŸ¥ï¼š\n1. image_list.txt æ–‡ä»¶æ˜¯å¦å­˜åœ¨\n2. æ–‡ä»¶ä¸­æ˜¯å¦æœ‰å›¾ç‰‡æ–‡ä»¶å\n3. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸' : 
                    'Failed to load image library. Please check:\n1. image_list.txt file exists\n2. File contains image filenames\n3. Network connection';
                alert(errorMessage);
                console.log('Debug info - Image library status:', {
                    isLoaded: isImageLibraryLoaded,
                    imageCount: imageLibrary.length,
                    sampleImages: imageLibrary.slice(0, 3)
                });
                return;
            }

            initializeRankings();
            generateNewComparison();
            showPage('comparisonPage');
        }

        // å°è¯•åŠ è½½å›¾ç‰‡çš„å‡½æ•°ï¼ˆæ”¯æŒå¤šä¸ªURLå¤‡é€‰ï¼‰
        function loadImageWithFallback(imgElement, imageData, imageLabel) {
            let currentUrlIndex = 0;
            const allUrls = [imageData.url, ...imageData.alternativeUrls];
            
            function tryNextUrl() {
                if (currentUrlIndex >= allUrls.length) {
                    console.error(`âŒ All URLs failed for ${imageLabel}:`, imageData.filename);
                    // æ˜¾ç¤ºå ä½å›¾
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIE5vdCBGb3VuZDwvdGV4dD48L3N2Zz4=';
                    return;
                }
                
                const currentUrl = allUrls[currentUrlIndex];
                if (DEBUG_MODE) {
                    console.log(`ğŸ”„ Trying URL ${currentUrlIndex + 1}/${allUrls.length} for ${imageLabel}:`, currentUrl);
                }
                
                imgElement.onload = function() {
                    if (DEBUG_MODE) {
                        console.log(`âœ… Successfully loaded ${imageLabel} with URL ${currentUrlIndex + 1}:`, currentUrl);
                    }
                };
                
                imgElement.onerror = function() {
                    if (DEBUG_MODE) {
                        console.log(`âŒ Failed to load ${imageLabel} with URL ${currentUrlIndex + 1}:`, currentUrl);
                    }
                    currentUrlIndex++;
                    tryNextUrl();
                };
                
                imgElement.src = currentUrl;
            }
            
            tryNextUrl();
        }

        // ç”Ÿæˆæ–°çš„å¯¹æ¯”
        function generateNewComparison() {
            const shuffled = [...imageLibrary].sort(() => 0.5 - Math.random());
            currentPair = {
                imageA: shuffled[0],
                imageB: shuffled[1]
            };

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            // è®¾ç½®å›¾ç‰‡altå±æ€§
            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            // ä½¿ç”¨æ–°çš„å›¾ç‰‡åŠ è½½å‡½æ•°
            loadImageWithFallback(imageA_img, currentPair.imageA, 'Image A');
            loadImageWithFallback(imageB_img, currentPair.imageB, 'Image B');

            document.getElementById('progressCounter').textContent = `${comparisons.length + 1}/50`;
            
            resetSelection();
        }

        // é‡ç½®é€‰æ‹©çŠ¶æ€
        function resetSelection() {
            selectedOption = null;
            
            const radioA = document.getElementById('radioA');
            const radioB = document.getElementById('radioB');
            
            radioA.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioB.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioA.innerHTML = '';
            radioB.innerHTML = '';
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        // é€‰æ‹©é€‰é¡¹
        function selectOption(choice) {
            selectedOption = choice;
            
            const radioA = document.getElementById('radioA');
            const radioB = document.getElementById('radioB');
            
            radioA.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioB.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioA.innerHTML = '';
            radioB.innerHTML = '';
            
            if (choice === 'A') {
                radioA.className = 'w-6 h-6 border-2 border-green-500 bg-green-500 rounded-full cursor-pointer transition-colors';
                radioA.innerHTML = '<div class="w-2 h-2 bg-white rounded-full m-auto mt-1"></div>';
            } else {
                radioB.className = 'w-6 h-6 border-2 border-green-500 bg-green-500 rounded-full cursor-pointer transition-colors';
                radioB.innerHTML = '<div class="w-2 h-2 bg-white rounded-full m-auto mt-1"></div>';
            }
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
        }

        // ç¡®è®¤é€‰æ‹©
        function confirmSelection() {
            if (!selectedOption) return;
            
            let winnerId, loserId;
            if (selectedOption === 'A') {
                winnerId = currentPair.imageA.id;
                loserId = currentPair.imageB.id;
            } else {
                winnerId = currentPair.imageB.id;
                loserId = currentPair.imageA.id;
            }

            // æ›´æ–°æ’åï¼ˆç®€åŒ–çš„ELOç®—æ³•ï¼‰
            const K = 32;
            const winnerRating = imageRankings[winnerId].score;
            const loserRating = imageRankings[loserId].score;
            
            const expectedWinner = 1 / (1 + Math.pow(10, (loserRating - winnerRating) / 400));
            
            imageRankings[winnerId].score += K * (1 - expectedWinner);
            imageRankings[loserId].score += K * (0 - expectedWinner);
            imageRankings[winnerId].wins += 1;
            imageRankings[loserId].losses += 1;

            // è®°å½•å¯¹æ¯”ç»“æœ
            comparisons.push({
                winner: winnerId,
                loser: loserId,
                timestamp: new Date().toISOString()
            });

            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ‰€æœ‰å¯¹æ¯”
            if (comparisons.length >= 50) {
                showResults();
            } else {
                generateNewComparison();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResults() {
            showPage('resultsPage');
            
            // ç”Ÿæˆæ’ååˆ—è¡¨
            const sortedImages = imageLibrary
                .map(img => ({
                    ...img,
                    ...imageRankings[img.id]
                }))
                .sort((a, b) => b.score - a.score);

            const rankingHTML = sortedImages.map((img, index) => `
                <div class="flex items-center space-x-4 p-4 border rounded-lg">
                    <div class="text-2xl font-bold text-green-600">#${index + 1}</div>
                    <img src="${img.url}" alt="${img.name}" class="w-20 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-medium">${img.name}</h3>
                        <p class="text-sm text-gray-600">
                            å¾—åˆ†: ${Math.round(img.score)} | èƒœ: ${img.wins} | è´Ÿ: ${img.losses}
                        </p>
                    </div>
                </div>
            `).join('');

            document.getElementById('rankingList').innerHTML = rankingHTML;

            // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
            const genderText = userData.gender === 'male' ? (currentLanguage === 'zh' ? 'ç”·' : 'Male') : (currentLanguage === 'zh' ? 'å¥³' : 'Female');
            const professionalText = userData.isProfessional === 'yes' ? (currentLanguage === 'zh' ? 'æ˜¯' : 'Yes') : (currentLanguage === 'zh' ? 'å¦' : 'No');
            
            document.getElementById('userInfo').innerHTML = `
                <div>${currentLanguage === 'zh' ? 'æ€§åˆ«' : 'Gender'}: ${genderText}</div>
                <div>${currentLanguage === 'zh' ? 'å¹´é¾„' : 'Age'}: ${userData.age}</div>
                <div>${currentLanguage === 'zh' ? 'ä¸“ä¸šèƒŒæ™¯' : 'Professional'}: ${professionalText}</div>
            `;
        }

        // é‡æ–°å¼€å§‹
        function restart() {
            userData = { gender: '', age: '', isProfessional: '' };
            comparisons = [];
            currentComparison = null;
            imageRankings = {};
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            
            // æ¸…ç©ºè¡¨å•
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('ageInput').value = '';
            
            showPage('languagePage');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ Survey application loaded');
            console.log('ğŸ“‹ Configuration:', CLOUDINARY_CONFIG);
            console.log('ğŸ”§ Debug mode:', DEBUG_MODE ? 'ON' : 'OFF');
            console.log('ğŸ“ Loading method:', LOADING_METHOD);
            console.log('ğŸ–¼ï¸ Expected image format: PNG');
            
            // é¢„å…ˆåŠ è½½å›¾ç‰‡åº“
            await initializeImageLibrary();
            
            if (isImageLibraryLoaded && imageLibrary.length > 0) {
                console.log('ğŸ“‹ ç°åœ¨å›¾ç‰‡åº“å·²åŠ è½½:', imageLibrary.length, 'å¼ å›¾ç‰‡');
                
                if (DEBUG_MODE && imageLibrary.length > 0) {
                    const testImage = imageLibrary[0];
                    console.log('ğŸ§ª æµ‹è¯•ç¬¬ä¸€å¼ å›¾ç‰‡:', testImage.filename);
                    
                    // ç®€åŒ–çš„æµ‹è¯•URL
                    const quickTestUrl = `https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/${testImage.filename}`;
                    console.log('ğŸ”— å¿«é€Ÿæµ‹è¯•URL:', quickTestUrl);
                    
                    // æ·»åŠ ç®€å•çš„æµ‹è¯•
                    const testImg = new Image();
                    testImg.onload = function() {
                        console.log('âœ… ç¬¬ä¸€å¼ å›¾ç‰‡åŠ è½½æˆåŠŸï¼URLæ ¼å¼æ­£ç¡®');
                        console.log('ğŸ’¡ å¦‚æœè¿™ä¸ªæˆåŠŸäº†ï¼Œé—®å·åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œ');
                    };
                    testImg.onerror = function() {
                        console.log('âŒ ç¬¬ä¸€å¼ å›¾ç‰‡åŠ è½½å¤±è´¥');
                        console.log('ğŸš¨ è¯·ä½¿ç”¨ç´§æ€¥æµ‹è¯•æŒ‰é’®æ‰¾åˆ°æ­£ç¡®æ ¼å¼');
                    };
                    testImg.src = quickTestUrl;
                }
            } else {
                console.warn('âš ï¸ Image library initialization failed or incomplete');
                console.log('ğŸ’¡ è¯·æ£€æŸ¥ image_list.txt æ˜¯å¦å­˜åœ¨ï¼Œå¹¶åŒ…å«æ­£ç¡®æ ¼å¼çš„PNGæ–‡ä»¶å');
                console.log('ğŸ“ æ ¹æ®ä½ çš„Cloudinary URLï¼Œimage_list.txt å†…å®¹åº”è¯¥æ˜¯:');
                console.log('   fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png');
                console.log('   b7d2da36-4d32-41ae-b9b7-e1be90cc1c49.png');
                console.log('   022fed74-9510-40e2-bc92-cd237677a4fb.png');
                console.log('   (ç¡®ä¿åŒ…å«å®Œæ•´çš„æ–‡ä»¶åï¼ŒåŒ…æ‹¬ä¸‹åˆ’çº¿å’Œæ•°å­—åç¼€)');
            }
            
            // æ·»åŠ åŸºäºå®é™…URLç»“æ„çš„æµ‹è¯•å‡½æ•°
            window.testCorrectPngUrl = function(filename) {
                const testUrls = [
                    `https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/${filename}`,
                    `https://res.cloudinary.com/dw3huanrk/image/upload/c_fill,w_400,h_300/v1754902800/my_website_images/batch_upload/${filename}`,
                    `https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/${filename}`,
                ];
                
                console.log(`ğŸ§ª Testing PNG file with correct structure: ${filename}`);
                testUrls.forEach((url, index) => {
                    console.log(`  ${index + 1}. Testing: ${url}`);
                    const img = new Image();
                    img.onload = function() {
                        console.log(`  âœ… SUCCESS! URL ${index + 1} works: ${url}`);
                    };
                    img.onerror = function() {
                        console.log(`  âŒ FAILED! URL ${index + 1}: ${url}`);
                    };
                    img.src = url;
                });
            };
            
            console.log('ğŸ”§ å¿«é€Ÿä¿®å¤æŒ‡å—:');
            console.log('1. ç¡®ä¿ image_list.txt åŒ…å«æ­£ç¡®çš„æ–‡ä»¶å');
            console.log('2. åœ¨æ§åˆ¶å°è¿è¡Œ: testCorrectPngUrl("ä½ çš„æ–‡ä»¶å.png")');
            console.log('3. å¦‚æœæˆåŠŸï¼Œå‘Šè¯‰æˆ‘å“ªä¸ªURLæ ¼å¼å·¥ä½œ');
            console.log('4. æˆ–è€…ç›´æ¥ä½¿ç”¨å·¥ä½œçš„URLæ ¼å¼æ›´æ–°é…ç½®');
            
            // æ·»åŠ å¿«é€Ÿä¿®å¤å‡½æ•°
            window.quickFix = function() {
                console.log('ğŸš€ Quick Fix - æ‰‹åŠ¨è®¾ç½®URLæ ¼å¼:');
                console.log('å¦‚æœä½ çŸ¥é“ä¸€ä¸ªå·¥ä½œçš„URLï¼Œä½¿ç”¨ä»¥ä¸‹æ ¼å¼:');
                console.log('1. å¤åˆ¶ä¸€ä¸ªå·¥ä½œçš„Cloudinary URL');
                console.log('2. åœ¨æ§åˆ¶å°è¿è¡Œ: setWorkingUrlPattern("ä½ çš„å·¥ä½œURL")');
                console.log('3. ç„¶åé‡æ–°åŠ è½½å›¾ç‰‡åº“');
            };
            
            window.setWorkingUrlPattern = function(workingUrl) {
                console.log('ğŸ“ åˆ†æå·¥ä½œçš„URLæ¨¡å¼:', workingUrl);
                
                // æå–URLç»„ä»¶
                const urlParts = workingUrl.match(/https:\/\/res\.cloudinary\.com\/([^\/]+)\/image\/upload\/(.+)/);
                if (urlParts) {
                    const pathPart = urlParts[2];
                    console.log('ğŸ“‹ æå–çš„è·¯å¾„éƒ¨åˆ†:', pathPart);
                    console.log('ğŸ’¡ è¯·æ›´æ–°é…ç½®ä»¥åŒ¹é…è¿™ä¸ªæ¨¡å¼');
                    
                    // è‡ªåŠ¨å°è¯•åº”ç”¨è¿™ä¸ªæ¨¡å¼
                    const segments = pathPart.split('/');
                    console.log('ğŸ” URLæ®µè½:', segments);
                    
                    if (segments.length >= 3) {
                        const version = segments.find(s => s.startsWith('v'));
                        const folder = segments.filter(s => !s.startsWith('v') && !s.includes('.png') && !s.startsWith('c_') && !s.startsWith('w_') && !s.startsWith('f_')).join('/');
                        
                        console.log('ğŸ·ï¸ æ£€æµ‹åˆ°ç‰ˆæœ¬:', version || 'æ— ');
                        console.log('ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å¤¹:', folder || 'æ— ');
                    }
                } else {
                    console.log('âŒ æ— æ³•è§£æURLæ ¼å¼');
                }
            };
            
            console.log('ğŸ’¡ å¿«é€Ÿä¿®å¤å‘½ä»¤:');
            console.log('   quickFix() - æ˜¾ç¤ºå¿«é€Ÿä¿®å¤æŒ‡å—');
            console.log('   setWorkingUrlPattern("URL") - åˆ†æå·¥ä½œçš„URLæ¨¡å¼');
        });
    </script>
</body>
</html>

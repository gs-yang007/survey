<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>街景行为问卷调研 - 修复版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 调试面板 -->
    <div id="debugPanel" class="debug-panel">
        <div>🔧 调试信息</div>
        <div id="debugLog"></div>
        <button onclick="toggleDebug()" style="background: #333; color: #fff; border: none; padding: 2px 5px; margin-top: 5px;">隐藏</button>
    </div>

    <!-- 语言选择页面 -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">街景行为感知问卷</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">语言选择</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    中文
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
            
            <!-- 测试按钮 -->
            <div class="mt-6 pt-4 border-t">
                <button onclick="testImageLoading()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 mr-2">
                    🧪 测试图片加载
                </button>
                <button onclick="createSampleImageList()" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                    📝 创建示例图片列表
                </button>
            </div>
        </div>
    </div>

    <!-- 基础信息收集页面 -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-2xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">窗景感知问卷：第一部分</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="space-y-6">
                    <!-- 性别选择 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">您的性别是：</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">男</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">女</span>
                            </label>
                        </div>
                    </div>

                    <!-- 年龄输入 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">您的年龄：</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- 专业背景 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">您来自城市规划/建筑/风景园林相关专业吗？</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">是</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">否</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        下一部分
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片对比页面 -->
    <div id="comparisonPage" class="hidden min-h-screen bg-green-500 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="text-right text-white mb-4">
                <span id="progressCounter">1/20</span>
            </div>
            
            <h1 id="compareTitle" class="text-white text-xl font-medium text-center mb-6">
                以下两张街景中，您认为哪张更加适合"坐"的行为：
            </h1>
            
            <div class="flex justify-between items-start">
                <!-- 左侧提示 -->
                <div class="w-48 bg-white rounded-lg p-4 mr-4">
                    <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">提示</h3>
                    <p id="instructions" class="text-sm text-gray-600">
                        在此调研中，您需要在成对的图片中做出选择。请根据您的直觉选择您认为更加适合进行指定活动的街景。
                    </p>
                </div>
                
                <!-- 图片对比区域 -->
                <div class="flex-1 space-y-4">
                    <div id="imageA" class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <img id="imageA_img" src="" alt="" class="w-full h-64 object-cover rounded">
                        <div class="text-center mt-2 flex justify-end">
                            <div id="radioA" class="w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors" onclick="selectOption('A')"></div>
                        </div>
                    </div>
                    
                    <div id="imageB" class="bg-white rounded-lg p-4 hover:shadow-lg transition-shadow">
                        <img id="imageB_img" src="" alt="" class="w-full h-64 object-cover rounded">
                        <div class="text-center mt-2 flex justify-end">
                            <div id="radioB" class="w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors" onclick="selectOption('B')"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧确认按钮 -->
                <div class="w-32 ml-4">
                    <button id="confirmButton" onclick="confirmSelection()" disabled class="w-full bg-gray-400 text-white py-3 rounded-lg transition-colors font-medium cursor-not-allowed">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 结果页面 -->
    <div id="resultsPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-4xl mx-auto">
            <h1 id="resultsTitle" class="text-3xl font-bold text-center text-gray-800 mb-8">调研结果</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h2 id="rankingTitle" class="text-xl font-semibold mb-4">图片排名情况：</h2>
                <div id="rankingList" class="space-y-4">
                    <!-- 排名列表将由JavaScript生成 -->
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-semibold mb-4">用户信息</h2>
                <div id="userInfo" class="grid grid-cols-3 gap-4 text-sm">
                    <!-- 用户信息将由JavaScript生成 -->
                </div>
            </div>
            
            <div class="text-center mt-8">
                <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    重新开始
                </button>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // 配置和全局变量
        // ====================================================================
        const DEBUG_MODE = true;
        let debugVisible = true;
        
        // 多种图片源配置
        const IMAGE_SOURCES = {
            // 原始Cloudinary配置
            cloudinary: {
                cloudName: 'dw3huanrk',
                folderName: 'my_website_images/batch_upload',
                versionNumber: 'v1754902800'
            },
            
            // 备用图片服务
            placeholder: {
                service: 'picsum',
                baseUrl: 'https://picsum.photos'
            },
            
            // 本地图片（如果有的话）
            local: {
                folder: './images/'
            }
        };

        // 示例图片列表（作为后备）
        const DEMO_IMAGES = [
            'street_scene_01.jpg',
            'street_scene_02.jpg', 
            'street_scene_03.jpg',
            'street_scene_04.jpg',
            'street_scene_05.jpg',
            'urban_view_01.jpg',
            'urban_view_02.jpg',
            'park_bench_01.jpg',
            'plaza_seating.jpg',
            'outdoor_cafe.jpg'
        ];

        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let imageRankings = {};
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;

        // ====================================================================
        // 调试和诊断函数
        // ====================================================================
        function debugLog(message) {
            if (DEBUG_MODE) {
                console.log(message);
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<div>' + message + '</div>';
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            debugVisible = !debugVisible;
            panel.style.display = debugVisible ? 'block' : 'none';
        }

        // 测试图片加载功能
        function testImageLoading() {
            debugLog('🧪 开始测试图片加载...');
            
            const testUrls = [
                // Cloudinary格式测试
                'https://res.cloudinary.com/dw3huanrk/image/upload/v1754902800/my_website_images/batch_upload/street_scene_01.jpg',
                'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/street_scene_01.jpg',
                
                // Picsum占位图测试
                'https://picsum.photos/400/300?random=1',
                'https://picsum.photos/400/300?random=2',
                
                // 建筑/街景主题测试
                'https://images.unsplash.com/photo-1518553978-3c0556a9fab8?w=400&h=300&fit=crop',
            ];

            testUrls.forEach((url, index) => {
                debugLog(`测试URL ${index + 1}: ${url.substring(0, 50)}...`);
                
                const img = new Image();
                img.onload = function() {
                    debugLog(`✅ URL ${index + 1} 成功加载`);
                };
                img.onerror = function() {
                    debugLog(`❌ URL ${index + 1} 加载失败`);
                };
                img.src = url;
            });
        }

        // 创建示例图片列表文件内容
        function createSampleImageList() {
            const content = DEMO_IMAGES.join('\n');
            
            // 创建并下载文件
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image_list.txt';
            a.click();
            URL.revokeObjectURL(url);
            
            debugLog('📝 已生成示例图片列表文件，请下载并放置在HTML文件同目录下');
            alert('已生成示例图片列表文件 image_list.txt，请下载并放置在HTML文件同目录下');
        }

        // ====================================================================
        // 图片URL构建函数
        // ====================================================================
        function buildImageUrl(filename, source = 'placeholder') {
            switch(source) {
                case 'cloudinary':
                    return `https://res.cloudinary.com/${IMAGE_SOURCES.cloudinary.cloudName}/image/upload/${IMAGE_SOURCES.cloudinary.versionNumber}/${IMAGE_SOURCES.cloudinary.folderName}/${filename}`;
                
                case 'placeholder':
                    // 使用Picsum作为占位图
                    const id = Math.abs(hashCode(filename)) % 1000;
                    return `https://picsum.photos/seed/${id}/600/400`;
                
                case 'unsplash':
                    // 使用Unsplash相关主题图片
                    const keywords = ['street', 'urban', 'architecture', 'city', 'building'];
                    const keyword = keywords[Math.abs(hashCode(filename)) % keywords.length];
                    return `https://source.unsplash.com/600x400/?${keyword}&sig=${Math.abs(hashCode(filename))}`;
                
                default:
                    return IMAGE_SOURCES.placeholder.baseUrl + '/600/400?random=' + Math.abs(hashCode(filename));
            }
        }

        // 简单哈希函数
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // 图片库初始化
        // ====================================================================
        async function initializeImageLibrary() {
            debugLog('🚀 初始化图片库...');
            
            // 尝试从文件加载
            let filenames = await loadImageNamesFromFile();
            
            // 如果文件加载失败，使用演示图片
            if (!filenames || filenames.length === 0) {
                debugLog('📁 文件加载失败，使用演示图片列表');
                filenames = DEMO_IMAGES;
            }
            
            // 构建图片库
            imageLibrary = filenames.map((filename, index) => ({
                id: index + 1,
                name: filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, ''),
                filename: filename,
                // 提供多种图片源作为后备
                urls: {
                    cloudinary: buildImageUrl(filename, 'cloudinary'),
                    placeholder: buildImageUrl(filename, 'placeholder'),
                    unsplash: buildImageUrl(filename, 'unsplash')
                }
            }));
            
            // 随机选择用于对比的图片（最多20张）
            const maxImages = Math.min(20, imageLibrary.length);
            imageLibrary = imageLibrary.sort(() => 0.5 - Math.random()).slice(0, maxImages);
            
            isImageLibraryLoaded = true;
            debugLog(`✅ 图片库初始化完成，共 ${imageLibrary.length} 张图片`);
            
            // 测试第一张图片的加载
            if (imageLibrary.length > 0) {
                testFirstImage();
            }
        }

        async function loadImageNamesFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('文件不存在');
                
                const text = await response.text();
                const filenames = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'));
                
                debugLog(`📋 从文件加载了 ${filenames.length} 个图片名称`);
                return filenames;
            } catch (error) {
                debugLog(`❌ 加载图片列表文件失败: ${error.message}`);
                return null;
            }
        }

        function testFirstImage() {
            const testImage = imageLibrary[0];
            debugLog(`🧪 测试第一张图片: ${testImage.filename}`);
            
            // 依次测试不同的图片源
            const sources = ['cloudinary', 'placeholder', 'unsplash'];
            let sourceIndex = 0;
            
            function tryNextSource() {
                if (sourceIndex >= sources.length) {
                    debugLog('❌ 所有图片源都无法加载');
                    return;
                }
                
                const source = sources[sourceIndex];
                const url = testImage.urls[source];
                debugLog(`🔄 测试 ${source} 源: ${url.substring(0, 50)}...`);
                
                const img = new Image();
                img.onload = function() {
                    debugLog(`✅ ${source} 源加载成功！`);
                    // 设置这个源为首选源
                    imageLibrary.forEach(img => img.primaryUrl = img.urls[source]);
                };
                img.onerror = function() {
                    debugLog(`❌ ${source} 源加载失败`);
                    sourceIndex++;
                    tryNextSource();
                };
                img.src = url;
            }
            
            tryNextSource();
        }

        // ====================================================================
        // 图片加载函数（带容错机制）
        // ====================================================================
        function loadImageWithFallback(imgElement, imageData, callback) {
            const sources = ['cloudinary', 'placeholder', 'unsplash'];
            let currentIndex = 0;
            
            function tryLoad() {
                if (currentIndex >= sources.length) {
                    debugLog(`❌ 图片 ${imageData.filename} 所有源都无法加载`);
                    // 显示错误占位图
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aaguaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                    return;
                }
                
                const source = sources[currentIndex];
                const url = imageData.urls[source];
                
                imgElement.onload = function() {
                    debugLog(`✅ 图片 ${imageData.filename} 通过 ${source} 源加载成功`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    debugLog(`❌ 图片 ${imageData.filename} 的 ${source} 源失败，尝试下一个`);
                    currentIndex++;
                    tryLoad();
                };
                
                imgElement.src = url;
            }
            
            tryLoad();
        }

        // ====================================================================
        // 问卷逻辑
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: '街景感知问卷：第一部分',
                genderLabel: '您的性别是：',
                maleLabel: '男',
                femaleLabel: '女',
                ageLabel: '您的年龄：',
                professionalLabel: '您来自城市规划/建筑/风景园林相关专业吗？',
                yesLabel: '是',
                noLabel: '否',
                nextButton: '下一部分',
                compareTitle: '以下两张街景中，您认为哪张更加适合"坐"的行为：',
                hintTitle: '提示',
                instructions: '在此调研中，您需要在成对的图片中做出选择。请根据您的直觉选择您认为更加适合特定行为的街景。',
                resultsTitle: '调研结果',
                rankingTitle: '图片排名情况：',
                restartButton: '重新开始'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to make choices between pairs of images. Please choose the street view you think is more suitable for certain behaviours based on your intuition.',
                resultsTitle: 'Survey Results',
                rankingTitle: 'Image Rankings:',
                restartButton: 'Start Over'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    element.textContent = t[key];
                }
            });
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'resultsPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            // 验证表单
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');

            if (!gender || !age || !professional) {
                alert(currentLanguage === 'zh' ? '请完整填写所有必填项！' : 'Please fill in all required fields!');
                return;
            }

            userData = {
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            // 确保图片库已加载
            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (imageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? '图片库加载失败或图片数量不足！' : 'Image library failed to load or insufficient images!');
                return;
            }

            initializeRankings();
            generateNewComparison();
            showPage('comparisonPage');
        }

        function initializeRankings() {
            imageRankings = {};
            imageLibrary.forEach(img => {
                imageRankings[img.id] = { score: 1000, wins: 0, losses: 0 };
            });
        }

        function generateNewComparison() {
            const shuffled = [...imageLibrary].sort(() => 0.5 - Math.random());
            currentPair = {
                imageA: shuffled[0],
                imageB: shuffled[1]
            };

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            // 使用容错加载
            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            const totalComparisons = Math.min(20, Math.floor(imageLibrary.length * 1.5));
            document.getElementById('progressCounter').textContent = `${comparisons.length + 1}/${totalComparisons}`;
            
            resetSelection();
        }

        function resetSelection() {
            selectedOption = null;
            
            const radioA = document.getElementById('radioA');
            const radioB = document.getElementById('radioB');
            
            radioA.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioB.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioA.innerHTML = '';
            radioB.innerHTML = '';
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function selectOption(choice) {
            selectedOption = choice;
            
            const radioA = document.getElementById('radioA');
            const radioB = document.getElementById('radioB');
            
            radioA.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioB.className = 'w-6 h-6 border-2 border-gray-300 rounded-full cursor-pointer hover:border-green-500 transition-colors';
            radioA.innerHTML = '';
            radioB.innerHTML = '';
            
            if (choice === 'A') {
                radioA.className = 'w-6 h-6 border-2 border-green-500 bg-green-500 rounded-full cursor-pointer transition-colors';
                radioA.innerHTML = '<div class="w-2 h-2 bg-white rounded-full m-auto mt-1"></div>';
            } else {
                radioB.className = 'w-6 h-6 border-2 border-green-500 bg-green-500 rounded-full cursor-pointer transition-colors';
                radioB.innerHTML = '<div class="w-2 h-2 bg-white rounded-full m-auto mt-1"></div>';
            }
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = false;
            confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
            confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
        }

        function confirmSelection() {
            if (!selectedOption) return;
            
            let winnerId, loserId;
            if (selectedOption === 'A') {
                winnerId = currentPair.imageA.id;
                loserId = currentPair.imageB.id;
            } else {
                winnerId = currentPair.imageB.id;
                loserId = currentPair.imageA.id;
            }

            // 更新排名（简化的ELO算法）
            const K = 32;
            const winnerRating = imageRankings[winnerId].score;
            const loserRating = imageRankings[loserId].score;
            
            const expectedWinner = 1 / (1 + Math.pow(10, (loserRating - winnerRating) / 400));
            
            imageRankings[winnerId].score += K * (1 - expectedWinner);
            imageRankings[loserId].score += K * (0 - expectedWinner);
            imageRankings[winnerId].wins += 1;
            imageRankings[loserId].losses += 1;

            comparisons.push({
                winner: winnerId,
                loser: loserId,
                timestamp: new Date().toISOString()
            });

            const totalComparisons = Math.min(20, Math.floor(imageLibrary.length * 1.5));
            if (comparisons.length >= totalComparisons) {
                showResults();
            } else {
                generateNewComparison();
            }
        }

        function showResults() {
            showPage('resultsPage');
            
            // 生成排名列表
            const sortedImages = imageLibrary
                .map(img => ({
                    ...img,
                    ...imageRankings[img.id]
                }))
                .sort((a, b) => b.score - a.score);

            const rankingHTML = sortedImages.map((img, index) => `
                <div class="flex items-center space-x-4 p-4 border rounded-lg">
                    <div class="text-2xl font-bold text-green-600">#${index + 1}</div>
                    <img src="${img.urls.placeholder}" alt="${img.name}" class="w-20 h-16 object-cover rounded">
                    <div class="flex-1">
                        <h3 class="font-medium">${img.name}</h3>
                        <p class="text-sm text-gray-600">
                            得分: ${Math.round(img.score)} | 胜: ${img.wins} | 负: ${img.losses}
                        </p>
                    </div>
                </div>
            `).join('');

            document.getElementById('rankingList').innerHTML = rankingHTML;

            // 显示用户信息
            const genderText = userData.gender === 'male' ? (currentLanguage === 'zh' ? '男' : 'Male') : (currentLanguage === 'zh' ? '女' : 'Female');
            const professionalText = userData.isProfessional === 'yes' ? (currentLanguage === 'zh' ? '是' : 'Yes') : (currentLanguage === 'zh' ? '否' : 'No');
            
            document.getElementById('userInfo').innerHTML = `
                <div>${currentLanguage === 'zh' ? '性别' : 'Gender'}: ${genderText}</div>
                <div>${currentLanguage === 'zh' ? '年龄' : 'Age'}: ${userData.age}</div>
                <div>${currentLanguage === 'zh' ? '专业背景' : 'Professional'}: ${professionalText}</div>
            `;
        }

        function restart() {
            userData = { gender: '', age: '', isProfessional: '' };
            comparisons = [];
            imageRankings = {};
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            
            // 清空表单
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('ageInput').value = '';
            
            showPage('languagePage');
        }

        // ====================================================================
        // 页面初始化
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('🚀 街景问卷系统启动');
            debugLog('📊 配置信息: 演示模式，内置占位图');
            
            // 预先初始化图片库
            await initializeImageLibrary();
            
            if (isImageLibraryLoaded) {
                debugLog(`✅ 系统就绪，图片库包含 ${imageLibrary.length} 张图片`);
            } else {
                debugLog('⚠️ 图片库初始化有问题，但系统仍可运行');
            }
            
            debugLog('💡 使用说明:');
            debugLog('1. 点击"测试图片加载"检查图片源');
            debugLog('2. 点击"创建示例图片列表"生成配置文件');
            debugLog('3. 问卷使用占位图作为演示');
        });
    </script>
</body>
</html>

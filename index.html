<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—æ™¯è¡Œä¸ºé—®å·è°ƒç ”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .image-container {
            width: 666px;
            height: 500px;
        }
        .survey-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ç®¡ç†å‘˜å…¥å£ -->
    <div class="admin-panel">
        <button onclick="showAdminPanel()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
            ç®¡ç†å‘˜
        </button>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debugPanel" class="debug-panel">
        <div>ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
        <div id="debugLog"></div>
        <button onclick="toggleDebug()" style="background: #333; color: #fff; border: none; padding: 2px 5px; margin-top: 5px;">éšè—</button>
    </div>

    <!-- è¯­è¨€é€‰æ‹©é¡µé¢ -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è¡—æ™¯è¡Œä¸ºæ„ŸçŸ¥é—®å·</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">è¯­è¨€é€‰æ‹©</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ä¸­æ–‡
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯æ”¶é›†é¡µé¢ -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-2xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">çª—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="space-y-6">
                    <!-- æ€§åˆ«é€‰æ‹© -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">æ‚¨çš„æ€§åˆ«æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">ç”·</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">å¥³</span>
                            </label>
                        </div>
                    </div>

                    <!-- å¹´é¾„è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">æ‚¨çš„å¹´é¾„ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- ä¸“ä¸šèƒŒæ™¯ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">æ˜¯</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">å¦</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        ä¸‹ä¸€éƒ¨åˆ†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å¯¹æ¯”é¡µé¢ -->
    <div id="comparisonPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between text-gray-800 mb-4">
                <div>
                    <span id="groupCounter">ç¬¬ 1 ç»„</span>
                </div>
                <div>
                    <span id="progressCounter">1/50</span>
                </div>
            </div>
            
            <!-- é¡¶éƒ¨æç¤º -->
            <div class="bg-white rounded-lg p-4 mb-6">
                <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">æç¤º</h3>
                <p id="instructions" class="text-sm text-gray-600">
                    åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚
                </p>
            </div>
            
            <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <div class="flex justify-center mb-6 space-x-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageALabel" class="font-bold text-gray-800">å›¾ç‰‡ A</span>
                    </div>
                    <div class="image-container">
                        <img id="imageA_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageBLabel" class="font-bold text-gray-800">å›¾ç‰‡ B</span>
                    </div>
                    <div class="image-container">
                        <img id="imageB_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
            </div>
            
            <!-- é—®é¢˜åŒºåŸŸ -->
            <div class="bg-white rounded-lg p-6 mb-6">
                <div class="space-y-6">
                    <!-- é—®é¢˜1ï¼šå -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question1" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜2ï¼šè¡Œèµ° -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question2" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"è¡Œèµ°"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="walking" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜3ï¼šæ…¢è·‘ -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question3" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜4ï¼šé›†åˆ -->
                    <div>
                        <h3 id="question4" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"é›†åˆ"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¡®è®¤æŒ‰é’® -->
            <div class="text-center">
                <button id="confirmButton" onclick="confirmAllSelections()" disabled class="px-8 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed">
                    <span id="confirmButtonText">ç¡®è®¤å¹¶ç»§ç»­</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ç»§ç»­è¯¢é—®é¡µé¢ -->
    <div id="continuePage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="continueTitle" class="text-2xl font-bold text-gray-800 mb-4">æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ</h2>
            <p id="continueMessage" class="text-gray-600 mb-8">æ‚¨å·²å®Œæˆäº†50ç»„å›¾ç‰‡å¯¹æ¯”ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼<br>æ˜¯å¦ç»§ç»­è¿›è¡Œä¸‹ä¸€ç»„å¯¹æ¯”ï¼Ÿ</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="continueNextGroup()" id="continueButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ç»§ç»­ä¸‹ä¸€ç»„
                </button>
                <button onclick="finishSurvey()" id="finishButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    ç»“æŸè°ƒç ”
                </button>
            </div>
        </div>
    </div>

    <!-- æ„Ÿè°¢é¡µé¢ -->
    <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="thankYouTitle" class="text-2xl font-bold text-gray-800 mb-4">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</h2>
            <p id="thankYouMessage" class="text-gray-600 mb-8">æ‚¨çš„æ•°æ®å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼</p>
            
            <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                é‡æ–°å¼€å§‹
            </button>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ç®¡ç†å‘˜é¢æ¿</h2>
                    <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800">æ€»å‚ä¸äººæ•°</h3>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">æ€»å¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="totalComparisons" class="text-2xl font-bold text-green-600">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800">å¹³å‡æ¯äººå¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="avgGroups" class="text-2xl font-bold text-purple-600">0</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-6">
                    <button onclick="exportData()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        å¯¼å‡ºæ•°æ®
                    </button>
                    <button onclick="clearData()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        æ¸…ç©ºæ•°æ®
                    </button>
                    <button onclick="refreshStats()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">åˆ†è¡Œä¸ºå›¾ç‰‡æ’åç»Ÿè®¡</h3>
                    
                    <!-- è¡Œä¸ºæ ‡ç­¾é¡µ -->
                    <div class="flex space-x-1 mb-4 border-b">
                        <button onclick="showBehaviorTab('sitting')" id="tab-sitting" class="px-4 py-2 text-sm font-medium bg-blue-500 text-white rounded-t">
                            å
                        </button>
                        <button onclick="showBehaviorTab('walking')" id="tab-walking" class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-t hover:bg-gray-300">
                            è¡Œèµ°
                        </button>
                        <button onclick="showBehaviorTab('jogging')" id="tab-jogging" class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-t hover:bg-gray-300">
                            æ…¢è·‘
                        </button>
                        <button onclick="showBehaviorTab('gathering')" id="tab-gathering" class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-t hover:bg-gray-300">
                            é›†åˆ
                        </button>
                        <button onclick="showBehaviorTab('overall')" id="tab-overall" class="px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-t hover:bg-gray-300">
                            ç»¼åˆæ’å
                        </button>
                    </div>
                    
                    <!-- å„è¡Œä¸ºçš„æ’åæ˜¾ç¤ºåŒºåŸŸ -->
                    <div id="behaviorRankings" class="overflow-auto max-h-96">
                        <!-- è¡Œä¸ºæ’åå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">ç”¨æˆ·è¯¦æƒ…</h3>
                    <div id="userDetails" class="overflow-auto max-h-64">
                        <!-- ç”¨æˆ·è¯¦æƒ…å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // é…ç½®å’Œå…¨å±€å˜é‡
        // ====================================================================
        const DEBUG_MODE = false; // å…³é—­è°ƒè¯•æ¨¡å¼
        let debugVisible = false;
        let currentBehaviorTab = 'sitting'; // å½“å‰é€‰ä¸­çš„è¡Œä¸ºæ ‡ç­¾

        // ç¤ºä¾‹å›¾ç‰‡URLåˆ—è¡¨
        const DEMO_IMAGES = [
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff11158-a3d5-4e96-9c02-92dd8a42566a_5344.png'
        ];

        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let imageRankings = {};
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;
        let comparisonPairs = [];
        let currentComparisonIndex = 0;
        let currentGroupNumber = 1;
        let sessionId = generateSessionId();
        let preloadedImages = new Map(); // å­˜å‚¨é¢„åŠ è½½çš„å›¾ç‰‡

        // ====================================================================
        // æ•°æ®å­˜å‚¨ç®¡ç†
        // ====================================================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveUserSession() {
            const sessions = JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
            
            const sessionData = {
                sessionId: sessionId,
                userData: userData,
                groupsCompleted: currentGroupNumber - 1,
                totalComparisons: comparisons.length,
                comparisons: comparisons,
                timestamp: new Date().toISOString(),
                language: currentLanguage
            };
            
            sessions.push(sessionData);
            localStorage.setItem('surveySessionsData', JSON.stringify(sessions));
            
            // æ›´æ–°ç´¯è®¡ç»Ÿè®¡
            updateCumulativeStats(sessionData);
            
            debugLog(`ğŸ’¾ ç”¨æˆ·ä¼šè¯å·²ä¿å­˜: ${sessionId}`);
        }

        function updateCumulativeStats(sessionData) {
            let stats = JSON.parse(localStorage.getItem('surveyCumulativeStats') || '{}');
            
            // åˆå§‹åŒ–ç»Ÿè®¡ç»“æ„
            if (!stats.imageWinCounts) stats.imageWinCounts = {};
            if (!stats.imageLossCounts) stats.imageLossCounts = {};
            if (!stats.imageRankings) stats.imageRankings = {};
            if (!stats.behaviorStats) stats.behaviorStats = {};
            if (!stats.totalUsers) stats.totalUsers = 0;
            if (!stats.totalComparisons) stats.totalComparisons = 0;
            if (!stats.userDemographics) stats.userDemographics = { male: 0, female: 0, professional: 0, nonProfessional: 0 };
            
            // æ›´æ–°åŸºç¡€ç»Ÿè®¡
            stats.totalUsers += 1;
            stats.totalComparisons += sessionData.comparisons.length;
            
            // æ›´æ–°äººå£ç»Ÿè®¡
            if (sessionData.userData.gender === 'male') stats.userDemographics.male += 1;
            if (sessionData.userData.gender === 'female') stats.userDemographics.female += 1;
            if (sessionData.userData.isProfessional === 'yes') stats.userDemographics.professional += 1;
            if (sessionData.userData.isProfessional === 'no') stats.userDemographics.nonProfessional += 1;
            
            // æ›´æ–°å›¾ç‰‡èƒœè´Ÿç»Ÿè®¡å’Œè¡Œä¸ºç»Ÿè®¡
            sessionData.comparisons.forEach(comparison => {
                // å¤„ç†æ¯ä¸ªè¡Œä¸ºçš„ç­”æ¡ˆ
                Object.entries(comparison.answers).forEach(([behaviorKey, answer]) => {
                    const behavior = answer.behavior;
                    const winnerId = answer.winner;
                    const loserId = answer.loser;
                    
                    // æ›´æ–°æ€»ä½“å›¾ç‰‡ç»Ÿè®¡
                    if (!stats.imageWinCounts[winnerId]) stats.imageWinCounts[winnerId] = 0;
                    if (!stats.imageLossCounts[winnerId]) stats.imageLossCounts[winnerId] = 0;
                    if (!stats.imageWinCounts[loserId]) stats.imageWinCounts[loserId] = 0;
                    if (!stats.imageLossCounts[loserId]) stats.imageLossCounts[loserId] = 0;
                    
                    stats.imageWinCounts[winnerId] += 1;
                    stats.imageLossCounts[loserId] += 1;
                    
                    // æ›´æ–°æŒ‰è¡Œä¸ºåˆ†ç±»çš„ç»Ÿè®¡
                    if (!stats.behaviorStats[behavior]) {
                        stats.behaviorStats[behavior] = {
                            imageWinCounts: {},
                            imageLossCounts: {},
                            imageRankings: {},
                            totalComparisons: 0
                        };
                    }
                    
                    if (!stats.behaviorStats[behavior].imageWinCounts[winnerId]) {
                        stats.behaviorStats[behavior].imageWinCounts[winnerId] = 0;
                    }
                    if (!stats.behaviorStats[behavior].imageLossCounts[loserId]) {
                        stats.behaviorStats[behavior].imageLossCounts[loserId] = 0;
                    }
                    if (!stats.behaviorStats[behavior].imageLossCounts[winnerId]) {
                        stats.behaviorStats[behavior].imageLossCounts[winnerId] = 0;
                    }
                    if (!stats.behaviorStats[behavior].imageWinCounts[loserId]) {
                        stats.behaviorStats[behavior].imageWinCounts[loserId] = 0;
                    }
                    
                    stats.behaviorStats[behavior].imageWinCounts[winnerId] += 1;
                    stats.behaviorStats[behavior].imageLossCounts[loserId] += 1;
                    stats.behaviorStats[behavior].totalComparisons += 1;
                });
            });
            
            // é‡æ–°è®¡ç®—æ¯ä¸ªè¡Œä¸ºçš„å›¾ç‰‡æ’ååˆ†æ•°
            Object.keys(stats.behaviorStats).forEach(behavior => {
                const behaviorData = stats.behaviorStats[behavior];
                const allImageIds = new Set([
                    ...Object.keys(behaviorData.imageWinCounts),
                    ...Object.keys(behaviorData.imageLossCounts)
                ]);
                
                allImageIds.forEach(imageId => {
                    const wins = behaviorData.imageWinCounts[imageId] || 0;
                    const losses = behaviorData.imageLossCounts[imageId] || 0;
                    const total = wins + losses;
                    
                    // ä½¿ç”¨èƒœç‡è®¡ç®—åˆ†æ•°ï¼ŒåŠ ä¸Šå¹³æ»‘å› å­é¿å…æç«¯å€¼
                    const winRate = total > 0 ? wins / total : 0.5;
                    const score = winRate * 1000 + (wins - losses);
                    
                    if (!behaviorData.imageRankings) behaviorData.imageRankings = {};
                    behaviorData.imageRankings[imageId] = {
                        score: score,
                        wins: wins,
                        losses: losses,
                        total: total,
                        winRate: winRate
                    };
                });
            });
            
            // é‡æ–°è®¡ç®—æ‰€æœ‰å›¾ç‰‡çš„ç»¼åˆæ’ååˆ†æ•°
            Object.keys(stats.imageWinCounts).forEach(imageId => {
                const wins = stats.imageWinCounts[imageId] || 0;
                const losses = stats.imageLossCounts[imageId] || 0;
                const total = wins + losses;
                
                // ä½¿ç”¨èƒœç‡è®¡ç®—åˆ†æ•°ï¼ŒåŠ ä¸Šå¹³æ»‘å› å­é¿å…æç«¯å€¼
                const winRate = total > 0 ? wins / total : 0.5;
                const score = winRate * 1000 + (wins - losses);
                
                stats.imageRankings[imageId] = {
                    score: score,
                    wins: wins,
                    losses: losses,
                    total: total,
                    winRate: winRate
                };
            });
            
            stats.lastUpdated = new Date().toISOString();
            localStorage.setItem('surveyCumulativeStats', JSON.stringify(stats));
            
            debugLog(`ğŸ“Š ç´¯è®¡ç»Ÿè®¡å·²æ›´æ–°`);
        }

        function getCumulativeStats() {
            return JSON.parse(localStorage.getItem('surveyCumulativeStats') || '{}');
        }

        function getAllSessions() {
            return JSON.parse(localStorage.getItem('surveySessionsData') || '[]');
        }

        // ====================================================================
        // è°ƒè¯•å’Œè¯Šæ–­å‡½æ•°
        // ====================================================================
        function debugLog(message) {
            if (DEBUG_MODE) {
                console.log(message);
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<div>' + message + '</div>';
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            debugVisible = !debugVisible;
            panel.style.display = debugVisible ? 'block' : 'none';
        }

        // ====================================================================
        // URLå¤„ç†å‡½æ•°
        // ====================================================================
        function extractImageName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1];
            return filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        }

        function buildFallbackUrl(originalUrl) {
            const hash = hashCode(originalUrl);
            const id = Math.abs(hash) % 1000;
            return `https://picsum.photos/seed/${id}/666/500`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // å›¾ç‰‡åº“åˆå§‹åŒ–
        // ====================================================================
        async function initializeImageLibrary() {
            debugLog('ğŸš€ åˆå§‹åŒ–å›¾ç‰‡åº“...');
            
            let imageUrls = await loadImageUrlsFromFile();
            
            if (!imageUrls || imageUrls.length === 0) {
                debugLog('ğŸ“ æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºå›¾ç‰‡åˆ—è¡¨');
                imageUrls = DEMO_IMAGES;
            }
            
            imageLibrary = imageUrls.map((url, index) => ({
                id: index + 1,
                name: extractImageName(url),
                url: url.trim(),
                fallbackUrl: buildFallbackUrl(url)
            }));
            
            // ç¡®ä¿æœ‰è¶³å¤Ÿçš„å›¾ç‰‡è¿›è¡Œ50ç»„å¯¹æ¯”
            // éœ€è¦50å¼ å›¾ç‰‡ï¼Œæ¯å¼ å‡ºç°2æ¬¡ = 100æ¬¡å‡ºç° = 50å¯¹æ¯”
            const minImagesNeeded = 50; // 50å¼ å›¾ç‰‡æ¯å¼ å‡ºç°2æ¬¡ = 100æ¬¡å‡ºç° = 50å¯¹æ¯”
            
            if (imageLibrary.length < minImagesNeeded) {
                debugLog(`âš ï¸ å›¾ç‰‡æ•°é‡ä¸è¶³(${imageLibrary.length}å¼ )ï¼Œéœ€è¦è‡³å°‘${minImagesNeeded}å¼ `);
                // é‡å¤å›¾ç‰‡åº“ç›´åˆ°è¾¾åˆ°æœ€å°‘è¦æ±‚
                const originalLibrary = [...imageLibrary];
                while (imageLibrary.length < minImagesNeeded) {
                    imageLibrary.push(...originalLibrary);
                }
                // æˆªå–åˆ°æ°å¥½50å¼ 
                imageLibrary = imageLibrary.slice(0, minImagesNeeded);
                debugLog(`âœ… å·²è°ƒæ•´å›¾ç‰‡åº“åˆ°${imageLibrary.length}å¼ å›¾ç‰‡`);
            } else {
                // éšæœºé€‰æ‹©50å¼ å›¾ç‰‡ç”¨äºå¯¹æ¯”
                imageLibrary = imageLibrary.sort(() => 0.5 - Math.random()).slice(0, minImagesNeeded);
            }
            
            isImageLibraryLoaded = true;
            debugLog(`âœ… å›¾ç‰‡åº“åˆå§‹åŒ–å®Œæˆï¼Œå…± ${imageLibrary.length} å¼ å›¾ç‰‡ï¼Œæ¯ç»„å°†äº§ç”Ÿ ${Math.floor(imageLibrary.length)} å¯¹æ¯”`);
        }

        async function loadImageUrlsFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
                
                const text = await response.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'))
                    .filter(line => line.startsWith('http'));
                
                debugLog(`ğŸ“‹ ä»æ–‡ä»¶åŠ è½½äº† ${urls.length} ä¸ªå›¾ç‰‡URL`);
                return urls;
            } catch (error) {
                debugLog(`âŒ åŠ è½½å›¾ç‰‡åˆ—è¡¨æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return null;
            }
        }

        function loadImageWithFallback(imgElement, imageData, callback) {
            debugLog(`ğŸ–¼ï¸ åŠ è½½å›¾ç‰‡: ${imageData.name}`);
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰é¢„åŠ è½½çš„å›¾ç‰‡
            const preloadedImageKey = `${imageData.id}_${imageData.url}`;
            if (preloadedImages.has(preloadedImageKey)) {
                const preloadedImg = preloadedImages.get(preloadedImageKey);
                if (preloadedImg.complete && preloadedImg.naturalHeight !== 0) {
                    debugLog(`âœ… ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡: ${imageData.name}`);
                    imgElement.src = preloadedImg.src;
                    if (callback) callback(true);
                    return;
                }
            }
            
            imgElement.onload = function() {
                debugLog(`âœ… å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½æˆåŠŸ`);
                if (callback) callback(true);
            };
            
            imgElement.onerror = function() {
                debugLog(`âŒ å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨å›¾ç‰‡`);
                
                imgElement.onload = function() {
                    debugLog(`âœ… å›¾ç‰‡ ${imageData.name} é€šè¿‡å¤‡ç”¨æºåŠ è½½æˆåŠŸ`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    debugLog(`âŒ å›¾ç‰‡ ${imageData.name} æ‰€æœ‰æºéƒ½æ— æ³•åŠ è½½`);
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aaguaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                };
                
                imgElement.src = imageData.fallbackUrl;
            };
            
            imgElement.src = imageData.url;
        }

        // é¢„åŠ è½½å›¾ç‰‡å‡½æ•°
        function preloadImage(imageData) {
            return new Promise((resolve) => {
                const preloadedImageKey = `${imageData.id}_${imageData.url}`;
                
                // å¦‚æœå·²ç»é¢„åŠ è½½è¿‡ï¼Œç›´æ¥è¿”å›
                if (preloadedImages.has(preloadedImageKey)) {
                    resolve(preloadedImages.get(preloadedImageKey));
                    return;
                }
                
                const img = new Image();
                
                img.onload = function() {
                    debugLog(`ğŸš€ é¢„åŠ è½½æˆåŠŸ: ${imageData.name}`);
                    preloadedImages.set(preloadedImageKey, img);
                    resolve(img);
                };
                
                img.onerror = function() {
                    debugLog(`âŒ é¢„åŠ è½½åŸå§‹URLå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL: ${imageData.name}`);
                    
                    // å°è¯•å¤‡ç”¨URL
                    const fallbackImg = new Image();
                    fallbackImg.onload = function() {
                        debugLog(`ğŸš€ é¢„åŠ è½½å¤‡ç”¨URLæˆåŠŸ: ${imageData.name}`);
                        preloadedImages.set(preloadedImageKey, fallbackImg);
                        resolve(fallbackImg);
                    };
                    
                    fallbackImg.onerror = function() {
                        debugLog(`âŒ é¢„åŠ è½½æ‰€æœ‰URLéƒ½å¤±è´¥: ${imageData.name}`);
                        resolve(null);
                    };
                    
                    fallbackImg.src = imageData.fallbackUrl;
                };
                
                img.src = imageData.url;
            });
        }

        // é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡
        function preloadNextPair() {
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                debugLog(`ğŸ”„ å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡ (${nextIndex + 1}/${comparisonPairs.length})`);
                
                // åŒæ—¶é¢„åŠ è½½ä¸¤å¼ å›¾ç‰‡
                Promise.all([
                    preloadImage(nextPair.imageA),
                    preloadImage(nextPair.imageB)
                ]).then(() => {
                    debugLog(`âœ… ä¸‹ä¸€å¯¹å›¾ç‰‡é¢„åŠ è½½å®Œæˆ`);
                }).catch((error) => {
                    debugLog(`âŒ é¢„åŠ è½½å¤±è´¥: ${error}`);
                });
            }
        }

        // æ¸…ç†é¢„åŠ è½½ç¼“å­˜ï¼ˆé¿å…å†…å­˜å ç”¨è¿‡å¤šï¼‰
        function cleanupPreloadCache() {
            // åªä¿ç•™å½“å‰å’Œä¸‹ä¸€å¯¹çš„é¢„åŠ è½½å›¾ç‰‡
            const keepKeys = new Set();
            
            if (currentComparisonIndex < comparisonPairs.length) {
                const currentPair = comparisonPairs[currentComparisonIndex];
                keepKeys.add(`${currentPair.imageA.id}_${currentPair.imageA.url}`);
                keepKeys.add(`${currentPair.imageB.id}_${currentPair.imageB.url}`);
            }
            
            if (currentComparisonIndex + 1 < comparisonPairs.length) {
                const nextPair = comparisonPairs[currentComparisonIndex + 1];
                keepKeys.add(`${nextPair.imageA.id}_${nextPair.imageA.url}`);
                keepKeys.add(`${nextPair.imageB.id}_${nextPair.imageB.url}`);
            }
            
            // åˆ é™¤ä¸éœ€è¦çš„é¢„åŠ è½½å›¾ç‰‡
            for (const key of preloadedImages.keys()) {
                if (!keepKeys.has(key)) {
                    preloadedImages.delete(key);
                }
            }
        }

        // ====================================================================
        // é—®å·é€»è¾‘
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: 'è¡—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†',
                genderLabel: 'æ‚¨çš„æ€§åˆ«æ˜¯ï¼š',
                maleLabel: 'ç”·',
                femaleLabel: 'å¥³',
                ageLabel: 'æ‚¨çš„å¹´é¾„ï¼š',
                professionalLabel: 'æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ',
                yesLabel: 'æ˜¯',
                noLabel: 'å¦',
                nextButton: 'ä¸‹ä¸€éƒ¨åˆ†',
                compareTitle: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š',
                hintTitle: 'æç¤º',
                instructions: 'åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚',
                continueTitle: 'æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ',
                continueMessage: 'æ‚¨å·²å®Œæˆäº†50ç»„å›¾ç‰‡å¯¹æ¯”ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼<br>æ˜¯å¦ç»§ç»­è¿›è¡Œä¸‹ä¸€ç»„å¯¹æ¯”ï¼Ÿ',
                continueButton: 'ç»§ç»­ä¸‹ä¸€ç»„',
                finishButton: 'ç»“æŸè°ƒç ”',
                thankYouTitle: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼',
                thankYouMessage: 'æ‚¨çš„æ•°æ®å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼',
                restartButton: 'é‡æ–°å¼€å§‹',
                // å›¾ç‰‡å’Œé€‰é¡¹æ ‡ç­¾
                imageALabel: 'å›¾ç‰‡ A',
                imageBLabel: 'å›¾ç‰‡ B',
                optionA: 'å›¾ç‰‡ A',
                optionB: 'å›¾ç‰‡ B',
                // å››ä¸ªé—®é¢˜
                question1: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š',
                question2: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"è¡Œèµ°"çš„è¡Œä¸ºï¼š',
                question3: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š',
                question4: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"é›†åˆ"çš„è¡Œä¸ºï¼š',
                confirmButtonText: 'ç¡®è®¤å¹¶ç»§ç»­'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to answer four different behavioral questions for each pair of images. Please choose the street view you think is more suitable for various activities based on your intuition. All questions must be answered before proceeding to the next pair of images.',
                continueTitle: 'Group Comparison Completed',
                continueMessage: 'You have completed 50 image comparisons, thank you for your participation!<br>Would you like to continue with the next group?',
                continueButton: 'Continue Next Group',
                finishButton: 'Finish Survey',
                thankYouTitle: 'Thank You for Your Participation!',
                thankYouMessage: 'Your data has been successfully submitted. Thank you for contributing to street view perception research!',
                restartButton: 'Start Over',
                // å›¾ç‰‡å’Œé€‰é¡¹æ ‡ç­¾
                imageALabel: 'Image A',
                imageBLabel: 'Image B',
                optionA: 'Image A',
                optionB: 'Image B',
                // å››ä¸ªé—®é¢˜
                question1: 'Which of the following two street views do you think is more suitable for "sitting":',
                question2: 'Which of the following two street views do you think is more suitable for "walking":',
                question3: 'Which of the following two street views do you think is more suitable for "jogging":',
                question4: 'Which of the following two street views do you think is more suitable for "gathering":',
                confirmButtonText: 'Confirm and Continue'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            
            // æ›´æ–°åŸºç¡€æ–‡æœ¬å…ƒç´ 
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'continueMessage' || key === 'thankYouMessage') {
                        element.innerHTML = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            // æ›´æ–°é€‰é¡¹æ–‡å­—ï¼ˆä½¿ç”¨ç±»é€‰æ‹©å™¨ï¼‰
            const optionAElements = document.querySelectorAll('.optionA');
            const optionBElements = document.querySelectorAll('.optionB');
            
            optionAElements.forEach(element => {
                element.textContent = t.optionA;
            });
            
            optionBElements.forEach(element => {
                element.textContent = t.optionB;
            });
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'continuePage', 'thankYouPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');

            if (!gender || !age || !professional) {
                alert(currentLanguage === 'zh' ? 'è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼' : 'Please fill in all required fields!');
                return;
            }

            userData = {
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (imageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? 'å›¾ç‰‡åº“åŠ è½½å¤±è´¥æˆ–å›¾ç‰‡æ•°é‡ä¸è¶³ï¼' : 'Image library failed to load or insufficient images!');
                return;
            }

            startNewGroup();
        }

        function startNewGroup() {
            // æ¸…ç©ºé¢„åŠ è½½ç¼“å­˜
            preloadedImages.clear();
            
            initializeRankings();
            generateComparisonPairs();
            currentComparisonIndex = 0;
            comparisons = []; // é‡ç½®å½“å‰ç»„çš„å¯¹æ¯”è®°å½•
            generateNewComparison();
            showPage('comparisonPage');
            updateGroupCounter();
        }

        function updateGroupCounter() {
            const groupText = currentLanguage === 'zh' ? `ç¬¬ ${currentGroupNumber} ç»„` : `Group ${currentGroupNumber}`;
            document.getElementById('groupCounter').textContent = groupText;
        }

        function generateComparisonPairs() {
            comparisonPairs = [];
            
            // åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œæ¯å¼ å›¾ç‰‡çš„IDå‡ºç°æ°å¥½2æ¬¡
            let imagePool = [];
            imageLibrary.forEach(img => {
                imagePool.push(img.id);
                imagePool.push(img.id);
            });
            
            // éšæœºæ‰“ä¹±å›¾ç‰‡æ± 
            for (let i = imagePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imagePool[i], imagePool[j]] = [imagePool[j], imagePool[i]];
            }
            
            debugLog(`ğŸ“Š å›¾ç‰‡æ± åˆ›å»ºå®Œæˆï¼Œå…± ${imagePool.length} ä¸ªå›¾ç‰‡å®ä¾‹ (${imageLibrary.length} å¼ å›¾ç‰‡ Ã— 2)`);
            
            // æˆå¯¹ç»„åˆï¼Œç¡®ä¿æ¯å¯¹ä¸æ˜¯åŒä¸€å¼ å›¾ç‰‡
            for (let i = 0; i < imagePool.length - 1; i += 2) {
                let imageAId = imagePool[i];
                let imageBId = imagePool[i + 1];
                
                // å¦‚æœæ˜¯åŒä¸€å¼ å›¾ç‰‡ï¼Œå°è¯•ä¸åé¢çš„å›¾ç‰‡äº¤æ¢
                if (imageAId === imageBId && i + 2 < imagePool.length) {
                    // å¯»æ‰¾ä¸‹ä¸€ä¸ªä¸åŒçš„å›¾ç‰‡è¿›è¡Œäº¤æ¢
                    for (let k = i + 2; k < imagePool.length; k++) {
                        if (imagePool[k] !== imageAId) {
                            [imagePool[i + 1], imagePool[k]] = [imagePool[k], imagePool[i + 1]];
                            imageBId = imagePool[i + 1];
                            break;
                        }
                    }
                }
                
                // å¦‚æœä»ç„¶æ˜¯åŒä¸€å¼ å›¾ç‰‡ï¼Œè·³è¿‡è¿™ä¸€å¯¹ï¼ˆç†è®ºä¸Šå¾ˆå°‘å‘ç”Ÿï¼‰
                if (imageAId !== imageBId) {
                    const imageA = imageLibrary.find(img => img.id === imageAId);
                    const imageB = imageLibrary.find(img => img.id === imageBId);
                    
                    if (imageA && imageB) {
                        comparisonPairs.push({ imageA, imageB });
                    }
                }
                
                // ç¡®ä¿ä¸è¶…è¿‡50ç»„å¯¹æ¯”
                if (comparisonPairs.length >= 50) {
                    break;
                }
            }
            
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„ç”Ÿæˆäº† ${comparisonPairs.length} ç»„é…å¯¹`);
            
            // éªŒè¯æ¯å¼ å›¾ç‰‡çš„å‡ºç°æ¬¡æ•°
            if (DEBUG_MODE) {
                const imageCount = {};
                comparisonPairs.forEach(pair => {
                    imageCount[pair.imageA.id] = (imageCount[pair.imageA.id] || 0) + 1;
                    imageCount[pair.imageB.id] = (imageCount[pair.imageB.id] || 0) + 1;
                });
                
                debugLog('ğŸ“‹ å›¾ç‰‡å‡ºç°æ¬¡æ•°ç»Ÿè®¡:');
                Object.entries(imageCount).forEach(([id, count]) => {
                    const imageName = imageLibrary.find(img => img.id == id)?.name || id;
                    debugLog(`  å›¾ç‰‡ ${imageName}: ${count} æ¬¡`);
                    if (count !== 2) {
                        debugLog(`  âš ï¸ è­¦å‘Š: å›¾ç‰‡ ${imageName} å‡ºç° ${count} æ¬¡ï¼Œä¸ç¬¦åˆé¢„æœŸçš„2æ¬¡`);
                    }
                });
            }
        }

        function initializeRankings() {
            imageRankings = {};
            imageLibrary.forEach(img => {
                imageRankings[img.id] = { score: 1000, wins: 0, losses: 0 };
            });
        }

        function generateNewComparison() {
            if (currentComparisonIndex >= 50) { // ç¡®ä¿æ°å¥½50ç»„å¯¹æ¯”
                completeCurrentGroup();
                return;
            }
            
            currentPair = comparisonPairs[currentComparisonIndex];

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            // åŠ è½½å½“å‰å›¾ç‰‡
            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            // å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡
            preloadNextPair();

            document.getElementById('progressCounter').textContent = `${currentComparisonIndex + 1}/50`;
            
            resetAllSelections();
        }

        function resetAllSelections() {
            // é‡ç½®æ‰€æœ‰å•é€‰æŒ‰é’®
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
            });
            
            // é‡ç½®ç¡®è®¤æŒ‰é’®
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function checkAllAnswered() {
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const allAnswered = radioGroups.every(group => {
                return document.querySelector(`input[name="${group}"]:checked`) !== null;
            });
            
            const confirmButton = document.getElementById('confirmButton');
            if (allAnswered) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                confirmButton.disabled = true;
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        function confirmAllSelections() {
            // æ”¶é›†æ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆ
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            const behaviors = ['å', 'è¡Œèµ°', 'æ…¢è·‘', 'é›†åˆ'];
            const answers = {};
            
            let allAnswered = true;
            radioGroups.forEach((group, index) => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    answers[group] = {
                        behavior: behaviors[index],
                        choice: selected.value,
                        winner: selected.value === 'A' ? currentPair.imageA.id : currentPair.imageB.id,
                        loser: selected.value === 'A' ? currentPair.imageB.id : currentPair.imageA.id,
                        winnerImage: selected.value === 'A' ? currentPair.imageA.name : currentPair.imageB.name,
                        loserImage: selected.value === 'A' ? currentPair.imageB.name : currentPair.imageA.name
                    };
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert(currentLanguage === 'zh' ? 'è¯·å›ç­”æ‰€æœ‰é—®é¢˜ï¼' : 'Please answer all questions!');
                return;
            }

            // ä¸ºæ¯ä¸ªè¡Œä¸ºæ›´æ–°æ’å
            Object.values(answers).forEach(answer => {
                const winnerId = answer.winner;
                const loserId = answer.loser;
                
                // æ›´æ–°æœ¬ç»„æ’å
                const K = 32;
                const winnerRating = imageRankings[winnerId].score;
                const loserRating = imageRankings[loserId].score;
                
                const expectedWinner = 1 / (1 + Math.pow(10, (loserRating - winnerRating) / 400));
                
                imageRankings[winnerId].score += K * (1 - expectedWinner);
                imageRankings[loserId].score += K * (0 - expectedWinner);
                imageRankings[winnerId].wins += 1;
                imageRankings[loserId].losses += 1;
            });

            // è®°å½•å¯¹æ¯”ç»“æœ
            comparisons.push({
                imageA: currentPair.imageA,
                imageB: currentPair.imageB,
                answers: answers,
                timestamp: new Date().toISOString(),
                groupNumber: currentGroupNumber,
                comparisonIndex: currentComparisonIndex + 1
            });

            currentComparisonIndex++;
            
            // æ¸…ç†é¢„åŠ è½½ç¼“å­˜ï¼Œé¿å…å†…å­˜å ç”¨è¿‡å¤š
            cleanupPreloadCache();
            
            generateNewComparison();
        }

        function completeCurrentGroup() {
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„å¯¹æ¯”å®Œæˆï¼Œå…±${comparisons.length}æ¬¡å¯¹æ¯”`);
            
            // ä¿å­˜å½“å‰ç»„æ•°æ®
            saveUserSession();
            
            // æ˜¾ç¤ºç»§ç»­è¯¢é—®é¡µé¢
            showPage('continuePage');
        }

        function continueNextGroup() {
            currentGroupNumber++;
            startNewGroup();
        }

        function finishSurvey() {
            showPage('thankYouPage');
        }

        function restart() {
            userData = { gender: '', age: '', isProfessional: '' };
            comparisons = [];
            imageRankings = {};
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            comparisonPairs = [];
            currentComparisonIndex = 0;
            currentGroupNumber = 1;
            sessionId = generateSessionId();
            preloadedImages.clear(); // æ¸…ç©ºé¢„åŠ è½½ç¼“å­˜
            
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('ageInput').value = '';
            
            showPage('languagePage');
        }

        // ====================================================================
        // ç®¡ç†å‘˜ç•Œé¢
        // ====================================================================
        const ADMIN_PASSWORD = 'UMS2025ygs';
        
        function showAdminPanel() {
            // å¯†ç éªŒè¯
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
            
            if (password === null) {
                // ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥
                return;
            }
            
            if (password !== ADMIN_PASSWORD) {
                alert('å¯†ç é”™è¯¯ï¼');
                return;
            }
            
            // å¯†ç æ­£ç¡®ï¼Œæ˜¾ç¤ºç®¡ç†å‘˜ç•Œé¢
            refreshStats();
            document.getElementById('adminPanel').classList.remove('hidden');
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        function refreshStats() {
            const stats = getCumulativeStats();
            const sessions = getAllSessions();
            
            // æ›´æ–°åŸºæœ¬ç»Ÿè®¡
            document.getElementById('totalUsers').textContent = stats.totalUsers || 0;
            document.getElementById('totalComparisons').textContent = stats.totalComparisons || 0;
            
            const avgComparisonsPerUser = stats.totalUsers > 0 ? (stats.totalComparisons / stats.totalUsers).toFixed(1) : '0';
            document.getElementById('avgGroups').textContent = avgComparisonsPerUser;
            
            // æ˜¾ç¤ºå½“å‰é€‰ä¸­è¡Œä¸ºçš„æ’å
            displayBehaviorRankings(stats, currentBehaviorTab);
            
            // æ›´æ–°ç”¨æˆ·è¯¦æƒ…
            displayUserDetails(sessions);
        }

        function showBehaviorTab(behaviorKey) {
            currentBehaviorTab = behaviorKey;
            
            // æ›´æ–°æ ‡ç­¾æ ·å¼
            const tabs = ['sitting', 'walking', 'jogging', 'gathering', 'overall'];
            tabs.forEach(tab => {
                const tabElement = document.getElementById(`tab-${tab}`);
                if (tab === behaviorKey) {
                    tabElement.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                    tabElement.classList.add('bg-blue-500', 'text-white');
                } else {
                    tabElement.classList.remove('bg-blue-500', 'text-white');
                    tabElement.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                }
            });
            
            // æ˜¾ç¤ºå¯¹åº”çš„æ’åæ•°æ®
            const stats = getCumulativeStats();
            displayBehaviorRankings(stats, behaviorKey);
        }

        function displayBehaviorRankings(stats, behaviorKey) {
            const behaviorRankings = document.getElementById('behaviorRankings');
            
            // è·å–å›¾ç‰‡åç§°çš„è¾…åŠ©å‡½æ•°
            function getImageName(imageId) {
                const image = imageLibrary.find(img => img.id == imageId);
                return image ? image.name : `å›¾ç‰‡${imageId}`;
            }
            
            let rankings = [];
            let behaviorName = '';
            
            if (behaviorKey === 'overall') {
                // æ˜¾ç¤ºç»¼åˆæ’å
                behaviorName = 'ç»¼åˆæ’å';
                if (stats.imageRankings && Object.keys(stats.imageRankings).length > 0) {
                    rankings = Object.entries(stats.imageRankings)
                        .sort(([,a], [,b]) => b.winRate - a.winRate)
                        .slice(0, 20);
                }
            } else {
                // æ˜¾ç¤ºç‰¹å®šè¡Œä¸ºçš„æ’å
                const behaviorNames = {
                    'sitting': 'å',
                    'walking': 'è¡Œèµ°', 
                    'jogging': 'æ…¢è·‘',
                    'gathering': 'é›†åˆ'
                };
                behaviorName = behaviorNames[behaviorKey] || behaviorKey;
                
                const behaviorData = stats.behaviorStats && stats.behaviorStats[behaviorName];
                if (behaviorData && behaviorData.imageRankings && Object.keys(behaviorData.imageRankings).length > 0) {
                    rankings = Object.entries(behaviorData.imageRankings)
                        .sort(([,a], [,b]) => b.winRate - a.winRate)
                        .slice(0, 20);
                }
            }
            
            if (rankings.length === 0) {
                behaviorRankings.innerHTML = `<p class="text-gray-500">æš‚æ— ${behaviorName}çš„ç»Ÿè®¡æ•°æ®</p>`;
                return;
            }
            
            const html = `
                <div class="space-y-2">
                    <h4 class="font-semibold text-gray-800 mb-3">${behaviorName}æ’å</h4>
                    <div class="grid grid-cols-5 gap-2 text-sm font-semibold text-gray-700 border-b pb-2">
                        <div>æ’å</div>
                        <div>å›¾ç‰‡åç§°</div>
                        <div>èƒœç‡</div>
                        <div>èƒœåœº</div>
                        <div>è´Ÿåœº</div>
                    </div>
                    ${rankings.map(([imageId, data], index) => {
                        const imageName = getImageName(imageId);
                        return `
                        <div class="grid grid-cols-5 gap-2 text-sm">
                            <div class="font-medium text-green-600">#${index + 1}</div>
                            <div class="truncate" title="${imageName}">${imageName}</div>
                            <div class="font-semibold text-blue-600">${(data.winRate * 100).toFixed(1)}%</div>
                            <div>${data.wins}</div>
                            <div>${data.losses}</div>
                        </div>
                    `}).join('')}
                </div>
            `;
            
            behaviorRankings.innerHTML = html;
        }

        function displayUserDetails(sessions) {
            const userDetails = document.getElementById('userDetails');
            
            if (sessions.length === 0) {
                userDetails.innerHTML = '<p class="text-gray-500">æš‚æ— ç”¨æˆ·æ•°æ®</p>';
                return;
            }
            
            const html = `
                <div class="space-y-2">
                    <div class="grid grid-cols-6 gap-2 text-sm font-semibold text-gray-700 border-b pb-2">
                        <div>ä¼šè¯ID</div>
                        <div>æ€§åˆ«</div>
                        <div>å¹´é¾„</div>
                        <div>ä¸“ä¸š</div>
                        <div>å®Œæˆç»„æ•°</div>
                        <div>æ—¶é—´</div>
                    </div>
                    ${sessions.slice(-20).map(session => `
                        <div class="grid grid-cols-6 gap-2 text-sm">
                            <div class="truncate">${session.sessionId.substr(-8)}</div>
                            <div>${session.userData.gender === 'male' ? 'ç”·' : 'å¥³'}</div>
                            <div>${session.userData.age}</div>
                            <div>${session.userData.isProfessional === 'yes' ? 'æ˜¯' : 'å¦'}</div>
                            <div>${session.groupsCompleted}</div>
                            <div>${new Date(session.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            userDetails.innerHTML = html;
        }

        function exportData() {
            const stats = getCumulativeStats();
            const sessions = getAllSessions();
            
            const exportData = {
                exportTime: new Date().toISOString(),
                cumulativeStats: stats,
                allSessions: sessions,
                summary: {
                    totalUsers: stats.totalUsers || 0,
                    totalComparisons: stats.totalComparisons || 0,
                    averageComparisonsPerUser: stats.totalUsers > 0 ? (stats.totalComparisons / stats.totalUsers) : 0
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `è¡—æ™¯é—®å·æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('æ•°æ®å·²å¯¼å‡ºï¼');
        }

        function clearData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                localStorage.removeItem('surveySessionsData');
                localStorage.removeItem('surveyCumulativeStats');
                refreshStats();
                alert('æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // ====================================================================
        // é¡µé¢åˆå§‹åŒ–
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('ğŸš€ è¡—æ™¯é—®å·ç³»ç»Ÿå¯åŠ¨ - åå°å­˜å‚¨ç‰ˆ');
            
            await initializeImageLibrary();
            
            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨åˆ°æ‰€æœ‰å•é€‰æŒ‰é’®
            const radioGroups = ['sitting', 'walking', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', checkAllAnswered);
                });
            });
            
            if (isImageLibraryLoaded) {
                debugLog(`âœ… ç³»ç»Ÿå°±ç»ªï¼Œå›¾ç‰‡åº“åŒ…å« ${imageLibrary.length} å¼ å›¾ç‰‡`);
            } else {
                debugLog('âš ï¸ å›¾ç‰‡åº“åˆå§‹åŒ–æœ‰é—®é¢˜ï¼Œä½†ç³»ç»Ÿä»å¯è¿è¡Œ');
            }
        });
    </script>
</body>
</html>

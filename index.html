<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>街景行为问卷调研</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .image-container {
            width: 666px;
            height: 500px;
        }
        .survey-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 9999;
            pointer-events: auto;
        }
        .admin-panel button {
            background-color: #1f2937;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .admin-panel button:hover {
            background-color: #374151;
        }
        .timer-warning {
            background-color: #fef3c7;
            color: #d97706;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .consent-text {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        .experiment-reminder {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .experiment-reminder h4 {
            color: #92400e;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .experiment-reminder p {
            color: #92400e;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .experiment-reminder ul {
            color: #92400e;
            margin-left: 20px;
            line-height: 1.5;
        }
        .progress-indicator {
            background-color: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        .progress-indicator h3 {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .progress-bar-container {
            background-color: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-bar-fill {
            background-color: #059669;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .user-nickname-highlight {
            background: linear-gradient(45deg, #fef3c7, #f3e8ff);
            border: 2px solid #059669;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        .user-nickname-highlight .nickname {
            font-size: 1.5rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 8px;
        }
        .system-status-panel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .bin-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border-radius: 6px;
            margin: 4px 0;
            border: 1px solid #e5e7eb;
        }
        .bin-status.active {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        .bin-status.full {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- 数据状态指示器 -->
    <div id="dataStatusIndicator" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="status-indicator">
            <div class="spinner"></div>
            <span id="dataStatusText">正在保存数据...</span>
        </div>
        <div id="saveProgress" class="progress-bar hidden">
            <div class="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <!-- 语言选择页面 -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <!-- 管理员入口 - 只在语言选择页面显示 -->
        <div class="admin-panel">
            <button onclick="showAdminPanel()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
                管理员
            </button>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">街景行为感知问卷</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">语言选择</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    中文
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- 基础信息收集页面 -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-3xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">窗景感知问卷：第一部分</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- 实验提醒 -->
                <div id="experimentReminder" class="experiment-reminder">
                    <h4 id="reminderTitle">?? 实验提醒</h4>
                    <p id="reminderText">请认真作答。本实验需要完成5组，每组20次图片对比，耗时约20分钟，才能获得最终报酬。</p>
                    <p id="reminderDevice">为保证实验效果，请使用电脑或平板电脑作答。</p>
                </div>

                <div class="space-y-6">
                    <!-- 昵称输入 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="nicknameLabel">您的昵称是：</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nicknameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="">
                        <p id="nicknameHint" class="text-sm text-gray-500 mt-1">请记忆，并用于兑换被试费用。建议使用姓名拼音。</p>
                    </div>

                    <!-- 性别选择 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">您的性别是：</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">男</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">女</span>
                            </label>
                        </div>
                    </div>

                    <!-- 年龄输入 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">您的年龄：</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- 专业背景 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">您来自城市规划/建筑/风景园林相关专业吗？</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">是</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">否</span>
                            </label>
                        </div>
                    </div>

                    <!-- 知情同意 -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="consentTitle">实验知情同意</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="consent-text">
                            <div id="consentText">
                                <p class="mb-3"><strong>实验主体：</strong>香港科技大学（广州）城市治理与设计学域Urban Morphology Studio (UMS)</p>
                                <p class="mb-3"><strong>实验目的：</strong>本实验旨在了解人们对不同街景环境中行为适宜性的感知和偏好。通过系统性的街景图片对比，我们希望识别个体如何评估空间对各种人类活动的支持性，从而为循证城市设计实践做出贡献。</p>
                                <p class="mb-3"><strong>实验过程：</strong>在实验过程中，我们将记录：</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>您的基本信息（昵称、性别、年龄、专业背景）</li>
                                    <li>您对不同街景图片的行为适宜性选择</li>
                                    <li>您的选择时间和浏览时长</li>
                                    <li>参与实验的时间戳</li>
                                </ul>
                                <p class="mb-3"><strong>数据使用：</strong>收集的所有数据将仅用于城市设计和空间感知相关的科学研究。我们承诺：</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>您的个人信息将被严格保密</li>
                                    <li>数据仅用于学术研究目的</li>
                                    <li>研究结果将以匿名化的形式发表</li>
                                    <li>您有权在任何时候退出实验</li>
                                </ul>
                                <p class="mb-3"><strong>联系方式：</strong>如有任何疑问，请联系研究团队。</p>
                                <p class="font-semibold">参与本实验即表示您已充分了解上述内容并自愿参加。</p>
                            </div>
                        </div>
                        <label class="flex items-start mt-3">
                            <input type="checkbox" id="consentCheckbox" class="mt-1 mr-3">
                            <span id="consentAgree">我已阅读并理解上述说明，同意参与本实验</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        下一部分
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片对比页面 -->
    <div id="comparisonPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-6xl mx-auto">
            <!-- 进度指示器 -->
            <div id="overallProgressIndicator" class="progress-indicator">
                <h3 id="overallProgressTitle">实验进度</h3>
                <p id="overallProgressText">第 1 组 / 共 5 组</p>
                <div class="progress-bar-container">
                    <div id="overallProgressFill" class="progress-bar-fill" style="width: 20%"></div>
                </div>
                <p id="overallProgressDetail" class="text-sm mt-2">当前组进度: 1/20</p>
            </div>

            <div class="flex justify-between text-gray-800 mb-4">
                <div>
                    <span id="groupCounter">第 1 组</span>
                </div>
                <div>
                    <span id="progressCounter">1/20</span>
                </div>
            </div>
            
            <!-- 顶部提示 -->
            <div class="bg-white rounded-lg p-4 mb-6">
                <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">提示</h3>
                <p id="instructions" class="text-sm text-gray-600">
                    在此调研中，您需要对每对图片回答四个不同的行为问题。请根据您的直觉选择您认为更加适合进行各种活动的街景。所有问题都必须回答完毕才能进入下一对图片。
                </p>
            </div>
            
            <!-- 图片展示区域 -->
            <div class="flex justify-center mb-6 space-x-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageALabel" class="font-bold text-gray-800">图片 A</span>
                    </div>
                    <div class="image-container">
                        <img id="imageA_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageBLabel" class="font-bold text-gray-800">图片 B</span>
                    </div>
                    <div class="image-container">
                        <img id="imageB_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
            </div>
            
            <!-- 问题区域 -->
            <div class="bg-white rounded-lg p-6 mb-6">
                <div class="space-y-6">
                    <!-- 问题1：坐憩 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question1" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"坐憩"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题2：漫步 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question2" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"漫步"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="strolling" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="strolling" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题3：慢跑 -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question3" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"慢跑"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 问题4：聚会或聚集 -->
                    <div>
                        <h3 id="question4" class="font-bold text-gray-800 mb-3">以下两张街景中，您认为哪张更加适合"聚会或聚集"的行为：</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="A" class="mr-2">
                                <span class="optionA">图片 A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="B" class="mr-2">
                                <span class="optionB">图片 B</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 确认按钮 -->
            <div class="text-center">
                <button id="confirmButton" onclick="confirmAllSelections()" disabled class="px-8 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed">
                    <span id="confirmButtonText">确认并继续</span>
                </button>
                
                <!-- 时间提示 - 移动到确认按钮下方 -->
                <div id="timeWarning" class="timer-warning mt-4 mx-auto max-w-md hidden">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="timeWarningText">请仔细观察图片至少6秒后再进行选择</span>
                </div>
            </div>
        </div>
    </div>

    <!-- 继续询问页面 -->
    <div id="continuePage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="continueTitle" class="text-2xl font-bold text-gray-800 mb-4">本组对比已完成</h2>
            <p id="continueMessage" class="text-gray-600 mb-8">您已完成了第1组图片对比！<br>还需要完成4组才能获得报酬。</p>
            
            <!-- 整体进度条 -->
            <div class="mb-6">
                <div class="progress-bar-container">
                    <div id="continueProgressFill" class="progress-bar-fill" style="width: 20%"></div>
                </div>
                <p id="continueProgressText" class="text-sm text-gray-600 mt-2">已完成 1/5 组</p>
            </div>
            
            <div id="continueButtons" class="flex justify-center space-x-4">
                <button onclick="continueNextGroup()" id="continueButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    继续下一组
                </button>
                <button onclick="showExitWarning()" id="exitButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    退出实验
                </button>
            </div>
            
            <!-- 完成全部实验的按钮（仅在完成5组后显示） -->
            <div id="finishButtons" class="hidden flex justify-center space-x-4">
                <button onclick="finishSurvey()" id="finishButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    完成实验
                </button>
            </div>
        </div>
    </div>

    <!-- 退出警告页面 -->
    <div id="exitWarningPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="exitWarningTitle" class="text-2xl font-bold text-gray-800 mb-4">?? 退出警告</h2>
            <p id="exitWarningMessage" class="text-gray-600 mb-8">您还未完成全部5组实验，现在退出将无法获得报酬。<br><br>确定要退出吗？</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="backToContinue()" id="backButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    返回继续实验
                </button>
                <button onclick="forceExit()" id="forceExitButton" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
                    确定退出
                </button>
            </div>
        </div>
    </div>

    <!-- 感谢页面 -->
    <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <!-- 用户昵称高亮显示 -->
            <div class="user-nickname-highlight">
                <div class="nickname" id="thankYouNickname">用户昵称</div>
                <p id="nicknameConfirmText" class="text-sm text-gray-600">感谢您的参与！</p>
            </div>
            
            <h2 id="thankYouTitle" class="text-2xl font-bold text-gray-800 mb-4">?? 感谢您的参与！</h2>
            <p id="thankYouMessage" class="text-gray-600 mb-8">您已成功完成全部5组实验，数据已提交！<br><br>感谢您为街景感知研究做出的贡献！请联系研究人员兑换报酬。</p>
            
            <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                重新开始
            </button>
        </div>
    </div>

    <!-- 管理员界面 -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">管理员面板</h2>
                    <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- 数据库状态 -->
                <div id="databaseStatus" class="mb-6">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <span>正在连接服务器...</span>
                    </div>
                </div>

                <!-- 系统状态面板 -->
                <div id="systemStatus" class="system-status-panel mb-6 hidden">
                    <h4 class="font-semibold text-gray-800 mb-3">多Bin系统状态</h4>
                    <div id="systemStatusContent">
                        <!-- 系统状态内容将在这里动态生成 -->
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800">总参与人数</h3>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">总对比次数</h3>
                        <p id="totalComparisons" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800">平均每人对比次数</h3>
                        <p id="avgGroups" class="text-2xl font-bold text-purple-600">-</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-6">
                    <button onclick="exportData()" id="exportButton" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>
                        导出数据表格
                    </button>
                    <button onclick="clearData()" id="clearButton" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-400" disabled>
                        清空数据
                    </button>
                    <button onclick="refreshStats()" id="refreshButton" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        刷新统计
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">最近的对比数据</h3>
                    <div id="comparisonData" class="overflow-auto max-h-96">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">用户详情</h3>
                    <div id="userDetails" class="overflow-auto max-h-64">
                        <div class="text-gray-500">加载中...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // 多Bin管理配置
        // ====================================================================
        const MULTI_BIN_CONFIG = {
            masterKey: '$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.',
            baseUrl: 'https://api.jsonbin.io/v3/b',
            // 主控制bin - 存储所有子bin的索引信息
            masterBinId: '68af17fed0ea881f40683b2d',
            // 数据大小限制 (字节) - 设置为800KB为安全起见
            maxBinSize: 800 * 1024,
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': '$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.'
            }
        };

        // ====================================================================
        // 多Bin管理器类
        // ====================================================================
        class MultiBinManager {
            constructor(config) {
                this.config = config;
                this.currentBinInfo = null;
                this.allBins = [];
            }

            // 获取数据的字节大小
            getDataSize(data) {
                return new Blob([JSON.stringify(data)]).size;
            }

            // 读取主控制bin，获取所有子bin信息
            async readMasterBin() {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${this.config.masterBinId}/latest`, {
                        method: 'GET',
                        headers: this.config.headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`读取主控制bin失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    console.log(`读取主控制bin失败: ${error.message}`);
                    // 返回初始结构
                    return {
                        dataBins: [],
                        totalRecords: 0,
                        lastUpdated: new Date().toISOString(),
                        version: '1.0'
                    };
                }
            }

            // 更新主控制bin
            async updateMasterBin(masterData) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${this.config.masterBinId}`, {
                        method: 'PUT',
                        headers: this.config.headers,
                        body: JSON.stringify(masterData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`更新主控制bin失败: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.log(`更新主控制bin失败: ${error.message}`);
                    throw error;
                }
            }

            // 创建新的数据bin
            async createNewDataBin() {
                try {
                    const initialData = {
                        sessions: [],
                        comparisons: [],
                        binInfo: {
                            createdAt: new Date().toISOString(),
                            recordCount: 0
                        },
                        lastUpdated: new Date().toISOString()
                    };

                    const response = await fetch(`${this.config.baseUrl}`, {
                        method: 'POST',
                        headers: this.config.headers,
                        body: JSON.stringify(initialData)
                    });

                    if (!response.ok) {
                        throw new Error(`创建新bin失败: ${response.status}`);
                    }

                    const result = await response.json();
                    const newBinId = result.metadata.id;
                    
                    console.log(`创建新数据bin成功: ${newBinId}`);
                    
                    return {
                        binId: newBinId,
                        createdAt: new Date().toISOString(),
                        recordCount: 0,
                        estimatedSize: this.getDataSize(initialData),
                        status: 'active'
                    };
                } catch (error) {
                    console.log(`创建新数据bin失败: ${error.message}`);
                    throw error;
                }
            }

            // 读取指定数据bin
            async readDataBin(binId) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${binId}/latest`, {
                        method: 'GET',
                        headers: this.config.headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`读取数据bin失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    console.log(`读取数据bin ${binId} 失败: ${error.message}`);
                    throw error;
                }
            }

            // 更新指定数据bin
            async updateDataBin(binId, data) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${binId}`, {
                        method: 'PUT',
                        headers: this.config.headers,
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`更新数据bin失败: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.log(`更新数据bin ${binId} 失败: ${error.message}`);
                    throw error;
                }
            }

            // 初始化多bin系统
            async initialize() {
                try {
                    console.log('初始化多bin管理系统...');
                    
                    const masterData = await this.readMasterBin();
                    this.allBins = masterData.dataBins || [];
                    
                    if (this.allBins.length === 0) {
                        console.log('没有发现数据bin，创建第一个...');
                        const newBin = await this.createNewDataBin();
                        this.allBins = [newBin];
                        
                        // 更新主控制bin
                        masterData.dataBins = this.allBins;
                        masterData.lastUpdated = new Date().toISOString();
                        await this.updateMasterBin(masterData);
                    }
                    
                    // 找到当前活跃的bin（最后一个）
                    this.currentBinInfo = this.allBins[this.allBins.length - 1];
                    
                    console.log(`多bin系统初始化完成，共 ${this.allBins.length} 个bin`);
                    console.log(`当前活跃bin: ${this.currentBinInfo.binId}`);
                    
                    return true;
                } catch (error) {
                    console.log(`多bin系统初始化失败: ${error.message}`);
                    throw error;
                }
            }

            // 检查当前bin是否需要切换
            async checkAndSwitchBin(newDataSize) {
                const estimatedNewSize = this.currentBinInfo.estimatedSize + newDataSize;
                
                if (estimatedNewSize > this.config.maxBinSize) {
                    console.log(`当前bin即将超限 (${estimatedNewSize} > ${this.config.maxBinSize})，创建新bin...`);
                    
                    // 标记当前bin为已满
                    this.currentBinInfo.status = 'full';
                    
                    // 创建新bin
                    const newBin = await this.createNewDataBin();
                    this.allBins.push(newBin);
                    this.currentBinInfo = newBin;
                    
                    // 更新主控制bin
                    const masterData = await this.readMasterBin();
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    console.log(`已切换到新bin: ${this.currentBinInfo.binId}`);
                    
                    return true;
                }
                
                return false;
            }

            // 保存会话数据（自动处理多bin）
            async saveUserSession(sessionData, comparisonRecords) {
                try {
                    console.log(`开始保存会话数据，对比记录数: ${comparisonRecords.length}`);
                    
                    // 估算新数据大小
                    const newDataSize = this.getDataSize({
                        sessions: [sessionData],
                        comparisons: comparisonRecords
                    });
                    
                    // 检查是否需要切换bin
                    await this.checkAndSwitchBin(newDataSize);
                    
                    // 读取当前活跃bin的数据
                    const currentData = await this.readDataBin(this.currentBinInfo.binId);
                    
                    // 检查是否已存在该用户的会话记录
                    const existingSessions = currentData.sessions || [];
                    const existingSessionIndex = existingSessions.findIndex(
                        session => session.sessionId === sessionData.sessionId
                    );
                    
                    let updatedSessions;
                    if (existingSessionIndex !== -1) {
                        // 更新现有会话记录
                        updatedSessions = [...existingSessions];
                        updatedSessions[existingSessionIndex] = {
                            ...updatedSessions[existingSessionIndex],
                            ...sessionData,
                            lastUpdated: new Date().toISOString()
                        };
                        console.log(`更新现有用户会话: ${sessionData.userData.nickname}`);
                    } else {
                        // 创建新会话记录
                        updatedSessions = [...existingSessions, sessionData];
                        console.log(`创建新用户会话: ${sessionData.userData.nickname}`);
                    }
                    
                    // 合并新的对比数据
                    const updatedData = {
                        ...currentData,
                        sessions: updatedSessions,
                        comparisons: [...(currentData.comparisons || []), ...comparisonRecords],
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // 保存到当前活跃bin
                    await this.updateDataBin(this.currentBinInfo.binId, updatedData);
                    
                    // 更新bin信息
                    this.currentBinInfo.recordCount += comparisonRecords.length;
                    this.currentBinInfo.estimatedSize = this.getDataSize(updatedData);
                    
                    // 更新主控制bin中的统计信息
                    const masterData = await this.readMasterBin();
                    masterData.totalRecords += comparisonRecords.length;
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    console.log(`会话数据保存成功到bin: ${this.currentBinInfo.binId}`);
                    return true;
                    
                } catch (error) {
                    console.log(`保存会话数据失败: ${error.message}`);
                    throw error;
                }
            }

            // 读取所有数据（从所有bin）
            async readAllData() {
                try {
                    console.log('开始读取所有bin的数据...');
                    
                    const allSessions = [];
                    const allComparisons = [];
                    
                    for (const binInfo of this.allBins) {
                        try {
                            const binData = await this.readDataBin(binInfo.binId);
                            
                            if (binData.sessions) {
                                allSessions.push(...binData.sessions);
                            }
                            if (binData.comparisons) {
                                allComparisons.push(...binData.comparisons);
                            }
                            
                            console.log(`从bin ${binInfo.binId} 读取到 ${binData.sessions?.length || 0} 个会话，${binData.comparisons?.length || 0} 条对比记录`);
                        } catch (error) {
                            console.log(`读取bin ${binInfo.binId} 失败: ${error.message}`);
                        }
                    }
                    
                    console.log(`总计读取: ${allSessions.length} 个会话，${allComparisons.length} 条对比记录`);
                    
                    return {
                        sessions: allSessions,
                        comparisons: allComparisons,
                        lastUpdated: new Date().toISOString()
                    };
                    
                } catch (error) {
                    console.log(`读取所有数据失败: ${error.message}`);
                    throw error;
                }
            }

            // 清空所有数据
            async clearAllData() {
                try {
                    console.log('开始清空所有bin数据...');
                    
                    // 清空所有数据bin（保留bin本身，只清空内容）
                    for (const binInfo of this.allBins) {
                        const emptyData = {
                            sessions: [],
                            comparisons: [],
                            binInfo: {
                                createdAt: binInfo.createdAt,
                                recordCount: 0
                            },
                            lastUpdated: new Date().toISOString()
                        };
                        
                        await this.updateDataBin(binInfo.binId, emptyData);
                        binInfo.recordCount = 0;
                        binInfo.estimatedSize = this.getDataSize(emptyData);
                        binInfo.status = binInfo === this.currentBinInfo ? 'active' : 'empty';
                    }
                    
                    // 更新主控制bin
                    const masterData = await this.readMasterBin();
                    masterData.totalRecords = 0;
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    console.log('所有数据已清空');
                    return true;
                    
                } catch (error) {
                    console.log(`清空数据失败: ${error.message}`);
                    throw error;
                }
            }

            // 获取系统状态
            getSystemStatus() {
                return {
                    totalBins: this.allBins.length,
                    currentBinId: this.currentBinInfo?.binId,
                    currentBinSize: this.currentBinInfo?.estimatedSize,
                    maxBinSize: this.config.maxBinSize,
                    usagePercentage: this.currentBinInfo ? 
                        Math.round((this.currentBinInfo.estimatedSize / this.config.maxBinSize) * 100) : 0,
                    bins: this.allBins.map(bin => ({
                        binId: bin.binId.substring(0, 8) + '...',
                        status: bin.status,
                        recordCount: bin.recordCount,
                        sizeKB: Math.round(bin.estimatedSize / 1024)
                    }))
                };
            }
        }

        // ====================================================================
        // 全局多bin管理器实例
        // ====================================================================
        let multiBinManager = null;

        // 初始化多bin管理器
        async function initializeMultiBinManager() {
            if (!multiBinManager) {
                multiBinManager = new MultiBinManager(MULTI_BIN_CONFIG);
                await multiBinManager.initialize();
            }
            return multiBinManager;
        }

        // ====================================================================
        // 配置和全局变量
        // ====================================================================
        const MAX_GROUPS = 5;

        const DEMO_IMAGES = [
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff11158-a3d5-4e96-9c02-92dd8a42566a_5344.png'
        ];

        let fullImageLibrary = [];
        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { nickname: '', gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;
        let comparisonPairs = [];
        let currentComparisonIndex = 0;
        let currentGroupNumber = 1;
        let sessionId = generateSessionId();
        let preloadedImages = new Map();
        
        let comparisonStartTime = null;
        let minimumViewTime = 6000;
        let timeWarningShown = false;

        // ====================================================================
        // 辅助函数
        // ====================================================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ====================================================================
        // 替换的JSONBin函数
        // ====================================================================

        // 替换原来的 readFromJsonBin 函数
        async function readFromJsonBin() {
            try {
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                return await multiBinManager.readAllData();
            } catch (error) {
                console.log(`从多bin读取数据失败: ${error.message}`);
                return {
                    sessions: [],
                    comparisons: [],
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        // 替换原来的 saveUserSession 函数
        async function saveUserSession() {
            try {
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }

                console.log(`开始提交用户会话: ${sessionId}, 对比数量: ${comparisons.length}`);
                
                const newSessionData = {
                    sessionId: sessionId,
                    userData: userData,
                    groupsCompleted: currentGroupNumber,
                    totalComparisons: comparisons.length,
                    timestamp: new Date().toISOString(),
                    language: currentLanguage,
                    lastUpdated: new Date().toISOString()
                };
                
                const newComparisonRecords = comparisons.map(comparison => ({
                    sessionId: sessionId,
                    nickname: userData.nickname,
                    gender: userData.gender,
                    age: userData.age,
                    isProfessional: userData.isProfessional,
                    groupNumber: comparison.groupNumber,
                    comparisonIndex: comparison.comparisonIndex,
                    image1_url: comparison.imageA.url,
                    image2_url: comparison.imageB.url,
                    image1_name: comparison.imageA.name,
                    image2_name: comparison.imageB.name,
                    sitting: comparison.answers.sitting ? (comparison.answers.sitting.choice === 'A' ? 0 : 1) : null,
                    strolling: comparison.answers.strolling ? (comparison.answers.strolling.choice === 'A' ? 0 : 1) : null,
                    jogging: comparison.answers.jogging ? (comparison.answers.jogging.choice === 'A' ? 0 : 1) : null,
                    gathering: comparison.answers.gathering ? (comparison.answers.gathering.choice === 'A' ? 0 : 1) : null,
                    viewTime: comparison.viewTime || 0,
                    timestamp: comparison.timestamp
                }));
                
                showDataStatus('正在保存数据到多bin系统...', 'loading');
                
                await multiBinManager.saveUserSession(newSessionData, newComparisonRecords);
                
                console.log(`数据保存成功到多bin系统`);
                showDataStatus('数据保存成功', 'success');
                setTimeout(hideDataStatus, 2000);
                
                return true;
                
            } catch (error) {
                console.log(`保存失败: ${error.message}`);
                showDataStatus('数据保存失败，请检查网络连接', 'error');
                setTimeout(hideDataStatus, 5000);
                return false;
            }
        }

        // ====================================================================
        // 时间控制函数
        // ====================================================================
        function startComparisonTimer() {
            comparisonStartTime = Date.now();
            timeWarningShown = false;
            hideTimeWarning();
        }

        function checkMinimumViewTime() {
            if (!comparisonStartTime) return true;
            
            const elapsed = Date.now() - comparisonStartTime;
            return elapsed >= minimumViewTime;
        }

        function showTimeWarning() {
            const warning = document.getElementById('timeWarning');
            const warningText = document.getElementById('timeWarningText');
            
            if (currentLanguage === 'zh') {
                warningText.textContent = '请仔细观察图片至少6秒后再进行选择';
            } else {
                warningText.textContent = 'Please observe the images carefully for at least 6 seconds before making a selection';
            }
            
            warning.classList.remove('hidden');
            timeWarningShown = true;
            
            setTimeout(() => {
                hideTimeWarning();
            }, 3000);
        }

        function hideTimeWarning() {
            document.getElementById('timeWarning').classList.add('hidden');
        }

        // ====================================================================
        // URL处理函数
        // ====================================================================
        function extractImageName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1];
            return filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        }

        function buildFallbackUrl(originalUrl) {
            const hash = hashCode(originalUrl);
            const id = Math.abs(hash) % 1000;
            return `https://picsum.photos/seed/${id}/666/500`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // 图片库初始化
        // ====================================================================
        async function initializeImageLibrary() {
            console.log('初始化完整图片库...');
            
            let imageUrls = await loadImageUrlsFromFile();
            
            if (!imageUrls || imageUrls.length === 0) {
                console.log('文件加载失败，使用演示图片列表');
                imageUrls = DEMO_IMAGES;
            }
            
            fullImageLibrary = imageUrls.map((url, index) => ({
                id: index + 1,
                name: extractImageName(url),
                url: url.trim(),
                fallbackUrl: buildFallbackUrl(url)
            }));
            
            const minImagesNeeded = 20;
            if (fullImageLibrary.length < minImagesNeeded) {
                console.log(`图片数量不足(${fullImageLibrary.length}张)，需要至少${minImagesNeeded}张`);
                const originalLibrary = [...fullImageLibrary];
                while (fullImageLibrary.length < minImagesNeeded) {
                    fullImageLibrary.push(...originalLibrary.map((img, index) => ({
                        ...img,
                        id: fullImageLibrary.length + index + 1
                    })));
                }
                console.log(`已调整完整图片库到${fullImageLibrary.length}张图片`);
            }
            
            isImageLibraryLoaded = true;
            console.log(`完整图片库初始化完成，共 ${fullImageLibrary.length} 张图片`);
        }

        function selectImagesForCurrentGroup() {
            console.log(`为第${currentGroupNumber}组选择新的图片...`);
            
            const minImagesNeeded = 20;
            
            if (fullImageLibrary.length >= minImagesNeeded) {
                const shuffled = [...fullImageLibrary].sort(() => 0.5 - Math.random());
                imageLibrary = shuffled.slice(0, minImagesNeeded);
            } else {
                imageLibrary = [];
                const originalCount = fullImageLibrary.length;
                for (let i = 0; i < minImagesNeeded; i++) {
                    const originalImg = fullImageLibrary[i % originalCount];
                    imageLibrary.push({
                        ...originalImg,
                        id: i + 1
                    });
                }
                imageLibrary.sort(() => 0.5 - Math.random());
            }
            
            console.log(`第${currentGroupNumber}组图片选择完成，共 ${imageLibrary.length} 张图片`);
        }

        async function loadImageUrlsFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('文件不存在');
                
                const text = await response.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'))
                    .filter(line => line.startsWith('http'));
                
                console.log(`从文件加载了 ${urls.length} 个图片URL`);
                return urls;
            } catch (error) {
                console.log(`加载图片列表文件失败: ${error.message}`);
                return null;
            }
        }

        function loadImageWithFallback(imgElement, imageData, callback) {
            console.log(`加载图片: ${imageData.name}`);
            
            const preloadedImageKey = `${imageData.id}_${imageData.url}`;
            if (preloadedImages.has(preloadedImageKey)) {
                const preloadedImg = preloadedImages.get(preloadedImageKey);
                if (preloadedImg.complete && preloadedImg.naturalHeight !== 0) {
                    console.log(`使用预加载的图片: ${imageData.name}`);
                    imgElement.src = preloadedImg.src;
                    if (callback) callback(true);
                    return;
                }
            }
            
            imgElement.onload = function() {
                console.log(`图片 ${imageData.name} 原始URL加载成功`);
                if (callback) callback(true);
            };
            
            imgElement.onerror = function() {
                console.log(`图片 ${imageData.name} 原始URL加载失败，尝试备用图片`);
                
                imgElement.onload = function() {
                    console.log(`图片 ${imageData.name} 通过备用源加载成功`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    console.log(`图片 ${imageData.name} 所有源都无法加载`);
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aauOaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                };
                
                imgElement.src = imageData.fallbackUrl;
            };
            
            imgElement.src = imageData.url;
        }

        function preloadImage(imageData) {
            return new Promise((resolve) => {
                const preloadedImageKey = `${imageData.id}_${imageData.url}`;
                
                if (preloadedImages.has(preloadedImageKey)) {
                    resolve(preloadedImages.get(preloadedImageKey));
                    return;
                }
                
                const img = new Image();
                
                img.onload = function() {
                    console.log(`预加载成功: ${imageData.name}`);
                    preloadedImages.set(preloadedImageKey, img);
                    resolve(img);
                };
                
                img.onerror = function() {
                    console.log(`预加载原始URL失败，尝试备用URL: ${imageData.name}`);
                    
                    const fallbackImg = new Image();
                    fallbackImg.onload = function() {
                        console.log(`预加载备用URL成功: ${imageData.name}`);
                        preloadedImages.set(preloadedImageKey, fallbackImg);
                        resolve(fallbackImg);
                    };
                    
                    fallbackImg.onerror = function() {
                        console.log(`预加载所有URL都失败: ${imageData.name}`);
                        resolve(null);
                    };
                    
                    fallbackImg.src = imageData.fallbackUrl;
                };
                
                img.src = imageData.url;
            });
        }

        function preloadNextPair() {
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                console.log(`开始预加载下一对图片 (${nextIndex + 1}/${comparisonPairs.length})`);
                
                Promise.all([
                    preloadImage(nextPair.imageA),
                    preloadImage(nextPair.imageB)
                ]).then(() => {
                    console.log(`下一对图片预加载完成`);
                }).catch((error) => {
                    console.log(`预加载失败: ${error}`);
                });
            }
        }

        // 修复：更智能的缓存清理逻辑
        function cleanupPreloadCache() {
            const keepKeys = new Set();
            
            // 保留当前显示的图片 - 使用当前显示的索引而不是增加后的索引
            const displayIndex = Math.min(currentComparisonIndex, comparisonPairs.length - 1);
            if (displayIndex >= 0 && displayIndex < comparisonPairs.length) {
                const currentPair = comparisonPairs[displayIndex];
                keepKeys.add(`${currentPair.imageA.id}_${currentPair.imageA.url}`);
                keepKeys.add(`${currentPair.imageB.id}_${currentPair.imageB.url}`);
                console.log(`保留当前显示图片 (索引 ${displayIndex}): ${currentPair.imageA.name}, ${currentPair.imageB.name}`);
            }
            
            // 保留下一对预加载的图片
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                keepKeys.add(`${nextPair.imageA.id}_${nextPair.imageA.url}`);
                keepKeys.add(`${nextPair.imageB.id}_${nextPair.imageB.url}`);
                console.log(`保留下一对预加载图片 (索引 ${nextIndex}): ${nextPair.imageA.name}, ${nextPair.imageB.name}`);
            }
            
            // 清理不需要的缓存
            const beforeCleanup = preloadedImages.size;
            for (const key of preloadedImages.keys()) {
                if (!keepKeys.has(key)) {
                    preloadedImages.delete(key);
                }
            }
            const afterCleanup = preloadedImages.size;
            
            if (beforeCleanup !== afterCleanup) {
                console.log(`缓存清理完成: ${beforeCleanup} -> ${afterCleanup} 张图片`);
            }
        }

        // ====================================================================
        // 数据状态显示函数
        // ====================================================================
        function showDataStatus(message, type = 'loading') {
            const indicator = document.getElementById('dataStatusIndicator');
            const statusDiv = indicator.querySelector('.status-indicator');
            const textElement = document.getElementById('dataStatusText');
            const spinner = statusDiv.querySelector('.spinner');

            statusDiv.className = 'status-indicator';
            
            switch (type) {
                case 'loading':
                    statusDiv.classList.add('status-warning');
                    spinner.style.display = 'block';
                    break;
                case 'success':
                    statusDiv.classList.add('status-success');
                    spinner.style.display = 'none';
                    break;
                case 'error':
                    statusDiv.classList.add('status-error');
                    spinner.style.display = 'none';
                    break;
                default:
                    statusDiv.classList.add('status-warning');
                    spinner.style.display = 'block';
            }

            textElement.textContent = message;
            indicator.classList.remove('hidden');
        }

        function hideDataStatus() {
            document.getElementById('dataStatusIndicator').classList.add('hidden');
        }

        // ====================================================================
        // 进度更新函数
        // ====================================================================
        function updateOverallProgress() {
            const overallProgressTitle = document.getElementById('overallProgressTitle');
            const overallProgressText = document.getElementById('overallProgressText');
            const overallProgressDetail = document.getElementById('overallProgressDetail');
            const overallProgressFill = document.getElementById('overallProgressFill');
            
            if (currentLanguage === 'zh') {
                overallProgressTitle.textContent = '实验进度';
                overallProgressText.textContent = `第 ${currentGroupNumber} 组 / 共 ${MAX_GROUPS} 组`;
                overallProgressDetail.textContent = `当前组进度: ${currentComparisonIndex + 1}/20`;
            } else {
                overallProgressTitle.textContent = 'Experiment Progress';
                overallProgressText.textContent = `Group ${currentGroupNumber} / ${MAX_GROUPS}`;
                overallProgressDetail.textContent = `Current group: ${currentComparisonIndex + 1}/20`;
            }
            
            const groupProgress = (currentGroupNumber - 1) / MAX_GROUPS;
            const currentGroupProgress = (currentComparisonIndex + 1) / 20 / MAX_GROUPS;
            const totalProgress = (groupProgress + currentGroupProgress) * 100;
            
            overallProgressFill.style.width = `${Math.min(totalProgress, 100)}%`;
        }

        function updateContinueProgress() {
            const continueProgressText = document.getElementById('continueProgressText');
            const continueProgressFill = document.getElementById('continueProgressFill');
            
            if (currentLanguage === 'zh') {
                continueProgressText.textContent = `已完成 ${currentGroupNumber}/${MAX_GROUPS} 组`;
            } else {
                continueProgressText.textContent = `Completed ${currentGroupNumber}/${MAX_GROUPS} groups`;
            }
            
            const progressPercentage = (currentGroupNumber / MAX_GROUPS) * 100;
            continueProgressFill.style.width = `${progressPercentage}%`;
        }

        // ====================================================================
        // 问卷逻辑
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: '街景感知问卷：第一部分',
                reminderTitle: '?? 实验提醒',
                reminderText: '请认真作答。本实验需要完成5组，每组20次图片对比，耗时约20分钟，才能获得最终报酬。',
                reminderDevice: '为保证实验效果，请使用电脑或平板电脑作答。',
                nicknameLabel: '您的昵称是：',
                nicknameHint: '请记忆，以用于兑换被试费用。建议使用姓名拼音。',
                genderLabel: '您的性别是：',
                maleLabel: '男',
                femaleLabel: '女',
                ageLabel: '您的年龄：',
                professionalLabel: '您来自城市规划/建筑/风景园林相关专业吗？',
                yesLabel: '是',
                noLabel: '否',
                consentTitle: '实验知情同意',
                consentAgree: '我已阅读并理解上述说明，同意参与本实验',
                nextButton: '下一部分',
                compareTitle: '以下两张街景中，您认为哪张更加适合"坐"的行为：',
                hintTitle: '提示',
                instructions: '在此调研中，您需要对每对图片回答四个不同的行为问题。请根据您的直觉选择您认为更加适合进行各种活动的街景。所有问题都必须回答完毕才能进入下一对图片。',
                continueTitle: '本组对比已完成',
                continueButton: '继续下一组',
                exitButton: '退出实验',
                exitWarningTitle: '?? 退出警告',
                exitWarningMessage: '您还未完成全部5组实验，现在退出将无法获得报酬。\n\n确定要退出吗？',
                backButton: '返回继续实验',
                forceExitButton: '确定退出',
                finishButton: '完成实验',
                thankYouTitle: '?? 感谢您的参与！',
                thankYouMessage: '您已成功完成全部5组实验，数据已提交！\n\n感谢您为街景感知研究做出的贡献！请联系研究人员兑换报酬。',
                restartButton: '重新开始',
                nicknameConfirmText: '感谢您的参与！',
                imageALabel: '图片 A',
                imageBLabel: '图片 B',
                optionA: '图片 A',
                optionB: '图片 B',
                question1: '以下两张街景中，您认为哪张更加适合"坐憩"的行为：',
                question2: '以下两张街景中，您认为哪张更加适合"漫步"的行为：',
                question3: '以下两张街景中，您认为哪张更加适合"慢跑"的行为：',
                question4: '以下两张街景中，您认为哪张更加适合"聚会或聚集"的行为：',
                confirmButtonText: '确认并继续',
                timeWarningText: '请仔细观察图片至少6秒后再进行选择'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                reminderTitle: '?? Experiment Reminder',
                reminderText: 'Please answer carefully. This experiment requires completing 5 groups, with 20 image comparisons each, taking about 20 minutes total to receive the final compensation.',
                reminderDevice: 'For best results, please use a computer or tablet.',
                nicknameLabel: 'Your nickname is:',
                nicknameHint: 'Keep this in mind for getting the participant fees. It is recommended to use your First Name.',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                consentTitle: 'Informed Consent',
                consentAgree: 'I have read and understood the above information and agree to participate in this experiment',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to answer four different behavioral questions for each pair of images. Please choose the street view you think is more suitable for various activities based on your intuition. All questions must be answered before proceeding to the next pair of images.',
                continueTitle: 'Group Comparison Completed',
                continueButton: 'Continue Next Group',
                exitButton: 'Exit Experiment',
                exitWarningTitle: '?? Exit Warning',
                exitWarningMessage: 'You have not completed all 5 groups yet. Exiting now means you will not receive compensation.\n\nAre you sure you want to exit?',
                backButton: 'Return to Continue',
                forceExitButton: 'Confirm Exit',
                finishButton: 'Complete Experiment',
                thankYouTitle: '?? Thank You for Your Participation!',
                thankYouMessage: 'You have successfully completed all 5 groups! Your data has been submitted.\n\nThank you for contributing to street view perception research! Please contact the researchers to claim your compensation.',
                restartButton: 'Start Over',
                nicknameConfirmText: 'Thank you for your participation!',
                imageALabel: 'Image A',
                imageBLabel: 'Image B',
                optionA: 'Image A',
                optionB: 'Image B',
                question1: 'Which of the following two street views do you think is more suitable for "sitting":',
                question2: 'Which of the following two street views do you think is more suitable for "strolling":',
                question3: 'Which of the following two street views do you think is more suitable for "jogging":',
                question4: 'Which of the following two street views do you think is more suitable for "gathering":',
                confirmButtonText: 'Confirm and Continue',
                timeWarningText: 'Please observe the images carefully for at least 6 seconds before making a selection'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'continueMessage' || key === 'thankYouMessage' || key === 'exitWarningMessage') {
                        element.innerHTML = t[key].replace(/\n/g, '<br>');
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            const optionAElements = document.querySelectorAll('.optionA');
            const optionBElements = document.querySelectorAll('.optionB');
            
            optionAElements.forEach(element => {
                element.textContent = t.optionA;
            });
            
            optionBElements.forEach(element => {
                element.textContent = t.optionB;
            });

            if (currentLanguage === 'en') {
                document.getElementById('consentText').innerHTML = `
                    <p class="mb-3"><strong>Research Institution:</strong> Urban Morphology Studio (UMS), Urban Governance and Design Thrust, Hong Kong University of Science and Technology (Guangzhou)</p>
                    <p class="mb-3"><strong>Research Purpose:</strong> This experiment aims to understand people's perception and preference for behavioral suitability in different street environments. Through systematic comparison of street view images, we seek to identify patterns in how individuals assess spatial affordances for various human activities, contributing to evidence-based urban design practices.</p>
                    <p class="mb-3"><strong>Experimental Process:</strong> During the experiment, we will record:</p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Your basic information (nickname, gender, age, professional background)</li>
                        <li>Your choices regarding behavioral suitability of different street view images</li>
                        <li>Your response time and viewing duration</li>
                        <li>Timestamps of your participation</li>
                    </ul>
                    <p class="mb-3"><strong>Data Usage:</strong> All collected data will be used solely for scientific research related to urban design and spatial perception.</p>
                    <p class="mb-3"><strong>We commit to:</strong></p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Strict confidentiality of your personal information</li>
                        <li>Use of data for academic research purposes only</li>
                        <li>Publication of research results in anonymized form</li>
                        <li>Your right to withdraw from the experiment at any time</li>
                    </ul>
                    <p class="mb-3"><strong>Contact Information:</strong> If you have any questions, please contact the research team.</p>
                    <p class="font-semibold">Participation in this experiment indicates that you have fully understood the above content and voluntarily participate.</p>
                `;
            }

            updateContinueMessage();
        }

        function updateContinueMessage() {
            const continueMessage = document.getElementById('continueMessage');
            if (!continueMessage) return;

            const remainingGroups = MAX_GROUPS - currentGroupNumber;
            
            if (currentLanguage === 'zh') {
                if (currentGroupNumber < MAX_GROUPS) {
                    continueMessage.innerHTML = `您已完成了第${currentGroupNumber}组图片对比！<br>还需要完成${remainingGroups}组才能获得报酬。`;
                } else {
                    continueMessage.innerHTML = `恭喜！您已完成全部${MAX_GROUPS}组实验！<br>可以提交数据并获得报酬了。`;
                }
            } else {
                if (currentGroupNumber < MAX_GROUPS) {
                    continueMessage.innerHTML = `You have completed group ${currentGroupNumber}!<br>You need to complete ${remainingGroups} more groups to receive compensation.`;
                } else {
                    continueMessage.innerHTML = `Congratulations! You have completed all ${MAX_GROUPS} groups!<br>You can now submit your data and receive compensation.`;
                }
            }
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'continuePage', 'exitWarningPage', 'thankYouPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');
            const consent = document.getElementById('consentCheckbox').checked;

            if (!nickname || !gender || !age || !professional || !consent) {
                alert(currentLanguage === 'zh' ? '请完整填写所有必填项并同意参与实验！' : 'Please fill in all required fields and agree to participate!');
                return;
            }

            userData = {
                nickname: nickname,
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (fullImageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? '图片库加载失败或图片数量不足！' : 'Image library failed to load or insufficient images!');
                return;
            }

            startNewGroup();
        }

        function startNewGroup() {
            preloadedImages.clear();
            selectImagesForCurrentGroup();
            generateComparisonPairs();
            currentComparisonIndex = 0;
            comparisons = [];
            generateNewComparison();
            showPage('comparisonPage');
            updateGroupCounter();
            updateOverallProgress();
        }

        function updateGroupCounter() {
            const groupText = currentLanguage === 'zh' ? `第 ${currentGroupNumber} 组` : `Group ${currentGroupNumber}`;
            document.getElementById('groupCounter').textContent = groupText;
        }

        function generateComparisonPairs() {
            comparisonPairs = [];
            
            let imagePool = [];
            imageLibrary.forEach(img => {
                imagePool.push(img.id);
                imagePool.push(img.id);
            });
            
            for (let i = imagePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imagePool[i], imagePool[j]] = [imagePool[j], imagePool[i]];
            }
            
            console.log(`图片池创建完成，共 ${imagePool.length} 个图片实例`);
            
            for (let i = 0; i < imagePool.length - 1; i += 2) {
                let imageAId = imagePool[i];
                let imageBId = imagePool[i + 1];
                
                if (imageAId === imageBId && i + 2 < imagePool.length) {
                    for (let k = i + 2; k < imagePool.length; k++) {
                        if (imagePool[k] !== imageAId) {
                            [imagePool[i + 1], imagePool[k]] = [imagePool[k], imagePool[i + 1]];
                            imageBId = imagePool[i + 1];
                            break;
                        }
                    }
                }
                
                if (imageAId !== imageBId) {
                    const imageA = imageLibrary.find(img => img.id === imageAId);
                    const imageB = imageLibrary.find(img => img.id === imageBId);
                    
                    if (imageA && imageB) {
                        comparisonPairs.push({ imageA, imageB });
                    }
                }
                
                if (comparisonPairs.length >= 20) {
                    break;
                }
            }
            
            console.log(`第${currentGroupNumber}组生成了 ${comparisonPairs.length} 组配对`);
        }

        function generateNewComparison() {
            if (currentComparisonIndex >= 20) {
                completeCurrentGroup();
                return;
            }
            
            currentPair = comparisonPairs[currentComparisonIndex];

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            preloadNextPair();

            document.getElementById('progressCounter').textContent = `${currentComparisonIndex + 1}/20`;
            
            resetAllSelections();
            startComparisonTimer();
            updateOverallProgress();
        }

        function resetAllSelections() {
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
            });
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function checkAllAnswered() {
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            const allAnswered = radioGroups.every(group => {
                return document.querySelector(`input[name="${group}"]:checked`) !== null;
            });
            
            const confirmButton = document.getElementById('confirmButton');
            if (allAnswered) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                confirmButton.disabled = true;
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        // 修复：重新组织确认选择的流程，避免缓存清理问题
        async function confirmAllSelections() {
            if (!checkMinimumViewTime()) {
                showTimeWarning();
                return;
            }
            
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            const behaviors = ['坐憩', '漫步', '慢跑', '聚会或聚集'];
            const answers = {};
            
            let allAnswered = true;
            radioGroups.forEach((group, index) => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    answers[group] = {
                        behavior: behaviors[index],
                        choice: selected.value,
                        winner: selected.value === 'A' ? currentPair.imageA.id : currentPair.imageB.id,
                        loser: selected.value === 'A' ? currentPair.imageB.id : currentPair.imageA.id,
                        winnerImage: selected.value === 'A' ? currentPair.imageA.name : currentPair.imageB.name,
                        loserImage: selected.value === 'A' ? currentPair.imageB.name : currentPair.imageA.name
                    };
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert(currentLanguage === 'zh' ? '请回答所有问题！' : 'Please answer all questions!');
                return;
            }

            // 保存当前对比的数据
            comparisons.push({
                imageA: currentPair.imageA,
                imageB: currentPair.imageB,
                answers: answers,
                timestamp: new Date().toISOString(),
                groupNumber: currentGroupNumber,
                comparisonIndex: currentComparisonIndex + 1,
                viewTime: Date.now() - comparisonStartTime
            });

            console.log(`第 ${currentComparisonIndex + 1} 次对比完成，已保存数据`);

            // 先进行清理，但使用当前的索引（未增加）
            cleanupPreloadCache();
            
            // 然后增加索引并生成下一个对比
            currentComparisonIndex++;
            generateNewComparison();
        }

        async function completeCurrentGroup() {
            console.log(`第${currentGroupNumber}组对比完成，共${comparisons.length}次对比`);
            
            const saveSuccess = await saveUserSession();
            
            if (!saveSuccess) {
                const retryMessage = currentLanguage === 'zh' ? 
                    '数据保存失败，请检查网络连接。是否重试？' : 
                    'Data save failed, please check your internet connection. Retry?';
                
                if (confirm(retryMessage)) {
                    const retrySaveSuccess = await saveUserSession();
                    if (!retrySaveSuccess) {
                        alert(currentLanguage === 'zh' ? 
                            '数据保存失败，请联系研究人员。' : 
                            'Data save failed, please contact the researchers.');
                        return;
                    }
                }
            }
            
            updateContinueProgress();
            updateContinueMessage();
            
            if (currentGroupNumber >= MAX_GROUPS) {
                document.getElementById('continueButtons').classList.add('hidden');
                document.getElementById('finishButtons').classList.remove('hidden');
            } else {
                document.getElementById('continueButtons').classList.remove('hidden');
                document.getElementById('finishButtons').classList.add('hidden');
            }
            
            showPage('continuePage');
        }

        function continueNextGroup() {
            if (currentGroupNumber >= MAX_GROUPS) {
                finishSurvey();
                return;
            }
            
            currentGroupNumber++;
            startNewGroup();
        }

        function showExitWarning() {
            if (currentGroupNumber >= MAX_GROUPS) {
                finishSurvey();
                return;
            }
            
            showPage('exitWarningPage');
        }

        function backToContinue() {
            showPage('continuePage');
        }

        function forceExit() {
            restart();
        }

        function finishSurvey() {
            if (currentGroupNumber < MAX_GROUPS) {
                showExitWarning();
                return;
            }
            
            updateThankYouPageWithNickname();
            showPage('thankYouPage');
        }

        function updateThankYouPageWithNickname() {
            const nicknameElement = document.getElementById('thankYouNickname');
            const confirmTextElement = document.getElementById('nicknameConfirmText');
            
            if (userData.nickname) {
                nicknameElement.textContent = userData.nickname;
                
                if (currentLanguage === 'zh') {
                    confirmTextElement.textContent = `感谢您的参与，${userData.nickname}！`;
                } else {
                    confirmTextElement.textContent = `Thank you for your participation, ${userData.nickname}!`;
                }
            }
        }

        function restart() {
            userData = { nickname: '', gender: '', age: '', isProfessional: '' };
            comparisons = [];
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            comparisonPairs = [];
            currentComparisonIndex = 0;
            currentGroupNumber = 1;
            sessionId = generateSessionId();
            preloadedImages.clear();
            comparisonStartTime = null;
            timeWarningShown = false;
            
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('nicknameInput').value = '';
            document.getElementById('ageInput').value = '';
            document.getElementById('consentCheckbox').checked = false;
            
            showPage('languagePage');
        }

        // ====================================================================
        // 管理员界面
        // ====================================================================
        const ENCODED_ADMIN_KEY = 'VU1TMjAyNXlncw==';
        
        function getAdminPassword() {
            return atob(ENCODED_ADMIN_KEY);
        }
        
        async function showAdminPanel() {
            const password = prompt('请输入管理员密码：');
            
            if (password === null) {
                return;
            }
            
            if (password !== getAdminPassword()) {
                alert('密码错误！');
                return;
            }
            
            document.getElementById('adminPanel').classList.remove('hidden');
            await refreshStats();
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // 更新管理员界面以显示多bin状态
        async function refreshStats() {
            try {
                updateDatabaseStatus('正在连接多bin系统...', 'loading');
                disableAdminButtons(true);
                
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                
                const data = await multiBinManager.readAllData();
                const systemStatus = multiBinManager.getSystemStatus();
                
                updateDatabaseStatus(`多bin系统连接成功 (${systemStatus.totalBins} bins)`, 'success');
                disableAdminButtons(false);
                
                // 显示系统状态
                displaySystemStatus(systemStatus);
                
                // 计算统计信息
                const uniqueSessions = new Map();
                (data.sessions || []).forEach(session => {
                    if (!uniqueSessions.has(session.sessionId) || 
                        session.groupsCompleted > uniqueSessions.get(session.sessionId).groupsCompleted) {
                        uniqueSessions.set(session.sessionId, session);
                    }
                });
                
                const totalUsers = uniqueSessions.size;
                const totalComparisons = (data.comparisons || []).length;
                const avgGroups = totalUsers > 0 ? (totalComparisons / totalUsers / 20).toFixed(1) : '0';
                
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalComparisons').textContent = totalComparisons;
                document.getElementById('avgGroups').textContent = avgGroups;
                
                displayRecentComparisons(data.comparisons || []);
                displayUserDetails(Array.from(uniqueSessions.values()));
                
            } catch (error) {
                console.error('刷新失败:', error);
                updateDatabaseStatus('连接多bin系统失败', 'error');
                disableAdminButtons(true);
            }
        }

        // 显示系统状态
        function displaySystemStatus(systemStatus) {
            const systemStatusPanel = document.getElementById('systemStatus');
            const systemStatusContent = document.getElementById('systemStatusContent');
            
            systemStatusPanel.classList.remove('hidden');
            
            let statusHtml = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="font-medium">总Bin数:</span>
                        <span class="text-blue-600 font-semibold">${systemStatus.totalBins}</span>
                    </div>
                    <div>
                        <span class="font-medium">当前活跃Bin:</span>
                        <span class="text-green-600 font-semibold">${systemStatus.currentBinId?.substring(0, 12) || 'N/A'}...</span>
                    </div>
                    <div>
                        <span class="font-medium">当前Bin使用率:</span>
                        <span class="text-purple-600 font-semibold">${systemStatus.usagePercentage}%</span>
                    </div>
                    <div>
                        <span class="font-medium">当前Bin大小:</span>
                        <span class="text-orange-600 font-semibold">${Math.round(systemStatus.currentBinSize / 1024)}KB</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-2">当前Bin容量使用情况</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${systemStatus.usagePercentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${Math.round(systemStatus.currentBinSize / 1024)}KB / ${Math.round(systemStatus.maxBinSize / 1024)}KB
                    </div>
                </div>
                
                <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">所有Bin状态:</div>
                    <div class="space-y-1">
            `;
            
            systemStatus.bins.forEach((bin, index) => {
                const statusClass = bin.status === 'active' ? 'active' : 
                                 bin.status === 'full' ? 'full' : '';
                const statusText = bin.status === 'active' ? '活跃' :
                                bin.status === 'full' ? '已满' : '空闲';
                
                statusHtml += `
                    <div class="bin-status ${statusClass}">
                        <div>
                            <span class="font-medium">Bin ${index + 1}:</span>
                            <span class="text-xs text-gray-600">${bin.binId}</span>
                        </div>
                        <div class="text-sm">
                            <span class="px-2 py-1 rounded text-xs ${
                                bin.status === 'active' ? 'bg-green-100 text-green-700' :
                                bin.status === 'full' ? 'bg-orange-100 text-orange-700' :
                                'bg-gray-100 text-gray-700'
                            }">${statusText}</span>
                            <span class="ml-2 text-gray-600">${bin.sizeKB}KB (${bin.recordCount} 记录)</span>
                        </div>
                    </div>
                `;
            });
            
            statusHtml += `
                    </div>
                </div>
            `;
            
            systemStatusContent.innerHTML = statusHtml;
        }

        function displayRecentComparisons(comparisons) {
            const container = document.getElementById('comparisonData');
            
            if (comparisons.length === 0) {
                container.innerHTML = '<div class="text-gray-500">暂无对比数据</div>';
                return;
            }
            
            const recent = comparisons.slice(-20);
            
            let html = `
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2">昵称</th>
                            <th class="border border-gray-300 p-2">组号</th>
                            <th class="border border-gray-300 p-2">图片A</th>
                            <th class="border border-gray-300 p-2">图片B</th>
                            <th class="border border-gray-300 p-2">坐憩</th>
                            <th class="border border-gray-300 p-2">漫步</th>
                            <th class="border border-gray-300 p-2">慢跑</th>
                            <th class="border border-gray-300 p-2">聚集</th>
                            <th class="border border-gray-300 p-2">时间</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(comp => {
                html += `
                    <tr>
                        <td class="border border-gray-300 p-2">${comp.nickname}</td>
                        <td class="border border-gray-300 p-2">${comp.groupNumber}</td>
                        <td class="border border-gray-300 p-2">${comp.image1_name}</td>
                        <td class="border border-gray-300 p-2">${comp.image2_name}</td>
                        <td class="border border-gray-300 p-2">${comp.sitting === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.strolling === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.jogging === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.gathering === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${new Date(comp.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayUserDetails(sessions) {
            const container = document.getElementById('userDetails');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="text-gray-500">暂无用户数据</div>';
                return;
            }
            
            // 按最后更新时间排序
            const sortedSessions = sessions.sort((a, b) => 
                new Date(b.lastUpdated || b.timestamp) - new Date(a.lastUpdated || a.timestamp)
            );
            
            let html = `
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2">昵称</th>
                            <th class="border border-gray-300 p-2">性别</th>
                            <th class="border border-gray-300 p-2">年龄</th>
                            <th class="border border-gray-300 p-2">专业背景</th>
                            <th class="border border-gray-300 p-2">完成组数</th>
                            <th class="border border-gray-300 p-2">总对比次数</th>
                            <th class="border border-gray-300 p-2">语言</th>
                            <th class="border border-gray-300 p-2">完成状态</th>
                            <th class="border border-gray-300 p-2">最后更新</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedSessions.forEach(session => {
                const isComplete = session.groupsCompleted >= 5;
                const statusText = isComplete ? '已完成' : `进行中 (${session.groupsCompleted}/5)`;
                const statusClass = isComplete ? 'text-green-600 font-semibold' : 'text-blue-600';
                
                html += `
                    <tr>
                        <td class="border border-gray-300 p-2">${session.userData.nickname}</td>
                        <td class="border border-gray-300 p-2">${session.userData.gender === 'male' ? '男' : '女'}</td>
                        <td class="border border-gray-300 p-2">${session.userData.age}</td>
                        <td class="border border-gray-300 p-2">${session.userData.isProfessional === 'yes' ? '是' : '否'}</td>
                        <td class="border border-gray-300 p-2">${session.groupsCompleted}</td>
                        <td class="border border-gray-300 p-2">${session.totalComparisons || 0}</td>
                        <td class="border border-gray-300 p-2">${session.language === 'zh' ? '中文' : 'English'}</td>
                        <td class="border border-gray-300 p-2 ${statusClass}">${statusText}</td>
                        <td class="border border-gray-300 p-2">${new Date(session.lastUpdated || session.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateDatabaseStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('databaseStatus');
            
            let html = '';
            switch (type) {
                case 'loading':
                    html = `
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
                case 'success':
                    html = `
                        <div class="status-indicator status-success">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
                case 'error':
                    html = `
                        <div class="status-indicator status-error">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
            }
            
            statusDiv.innerHTML = html;
        }

        function disableAdminButtons(disabled) {
            document.getElementById('exportButton').disabled = disabled;
            document.getElementById('clearButton').disabled = disabled;
            
            if (disabled) {
                document.getElementById('exportButton').classList.add('disabled:bg-gray-400');
                document.getElementById('clearButton').classList.add('disabled:bg-gray-400');
            } else {
                document.getElementById('exportButton').classList.remove('disabled:bg-gray-400');
                document.getElementById('clearButton').classList.remove('disabled:bg-gray-400');
            }
        }

        async function exportData() {
            try {
                updateDatabaseStatus('正在导出数据...', 'loading');
                
                const data = await multiBinManager.readAllData();
                
                if (!data.comparisons || data.comparisons.length === 0) {
                    alert('没有可导出的数据');
                    return;
                }
                
                // 按照您指定的字段格式创建CSV
                const headers = [
                    'sessionId', 'nickname', 'gender', 'age', 'isProfessional', 
                    'groupNumber', 'comparisonIndex', 'image1_url', 'image2_url', 
                    'image1_name', 'image2_name', 'sitting', 'strolling', 
                    'jogging', 'gathering', 'viewTime_ms', 'timestamp'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                data.comparisons.forEach(comp => {
                    const row = [
                        comp.sessionId,
                        comp.nickname,
                        comp.gender,
                        comp.age,
                        comp.isProfessional,
                        comp.groupNumber,
                        comp.comparisonIndex,
                        `"${comp.image1_url}"`,
                        `"${comp.image2_url}"`,
                        comp.image1_name,
                        comp.image2_name,
                        comp.sitting,
                        comp.strolling,
                        comp.jogging,
                        comp.gathering,
                        comp.viewTime || 0,
                        comp.timestamp
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // 下载文件
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `街景问卷对比数据_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                updateDatabaseStatus('数据导出完成', 'success');
                setTimeout(() => {
                    updateDatabaseStatus('多bin系统连接成功', 'success');
                }, 2000);
                
            } catch (error) {
                console.error('导出失败:', error);
                updateDatabaseStatus('导出失败', 'error');
                alert('导出失败：' + error.message);
            }
        }

        // 更新清空数据函数
        async function clearData() {
            if (!confirm('确定要清空所有数据吗？此操作不可恢复！')) {
                return;
            }
            
            if (!confirm('最后确认：将删除所有bin中的实验数据，确定继续吗？')) {
                return;
            }
            
            try {
                updateDatabaseStatus('正在清空所有bin数据...', 'loading');
                
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                
                await multiBinManager.clearAllData();
                
                updateDatabaseStatus('所有数据已清空', 'success');
                await refreshStats();
                
            } catch (error) {
                console.error('清空失败:', error);
                updateDatabaseStatus('清空失败', 'error');
                alert('清空失败：' + error.message);
            }
        }

        // ====================================================================
        // 页面初始化
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('街景问卷系统启动 - 多Bin版本');
            
            // 初始化多bin管理器
            try {
                await initializeMultiBinManager();
                console.log('多bin系统初始化成功');
            } catch (error) {
                console.log('多bin系统初始化失败，系统仍可运行但可能有存储限制');
                console.error('MultiBin初始化错误:', error);
            }
            
            await initializeImageLibrary();
            
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', checkAllAnswered);
                });
            });
            
            if (isImageLibraryLoaded) {
                console.log(`系统就绪，完整图片库包含 ${fullImageLibrary.length} 张图片`);
            } else {
                console.log('图片库初始化有问题，但系统仍可运行');
            }
            
            console.log('多Bin配置完成');
            if (multiBinManager) {
                const status = multiBinManager.getSystemStatus();
                console.log(`当前系统: ${status.totalBins} 个bin，活跃bin: ${status.currentBinId?.substring(0, 8)}...`);
            }
        });
    </script>
</body>
</html>

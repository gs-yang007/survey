<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡—æ™¯è¡Œä¸ºé—®å·è°ƒç ”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #1a1a1a;
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .image-container {
            width: 666px;
            height: 500px;
        }
        .survey-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .admin-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
        }
        .timer-warning {
            background-color: #fef3c7;
            color: #d97706;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .consent-text {
            max-height: 200px;
            overflow-y: auto;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 6px;
            margin: 12px 0;
        }
        .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-indicator {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background-color: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            transition: width 0.3s ease;
        }
        .experiment-reminder {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .experiment-reminder h4 {
            color: #92400e;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .experiment-reminder p {
            color: #92400e;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        .experiment-reminder ul {
            color: #92400e;
            margin-left: 20px;
            line-height: 1.5;
        }
        .progress-indicator {
            background-color: #e0f2fe;
            border: 1px solid #0284c7;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
            text-align: center;
        }
        .progress-indicator h3 {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .progress-bar-container {
            background-color: #e5e7eb;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-bar-fill {
            background-color: #059669;
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        .user-nickname-highlight {
            background: linear-gradient(45deg, #fef3c7, #f3e8ff);
            border: 2px solid #059669;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }
        .user-nickname-highlight .nickname {
            font-size: 1.5rem;
            font-weight: bold;
            color: #059669;
            margin-bottom: 8px;
        }
        .system-status-panel {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }
        .bin-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: white;
            border-radius: 6px;
            margin: 4px 0;
            border: 1px solid #e5e7eb;
        }
        .bin-status.active {
            border-color: #10b981;
            background-color: #ecfdf5;
        }
        .bin-status.full {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ç®¡ç†å‘˜å…¥å£ -->
    <div class="admin-panel">
        <button onclick="showAdminPanel()" class="bg-gray-800 text-white px-3 py-1 rounded text-xs hover:bg-gray-700">
            ç®¡ç†å‘˜
        </button>
    </div>

    <!-- è°ƒè¯•é¢æ¿ -->
    <div id="debugPanel" class="debug-panel">
        <div>ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
        <div id="debugLog"></div>
        <button onclick="toggleDebug()" style="background: #333; color: #fff; border: none; padding: 2px 5px; margin-top: 5px;">éšè—</button>
    </div>

    <!-- æ•°æ®çŠ¶æ€æŒ‡ç¤ºå™¨ -->
    <div id="dataStatusIndicator" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 hidden">
        <div class="status-indicator">
            <div class="spinner"></div>
            <span id="dataStatusText">æ­£åœ¨ä¿å­˜æ•°æ®...</span>
        </div>
        <div id="saveProgress" class="progress-bar hidden">
            <div class="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <!-- è¯­è¨€é€‰æ‹©é¡µé¢ -->
    <div id="languagePage" class="min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">è¡—æ™¯è¡Œä¸ºæ„ŸçŸ¥é—®å·</h1>
            <h2 class="text-lg text-gray-600 mb-8">Street View Behaviours Questionnaire</h2>
            
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">è¯­è¨€é€‰æ‹©</h3>
                <h4 class="text-md text-gray-600 mb-6">Select Language</h4>
            </div>
            
            <div class="flex justify-center space-x-4">
                <button onclick="selectLanguage('zh')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ä¸­æ–‡
                </button>
                <button onclick="selectLanguage('en')" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    English
                </button>
            </div>
        </div>
    </div>

    <!-- åŸºç¡€ä¿¡æ¯æ”¶é›†é¡µé¢ -->
    <div id="surveyPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-3xl mx-auto">
            <h1 id="surveyTitle" class="text-2xl font-bold text-center text-gray-800 mb-8">çª—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6">
                <!-- å®éªŒæé†’ -->
                <div id="experimentReminder" class="experiment-reminder">
                    <h4 id="reminderTitle">ğŸ”” å®éªŒæé†’</h4>
                    <p id="reminderText">è¯·è®¤çœŸä½œç­”ã€‚æœ¬å®éªŒéœ€è¦å®Œæˆ5ç»„ï¼Œæ¯ç»„20æ¬¡å›¾ç‰‡å¯¹æ¯”ï¼Œè€—æ—¶çº¦20åˆ†é’Ÿï¼Œæ‰èƒ½è·å¾—æœ€ç»ˆæŠ¥é…¬ã€‚</p>
                    <p id="reminderDevice">ä¸ºä¿è¯å®éªŒæ•ˆæœï¼Œè¯·ä½¿ç”¨ç”µè„‘æˆ–å¹³æ¿ç”µè„‘ä½œç­”ã€‚</p>
                </div>

                <div class="space-y-6">
                    <!-- æ˜µç§°è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="nicknameLabel">æ‚¨çš„æ˜µç§°æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="nicknameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="">
                        <p id="nicknameHint" class="text-sm text-gray-500 mt-1">è¯·è®°å¿†ï¼Œå¹¶ç”¨äºå…‘æ¢è¢«è¯•è´¹ç”¨ã€‚å»ºè®®ä½¿ç”¨å§“åæ‹¼éŸ³ã€‚</p>
                    </div>

                    <!-- æ€§åˆ«é€‰æ‹© -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="genderLabel">æ‚¨çš„æ€§åˆ«æ˜¯ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="male" class="mr-2">
                                <span id="maleLabel">ç”·</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gender" value="female" class="mr-2">
                                <span id="femaleLabel">å¥³</span>
                            </label>
                        </div>
                    </div>

                    <!-- å¹´é¾„è¾“å…¥ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="ageLabel">æ‚¨çš„å¹´é¾„ï¼š</span> <span class="text-red-500">*</span>
                        </label>
                        <input type="number" id="ageInput" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" min="1" max="120">
                    </div>

                    <!-- ä¸“ä¸šèƒŒæ™¯ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="professionalLabel">æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="yes" class="mr-2">
                                <span id="yesLabel">æ˜¯</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="professional" value="no" class="mr-2">
                                <span id="noLabel">å¦</span>
                            </label>
                        </div>
                    </div>

                    <!-- çŸ¥æƒ…åŒæ„ -->
                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <span id="consentTitle">å®éªŒçŸ¥æƒ…åŒæ„</span> <span class="text-red-500">*</span>
                        </label>
                        <div class="consent-text">
                            <div id="consentText">
                                <p class="mb-3"><strong>å®éªŒä¸»ä½“ï¼š</strong>é¦™æ¸¯ç§‘æŠ€å¤§å­¦ï¼ˆå¹¿å·ï¼‰åŸå¸‚æ²»ç†ä¸è®¾è®¡å­¦åŸŸUrban Morphology Studio (UMS)</p>
                                <p class="mb-3"><strong>å®éªŒç›®çš„ï¼š</strong>æœ¬å®éªŒæ—¨åœ¨äº†è§£äººä»¬å¯¹ä¸åŒè¡—æ™¯ç¯å¢ƒä¸­è¡Œä¸ºé€‚å®œæ€§çš„æ„ŸçŸ¥å’Œåå¥½ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„è¡—æ™¯å›¾ç‰‡å¯¹æ¯”ï¼Œæˆ‘ä»¬å¸Œæœ›è¯†åˆ«ä¸ªä½“å¦‚ä½•è¯„ä¼°ç©ºé—´å¯¹å„ç§äººç±»æ´»åŠ¨çš„æ”¯æŒæ€§ï¼Œä»è€Œä¸ºå¾ªè¯åŸå¸‚è®¾è®¡å®è·µåšå‡ºè´¡çŒ®ã€‚</p>
                                <p class="mb-3"><strong>å®éªŒè¿‡ç¨‹ï¼š</strong>åœ¨å®éªŒè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†è®°å½•ï¼š</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>æ‚¨çš„åŸºæœ¬ä¿¡æ¯ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€å¹´é¾„ã€ä¸“ä¸šèƒŒæ™¯ï¼‰</li>
                                    <li>æ‚¨å¯¹ä¸åŒè¡—æ™¯å›¾ç‰‡çš„è¡Œä¸ºé€‚å®œæ€§é€‰æ‹©</li>
                                    <li>æ‚¨çš„é€‰æ‹©æ—¶é—´å’Œæµè§ˆæ—¶é•¿</li>
                                    <li>å‚ä¸å®éªŒçš„æ—¶é—´æˆ³</li>
                                </ul>
                                <p class="mb-3"><strong>æ•°æ®ä½¿ç”¨ï¼š</strong>æ”¶é›†çš„æ‰€æœ‰æ•°æ®å°†ä»…ç”¨äºåŸå¸‚è®¾è®¡å’Œç©ºé—´æ„ŸçŸ¥ç›¸å…³çš„ç§‘å­¦ç ”ç©¶ã€‚æˆ‘ä»¬æ‰¿è¯ºï¼š</p>
                                <ul class="list-disc list-inside mb-3 ml-4">
                                    <li>æ‚¨çš„ä¸ªäººä¿¡æ¯å°†è¢«ä¸¥æ ¼ä¿å¯†</li>
                                    <li>æ•°æ®ä»…ç”¨äºå­¦æœ¯ç ”ç©¶ç›®çš„</li>
                                    <li>ç ”ç©¶ç»“æœå°†ä»¥åŒ¿ååŒ–çš„å½¢å¼å‘è¡¨</li>
                                    <li>æ‚¨æœ‰æƒåœ¨ä»»ä½•æ—¶å€™é€€å‡ºå®éªŒ</li>
                                </ul>
                                <p class="mb-3"><strong>è”ç³»æ–¹å¼ï¼š</strong>å¦‚æœ‰ä»»ä½•ç–‘é—®ï¼Œè¯·è”ç³»ç ”ç©¶å›¢é˜Ÿã€‚</p>
                                <p class="font-semibold">å‚ä¸æœ¬å®éªŒå³è¡¨ç¤ºæ‚¨å·²å……åˆ†äº†è§£ä¸Šè¿°å†…å®¹å¹¶è‡ªæ„¿å‚åŠ ã€‚</p>
                            </div>
                        </div>
                        <label class="flex items-start mt-3">
                            <input type="checkbox" id="consentCheckbox" class="mt-1 mr-3">
                            <span id="consentAgree">æˆ‘å·²é˜…è¯»å¹¶ç†è§£ä¸Šè¿°è¯´æ˜ï¼ŒåŒæ„å‚ä¸æœ¬å®éªŒ</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8 text-right">
                    <button onclick="startComparisons()" id="nextButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                        ä¸‹ä¸€éƒ¨åˆ†
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡å¯¹æ¯”é¡µé¢ -->
    <div id="comparisonPage" class="hidden min-h-screen bg-gray-100 p-4">
        <div class="max-w-6xl mx-auto">
            <!-- è¿›åº¦æŒ‡ç¤ºå™¨ -->
            <div id="overallProgressIndicator" class="progress-indicator">
                <h3 id="overallProgressTitle">å®éªŒè¿›åº¦</h3>
                <p id="overallProgressText">ç¬¬ 1 ç»„ / å…± 5 ç»„</p>
                <div class="progress-bar-container">
                    <div id="overallProgressFill" class="progress-bar-fill" style="width: 20%"></div>
                </div>
                <p id="overallProgressDetail" class="text-sm mt-2">å½“å‰ç»„è¿›åº¦: 1/20</p>
            </div>

            <div class="flex justify-between text-gray-800 mb-4">
                <div>
                    <span id="groupCounter">ç¬¬ 1 ç»„</span>
                </div>
                <div>
                    <span id="progressCounter">1/20</span>
                </div>
            </div>
            
            <!-- é¡¶éƒ¨æç¤º -->
            <div class="bg-white rounded-lg p-4 mb-6">
                <h3 id="hintTitle" class="font-bold text-gray-800 mb-2">æç¤º</h3>
                <p id="instructions" class="text-sm text-gray-600">
                    åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚
                </p>
            </div>
            
            <!-- å›¾ç‰‡å±•ç¤ºåŒºåŸŸ -->
            <div class="flex justify-center mb-6 space-x-6">
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageALabel" class="font-bold text-gray-800">å›¾ç‰‡ A</span>
                    </div>
                    <div class="image-container">
                        <img id="imageA_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
                
                <div class="bg-white rounded-lg p-4">
                    <div class="text-center mb-2">
                        <span id="imageBLabel" class="font-bold text-gray-800">å›¾ç‰‡ B</span>
                    </div>
                    <div class="image-container">
                        <img id="imageB_img" src="" alt="" class="survey-image rounded">
                    </div>
                </div>
            </div>
            
            <!-- é—®é¢˜åŒºåŸŸ -->
            <div class="bg-white rounded-lg p-6 mb-6">
                <div class="space-y-6">
                    <!-- é—®é¢˜1ï¼šåæ†© -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question1" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"åæ†©"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="sitting" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜2ï¼šæ¼«æ­¥ -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question2" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ¼«æ­¥"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="strolling" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="strolling" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜3ï¼šæ…¢è·‘ -->
                    <div class="border-b border-gray-200 pb-4">
                        <h3 id="question3" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="jogging" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- é—®é¢˜4ï¼šèšä¼šæˆ–èšé›† -->
                    <div>
                        <h3 id="question4" class="font-bold text-gray-800 mb-3">ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"èšä¼šæˆ–èšé›†"çš„è¡Œä¸ºï¼š</h3>
                        <div class="flex space-x-6">
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="A" class="mr-2">
                                <span class="optionA">å›¾ç‰‡ A</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="gathering" value="B" class="mr-2">
                                <span class="optionB">å›¾ç‰‡ B</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ç¡®è®¤æŒ‰é’® -->
            <div class="text-center">
                <button id="confirmButton" onclick="confirmAllSelections()" disabled class="px-8 py-3 bg-gray-400 text-white rounded-lg transition-colors font-medium cursor-not-allowed">
                    <span id="confirmButtonText">ç¡®è®¤å¹¶ç»§ç»­</span>
                </button>
                
                <!-- æ—¶é—´æç¤º - ç§»åŠ¨åˆ°ç¡®è®¤æŒ‰é’®ä¸‹æ–¹ -->
                <div id="timeWarning" class="timer-warning mt-4 mx-auto max-w-md hidden">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span id="timeWarningText">è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»§ç»­è¯¢é—®é¡µé¢ -->
    <div id="continuePage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="continueTitle" class="text-2xl font-bold text-gray-800 mb-4">æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ</h2>
            <p id="continueMessage" class="text-gray-600 mb-8">æ‚¨å·²å®Œæˆäº†ç¬¬1ç»„å›¾ç‰‡å¯¹æ¯”ï¼<br>è¿˜éœ€è¦å®Œæˆ4ç»„æ‰èƒ½è·å¾—æŠ¥é…¬ã€‚</p>
            
            <!-- æ•´ä½“è¿›åº¦æ¡ -->
            <div class="mb-6">
                <div class="progress-bar-container">
                    <div id="continueProgressFill" class="progress-bar-fill" style="width: 20%"></div>
                </div>
                <p id="continueProgressText" class="text-sm text-gray-600 mt-2">å·²å®Œæˆ 1/5 ç»„</p>
            </div>
            
            <div id="continueButtons" class="flex justify-center space-x-4">
                <button onclick="continueNextGroup()" id="continueButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    ç»§ç»­ä¸‹ä¸€ç»„
                </button>
                <button onclick="showExitWarning()" id="exitButton" class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                    é€€å‡ºå®éªŒ
                </button>
            </div>
            
            <!-- å®Œæˆå…¨éƒ¨å®éªŒçš„æŒ‰é’®ï¼ˆä»…åœ¨å®Œæˆ5ç»„åæ˜¾ç¤ºï¼‰ -->
            <div id="finishButtons" class="hidden flex justify-center space-x-4">
                <button onclick="finishSurvey()" id="finishButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    å®Œæˆå®éªŒ
                </button>
            </div>
        </div>
    </div>

    <!-- é€€å‡ºè­¦å‘Šé¡µé¢ -->
    <div id="exitWarningPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <h2 id="exitWarningTitle" class="text-2xl font-bold text-gray-800 mb-4">âš ï¸ é€€å‡ºè­¦å‘Š</h2>
            <p id="exitWarningMessage" class="text-gray-600 mb-8">æ‚¨è¿˜æœªå®Œæˆå…¨éƒ¨5ç»„å®éªŒï¼Œç°åœ¨é€€å‡ºå°†æ— æ³•è·å¾—æŠ¥é…¬ã€‚<br><br>ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</p>
            
            <div class="flex justify-center space-x-4">
                <button onclick="backToContinue()" id="backButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                    è¿”å›ç»§ç»­å®éªŒ
                </button>
                <button onclick="forceExit()" id="forceExitButton" class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors font-medium">
                    ç¡®å®šé€€å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- æ„Ÿè°¢é¡µé¢ -->
    <div id="thankYouPage" class="hidden min-h-screen bg-gray-100 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 text-center max-w-md w-full">
            <!-- ç”¨æˆ·æ˜µç§°é«˜äº®æ˜¾ç¤º -->
            <div class="user-nickname-highlight">
                <div class="nickname" id="thankYouNickname">ç”¨æˆ·æ˜µç§°</div>
                <p id="nicknameConfirmText" class="text-sm text-gray-600">æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
            </div>
            
            <h2 id="thankYouTitle" class="text-2xl font-bold text-gray-800 mb-4">ğŸ‰ æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</h2>
            <p id="thankYouMessage" class="text-gray-600 mb-8">æ‚¨å·²æˆåŠŸå®Œæˆå…¨éƒ¨5ç»„å®éªŒï¼Œæ•°æ®å·²æäº¤ï¼<br><br>æ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼è¯·è”ç³»ç ”ç©¶äººå‘˜å…‘æ¢æŠ¥é…¬ã€‚</p>
            
            <button onclick="restart()" id="restartButton" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium">
                é‡æ–°å¼€å§‹
            </button>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜ç•Œé¢ -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-lg max-w-6xl w-full max-h-full overflow-auto">
            <div class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ç®¡ç†å‘˜é¢æ¿</h2>
                    <button onclick="hideAdminPanel()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <!-- æ•°æ®åº“çŠ¶æ€ -->
                <div id="databaseStatus" class="mb-6">
                    <div class="loading-indicator">
                        <div class="spinner"></div>
                        <span>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</span>
                    </div>
                </div>

                <!-- ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
                <div id="systemStatus" class="system-status-panel mb-6 hidden">
                    <h4 class="font-semibold text-gray-800 mb-3">å¤šBinç³»ç»ŸçŠ¶æ€</h4>
                    <div id="systemStatusContent">
                        <!-- ç³»ç»ŸçŠ¶æ€å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-blue-800">æ€»å‚ä¸äººæ•°</h3>
                        <p id="totalUsers" class="text-2xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800">æ€»å¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="totalComparisons" class="text-2xl font-bold text-green-600">-</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800">å¹³å‡æ¯äººå¯¹æ¯”æ¬¡æ•°</h3>
                        <p id="avgGroups" class="text-2xl font-bold text-purple-600">-</p>
                    </div>
                </div>
                
                <div class="flex space-x-4 mb-6">
                    <button onclick="exportData()" id="exportButton" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>
                        å¯¼å‡ºæ•°æ®è¡¨æ ¼
                    </button>
                    <button onclick="clearData()" id="clearButton" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 disabled:bg-gray-400" disabled>
                        æ¸…ç©ºæ•°æ®
                    </button>
                    <button onclick="refreshStats()" id="refreshButton" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-4">æœ€è¿‘çš„å¯¹æ¯”æ•°æ®</h3>
                    <div id="comparisonData" class="overflow-auto max-h-96">
                        <div class="text-gray-500">åŠ è½½ä¸­...</div>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-4">ç”¨æˆ·è¯¦æƒ…</h3>
                    <div id="userDetails" class="overflow-auto max-h-64">
                        <div class="text-gray-500">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // å¤šBinç®¡ç†é…ç½®
        // ====================================================================
        const MULTI_BIN_CONFIG = {
            masterKey: '$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.',
            baseUrl: 'https://api.jsonbin.io/v3/b',
            // ä¸»æ§åˆ¶bin - å­˜å‚¨æ‰€æœ‰å­binçš„ç´¢å¼•ä¿¡æ¯
            masterBinId: '68af17fed0ea881f40683b2d',
            // æ•°æ®å¤§å°é™åˆ¶ (å­—èŠ‚) - è®¾ç½®ä¸º800KBä¸ºå®‰å…¨èµ·è§
            maxBinSize: 800 * 1024,
            headers: {
                'Content-Type': 'application/json',
                'X-Master-Key': '$2a$10$BBcDpoJ9fYY0c3xkth3aM.UsL3kMY1SjrqgnbeaxjWNXH4Uwqz5H.'
            }
        };

        // ====================================================================
        // å¤šBinç®¡ç†å™¨ç±»
        // ====================================================================
        class MultiBinManager {
            constructor(config) {
                this.config = config;
                this.currentBinInfo = null;
                this.allBins = [];
            }

            // è·å–æ•°æ®çš„å­—èŠ‚å¤§å°
            getDataSize(data) {
                return new Blob([JSON.stringify(data)]).size;
            }

            // è¯»å–ä¸»æ§åˆ¶binï¼Œè·å–æ‰€æœ‰å­binä¿¡æ¯
            async readMasterBin() {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${this.config.masterBinId}/latest`, {
                        method: 'GET',
                        headers: this.config.headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`è¯»å–ä¸»æ§åˆ¶binå¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    debugLog(`âŒ è¯»å–ä¸»æ§åˆ¶binå¤±è´¥: ${error.message}`);
                    // è¿”å›åˆå§‹ç»“æ„
                    return {
                        dataBins: [],
                        totalRecords: 0,
                        lastUpdated: new Date().toISOString(),
                        version: '1.0'
                    };
                }
            }

            // æ›´æ–°ä¸»æ§åˆ¶bin
            async updateMasterBin(masterData) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${this.config.masterBinId}`, {
                        method: 'PUT',
                        headers: this.config.headers,
                        body: JSON.stringify(masterData)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°ä¸»æ§åˆ¶binå¤±è´¥: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    debugLog(`âŒ æ›´æ–°ä¸»æ§åˆ¶binå¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // åˆ›å»ºæ–°çš„æ•°æ®bin
            async createNewDataBin() {
                try {
                    const initialData = {
                        sessions: [],
                        comparisons: [],
                        binInfo: {
                            createdAt: new Date().toISOString(),
                            recordCount: 0
                        },
                        lastUpdated: new Date().toISOString()
                    };

                    const response = await fetch(`${this.config.baseUrl}`, {
                        method: 'POST',
                        headers: this.config.headers,
                        body: JSON.stringify(initialData)
                    });

                    if (!response.ok) {
                        throw new Error(`åˆ›å»ºæ–°binå¤±è´¥: ${response.status}`);
                    }

                    const result = await response.json();
                    const newBinId = result.metadata.id;
                    
                    debugLog(`âœ… åˆ›å»ºæ–°æ•°æ®binæˆåŠŸ: ${newBinId}`);
                    
                    return {
                        binId: newBinId,
                        createdAt: new Date().toISOString(),
                        recordCount: 0,
                        estimatedSize: this.getDataSize(initialData),
                        status: 'active'
                    };
                } catch (error) {
                    debugLog(`âŒ åˆ›å»ºæ–°æ•°æ®binå¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // è¯»å–æŒ‡å®šæ•°æ®bin
            async readDataBin(binId) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${binId}/latest`, {
                        method: 'GET',
                        headers: this.config.headers
                    });
                    
                    if (!response.ok) {
                        throw new Error(`è¯»å–æ•°æ®binå¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.record;
                } catch (error) {
                    debugLog(`âŒ è¯»å–æ•°æ®bin ${binId} å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // æ›´æ–°æŒ‡å®šæ•°æ®bin
            async updateDataBin(binId, data) {
                try {
                    const response = await fetch(`${this.config.baseUrl}/${binId}`, {
                        method: 'PUT',
                        headers: this.config.headers,
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`æ›´æ–°æ•°æ®binå¤±è´¥: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    debugLog(`âŒ æ›´æ–°æ•°æ®bin ${binId} å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // åˆå§‹åŒ–å¤šbinç³»ç»Ÿ
            async initialize() {
                try {
                    debugLog('ğŸš€ åˆå§‹åŒ–å¤šbinç®¡ç†ç³»ç»Ÿ...');
                    
                    const masterData = await this.readMasterBin();
                    this.allBins = masterData.dataBins || [];
                    
                    if (this.allBins.length === 0) {
                        debugLog('ğŸ“¦ æ²¡æœ‰å‘ç°æ•°æ®binï¼Œåˆ›å»ºç¬¬ä¸€ä¸ª...');
                        const newBin = await this.createNewDataBin();
                        this.allBins = [newBin];
                        
                        // æ›´æ–°ä¸»æ§åˆ¶bin
                        masterData.dataBins = this.allBins;
                        masterData.lastUpdated = new Date().toISOString();
                        await this.updateMasterBin(masterData);
                    }
                    
                    // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„binï¼ˆæœ€åä¸€ä¸ªï¼‰
                    this.currentBinInfo = this.allBins[this.allBins.length - 1];
                    
                    debugLog(`âœ… å¤šbinç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œå…± ${this.allBins.length} ä¸ªbin`);
                    debugLog(`ğŸ“ å½“å‰æ´»è·ƒbin: ${this.currentBinInfo.binId}`);
                    
                    return true;
                } catch (error) {
                    debugLog(`âŒ å¤šbinç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // æ£€æŸ¥å½“å‰binæ˜¯å¦éœ€è¦åˆ‡æ¢
            async checkAndSwitchBin(newDataSize) {
                const estimatedNewSize = this.currentBinInfo.estimatedSize + newDataSize;
                
                if (estimatedNewSize > this.config.maxBinSize) {
                    debugLog(`ğŸ“Š å½“å‰binå³å°†è¶…é™ (${estimatedNewSize} > ${this.config.maxBinSize})ï¼Œåˆ›å»ºæ–°bin...`);
                    
                    // æ ‡è®°å½“å‰binä¸ºå·²æ»¡
                    this.currentBinInfo.status = 'full';
                    
                    // åˆ›å»ºæ–°bin
                    const newBin = await this.createNewDataBin();
                    this.allBins.push(newBin);
                    this.currentBinInfo = newBin;
                    
                    // æ›´æ–°ä¸»æ§åˆ¶bin
                    const masterData = await this.readMasterBin();
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    debugLog(`âœ… å·²åˆ‡æ¢åˆ°æ–°bin: ${this.currentBinInfo.binId}`);
                    
                    return true;
                }
                
                return false;
            }

            // ä¿å­˜ä¼šè¯æ•°æ®ï¼ˆè‡ªåŠ¨å¤„ç†å¤šbinï¼‰
            async saveUserSession(sessionData, comparisonRecords) {
                try {
                    debugLog(`ğŸ’¾ å¼€å§‹ä¿å­˜ä¼šè¯æ•°æ®ï¼Œå¯¹æ¯”è®°å½•æ•°: ${comparisonRecords.length}`);
                    
                    // ä¼°ç®—æ–°æ•°æ®å¤§å°
                    const newDataSize = this.getDataSize({
                        sessions: [sessionData],
                        comparisons: comparisonRecords
                    });
                    
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢bin
                    await this.checkAndSwitchBin(newDataSize);
                    
                    // è¯»å–å½“å‰æ´»è·ƒbinçš„æ•°æ®
                    const currentData = await this.readDataBin(this.currentBinInfo.binId);
                    
                    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨è¯¥ç”¨æˆ·çš„ä¼šè¯è®°å½•
                    const existingSessions = currentData.sessions || [];
                    const existingSessionIndex = existingSessions.findIndex(
                        session => session.sessionId === sessionData.sessionId
                    );
                    
                    let updatedSessions;
                    if (existingSessionIndex !== -1) {
                        // æ›´æ–°ç°æœ‰ä¼šè¯è®°å½•
                        updatedSessions = [...existingSessions];
                        updatedSessions[existingSessionIndex] = {
                            ...updatedSessions[existingSessionIndex],
                            ...sessionData,
                            lastUpdated: new Date().toISOString()
                        };
                        debugLog(`âœ… æ›´æ–°ç°æœ‰ç”¨æˆ·ä¼šè¯: ${sessionData.userData.nickname}`);
                    } else {
                        // åˆ›å»ºæ–°ä¼šè¯è®°å½•
                        updatedSessions = [...existingSessions, sessionData];
                        debugLog(`âœ… åˆ›å»ºæ–°ç”¨æˆ·ä¼šè¯: ${sessionData.userData.nickname}`);
                    }
                    
                    // åˆå¹¶æ–°çš„å¯¹æ¯”æ•°æ®
                    const updatedData = {
                        ...currentData,
                        sessions: updatedSessions,
                        comparisons: [...(currentData.comparisons || []), ...comparisonRecords],
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // ä¿å­˜åˆ°å½“å‰æ´»è·ƒbin
                    await this.updateDataBin(this.currentBinInfo.binId, updatedData);
                    
                    // æ›´æ–°binä¿¡æ¯
                    this.currentBinInfo.recordCount += comparisonRecords.length;
                    this.currentBinInfo.estimatedSize = this.getDataSize(updatedData);
                    
                    // æ›´æ–°ä¸»æ§åˆ¶binä¸­çš„ç»Ÿè®¡ä¿¡æ¯
                    const masterData = await this.readMasterBin();
                    masterData.totalRecords += comparisonRecords.length;
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    debugLog(`âœ… ä¼šè¯æ•°æ®ä¿å­˜æˆåŠŸåˆ°bin: ${this.currentBinInfo.binId}`);
                    return true;
                    
                } catch (error) {
                    debugLog(`âŒ ä¿å­˜ä¼šè¯æ•°æ®å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // è¯»å–æ‰€æœ‰æ•°æ®ï¼ˆä»æ‰€æœ‰binï¼‰
            async readAllData() {
                try {
                    debugLog('ğŸ“š å¼€å§‹è¯»å–æ‰€æœ‰binçš„æ•°æ®...');
                    
                    const allSessions = [];
                    const allComparisons = [];
                    
                    for (const binInfo of this.allBins) {
                        try {
                            const binData = await this.readDataBin(binInfo.binId);
                            
                            if (binData.sessions) {
                                allSessions.push(...binData.sessions);
                            }
                            if (binData.comparisons) {
                                allComparisons.push(...binData.comparisons);
                            }
                            
                            debugLog(`âœ… ä»bin ${binInfo.binId} è¯»å–åˆ° ${binData.sessions?.length || 0} ä¸ªä¼šè¯ï¼Œ${binData.comparisons?.length || 0} æ¡å¯¹æ¯”è®°å½•`);
                        } catch (error) {
                            debugLog(`âš ï¸ è¯»å–bin ${binInfo.binId} å¤±è´¥: ${error.message}`);
                        }
                    }
                    
                    debugLog(`ğŸ“Š æ€»è®¡è¯»å–: ${allSessions.length} ä¸ªä¼šè¯ï¼Œ${allComparisons.length} æ¡å¯¹æ¯”è®°å½•`);
                    
                    return {
                        sessions: allSessions,
                        comparisons: allComparisons,
                        lastUpdated: new Date().toISOString()
                    };
                    
                } catch (error) {
                    debugLog(`âŒ è¯»å–æ‰€æœ‰æ•°æ®å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            async clearAllData() {
                try {
                    debugLog('ğŸ—‘ï¸ å¼€å§‹æ¸…ç©ºæ‰€æœ‰binæ•°æ®...');
                    
                    // æ¸…ç©ºæ‰€æœ‰æ•°æ®binï¼ˆä¿ç•™binæœ¬èº«ï¼Œåªæ¸…ç©ºå†…å®¹ï¼‰
                    for (const binInfo of this.allBins) {
                        const emptyData = {
                            sessions: [],
                            comparisons: [],
                            binInfo: {
                                createdAt: binInfo.createdAt,
                                recordCount: 0
                            },
                            lastUpdated: new Date().toISOString()
                        };
                        
                        await this.updateDataBin(binInfo.binId, emptyData);
                        binInfo.recordCount = 0;
                        binInfo.estimatedSize = this.getDataSize(emptyData);
                        binInfo.status = binInfo === this.currentBinInfo ? 'active' : 'empty';
                    }
                    
                    // æ›´æ–°ä¸»æ§åˆ¶bin
                    const masterData = await this.readMasterBin();
                    masterData.totalRecords = 0;
                    masterData.dataBins = this.allBins;
                    masterData.lastUpdated = new Date().toISOString();
                    await this.updateMasterBin(masterData);
                    
                    debugLog('âœ… æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
                    return true;
                    
                } catch (error) {
                    debugLog(`âŒ æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`);
                    throw error;
                }
            }

            // è·å–ç³»ç»ŸçŠ¶æ€
            getSystemStatus() {
                return {
                    totalBins: this.allBins.length,
                    currentBinId: this.currentBinInfo?.binId,
                    currentBinSize: this.currentBinInfo?.estimatedSize,
                    maxBinSize: this.config.maxBinSize,
                    usagePercentage: this.currentBinInfo ? 
                        Math.round((this.currentBinInfo.estimatedSize / this.config.maxBinSize) * 100) : 0,
                    bins: this.allBins.map(bin => ({
                        binId: bin.binId.substring(0, 8) + '...',
                        status: bin.status,
                        recordCount: bin.recordCount,
                        sizeKB: Math.round(bin.estimatedSize / 1024)
                    }))
                };
            }
        }

        // ====================================================================
        // å…¨å±€å¤šbinç®¡ç†å™¨å®ä¾‹
        // ====================================================================
        let multiBinManager = null;

        // åˆå§‹åŒ–å¤šbinç®¡ç†å™¨
        async function initializeMultiBinManager() {
            if (!multiBinManager) {
                multiBinManager = new MultiBinManager(MULTI_BIN_CONFIG);
                await multiBinManager.initialize();
            }
            return multiBinManager;
        }

        // ====================================================================
        // é…ç½®å’Œå…¨å±€å˜é‡
        // ====================================================================
        const DEBUG_MODE = false;
        const MAX_GROUPS = 5;
        let debugVisible = false;

        const DEMO_IMAGES = [
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff7d0a1-08b4-4bb4-8e89-50936e51f395_5345.png',
            'https://res.cloudinary.com/dw3huanrk/image/upload/my_website_images/batch_upload/fff11158-a3d5-4e96-9c02-92dd8a42566a_5344.png'
        ];

        let fullImageLibrary = [];
        let imageLibrary = [];
        let isImageLibraryLoaded = false;
        let currentLanguage = 'zh';
        let userData = { nickname: '', gender: '', age: '', isProfessional: '' };
        let comparisons = [];
        let currentPair = { imageA: null, imageB: null };
        let selectedOption = null;
        let comparisonPairs = [];
        let currentComparisonIndex = 0;
        let currentGroupNumber = 1;
        let sessionId = generateSessionId();
        let preloadedImages = new Map();
        
        let comparisonStartTime = null;
        let minimumViewTime = 6000;
        let timeWarningShown = false;

        // ====================================================================
        // è¾…åŠ©å‡½æ•°
        // ====================================================================
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function debugLog(message) {
            if (DEBUG_MODE) {
                console.log(message);
                const debugLog = document.getElementById('debugLog');
                if (debugLog) {
                    debugLog.innerHTML += '<div>' + message + '</div>';
                    debugLog.scrollTop = debugLog.scrollHeight;
                }
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            debugVisible = !debugVisible;
            panel.style.display = debugVisible ? 'block' : 'none';
        }

        // ====================================================================
        // æ›¿æ¢çš„JSONBinå‡½æ•°
        // ====================================================================

        // æ›¿æ¢åŸæ¥çš„ readFromJsonBin å‡½æ•°
        async function readFromJsonBin() {
            try {
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                return await multiBinManager.readAllData();
            } catch (error) {
                debugLog(`âŒ ä»å¤šbinè¯»å–æ•°æ®å¤±è´¥: ${error.message}`);
                return {
                    sessions: [],
                    comparisons: [],
                    lastUpdated: new Date().toISOString()
                };
            }
        }

        // æ›¿æ¢åŸæ¥çš„ saveUserSession å‡½æ•°
        async function saveUserSession() {
            try {
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }

                debugLog(`ğŸ’¾ å¼€å§‹æäº¤ç”¨æˆ·ä¼šè¯: ${sessionId}, å¯¹æ¯”æ•°é‡: ${comparisons.length}`);
                
                const newSessionData = {
                    sessionId: sessionId,
                    userData: userData,
                    groupsCompleted: currentGroupNumber,
                    totalComparisons: comparisons.length,
                    timestamp: new Date().toISOString(),
                    language: currentLanguage,
                    lastUpdated: new Date().toISOString()
                };
                
                const newComparisonRecords = comparisons.map(comparison => ({
                    sessionId: sessionId,
                    nickname: userData.nickname,
                    gender: userData.gender,
                    age: userData.age,
                    isProfessional: userData.isProfessional,
                    groupNumber: comparison.groupNumber,
                    comparisonIndex: comparison.comparisonIndex,
                    image1_url: comparison.imageA.url,
                    image2_url: comparison.imageB.url,
                    image1_name: comparison.imageA.name,
                    image2_name: comparison.imageB.name,
                    sitting: comparison.answers.sitting ? (comparison.answers.sitting.choice === 'A' ? 0 : 1) : null,
                    strolling: comparison.answers.strolling ? (comparison.answers.strolling.choice === 'A' ? 0 : 1) : null,
                    jogging: comparison.answers.jogging ? (comparison.answers.jogging.choice === 'A' ? 0 : 1) : null,
                    gathering: comparison.answers.gathering ? (comparison.answers.gathering.choice === 'A' ? 0 : 1) : null,
                    viewTime: comparison.viewTime || 0,
                    timestamp: comparison.timestamp
                }));
                
                showDataStatus('æ­£åœ¨ä¿å­˜æ•°æ®åˆ°å¤šbinç³»ç»Ÿ...', 'loading');
                
                await multiBinManager.saveUserSession(newSessionData, newComparisonRecords);
                
                debugLog(`âœ… æ•°æ®ä¿å­˜æˆåŠŸåˆ°å¤šbinç³»ç»Ÿ`);
                showDataStatus('æ•°æ®ä¿å­˜æˆåŠŸ', 'success');
                setTimeout(hideDataStatus, 2000);
                
                return true;
                
            } catch (error) {
                debugLog(`âŒ ä¿å­˜å¤±è´¥: ${error.message}`);
                showDataStatus('æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
                setTimeout(hideDataStatus, 5000);
                return false;
            }
        }

        // ====================================================================
        // æ—¶é—´æ§åˆ¶å‡½æ•°
        // ====================================================================
        function startComparisonTimer() {
            comparisonStartTime = Date.now();
            timeWarningShown = false;
            hideTimeWarning();
        }

        function checkMinimumViewTime() {
            if (!comparisonStartTime) return true;
            
            const elapsed = Date.now() - comparisonStartTime;
            return elapsed >= minimumViewTime;
        }

        function showTimeWarning() {
            const warning = document.getElementById('timeWarning');
            const warningText = document.getElementById('timeWarningText');
            
            if (currentLanguage === 'zh') {
                warningText.textContent = 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©';
            } else {
                warningText.textContent = 'Please observe the images carefully for at least 6 seconds before making a selection';
            }
            
            warning.classList.remove('hidden');
            timeWarningShown = true;
            
            setTimeout(() => {
                hideTimeWarning();
            }, 3000);
        }

        function hideTimeWarning() {
            document.getElementById('timeWarning').classList.add('hidden');
        }

        // ====================================================================
        // URLå¤„ç†å‡½æ•°
        // ====================================================================
        function extractImageName(url) {
            const parts = url.split('/');
            const filename = parts[parts.length - 1];
            return filename.replace(/\.(jpg|jpeg|png|gif|webp)$/i, '');
        }

        function buildFallbackUrl(originalUrl) {
            const hash = hashCode(originalUrl);
            const id = Math.abs(hash) % 1000;
            return `https://picsum.photos/seed/${id}/666/500`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash;
        }

        // ====================================================================
        // å›¾ç‰‡åº“åˆå§‹åŒ–
        // ====================================================================
        async function initializeImageLibrary() {
            debugLog('ğŸš€ åˆå§‹åŒ–å®Œæ•´å›¾ç‰‡åº“...');
            
            let imageUrls = await loadImageUrlsFromFile();
            
            if (!imageUrls || imageUrls.length === 0) {
                debugLog('ğŸ“ æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æ¼”ç¤ºå›¾ç‰‡åˆ—è¡¨');
                imageUrls = DEMO_IMAGES;
            }
            
            fullImageLibrary = imageUrls.map((url, index) => ({
                id: index + 1,
                name: extractImageName(url),
                url: url.trim(),
                fallbackUrl: buildFallbackUrl(url)
            }));
            
            const minImagesNeeded = 20;
            if (fullImageLibrary.length < minImagesNeeded) {
                debugLog(`âš ï¸ å›¾ç‰‡æ•°é‡ä¸è¶³(${fullImageLibrary.length}å¼ )ï¼Œéœ€è¦è‡³å°‘${minImagesNeeded}å¼ `);
                const originalLibrary = [...fullImageLibrary];
                while (fullImageLibrary.length < minImagesNeeded) {
                    fullImageLibrary.push(...originalLibrary.map((img, index) => ({
                        ...img,
                        id: fullImageLibrary.length + index + 1
                    })));
                }
                debugLog(`âœ… å·²è°ƒæ•´å®Œæ•´å›¾ç‰‡åº“åˆ°${fullImageLibrary.length}å¼ å›¾ç‰‡`);
            }
            
            isImageLibraryLoaded = true;
            debugLog(`âœ… å®Œæ•´å›¾ç‰‡åº“åˆå§‹åŒ–å®Œæˆï¼Œå…± ${fullImageLibrary.length} å¼ å›¾ç‰‡`);
        }

        function selectImagesForCurrentGroup() {
            debugLog(`ğŸ² ä¸ºç¬¬${currentGroupNumber}ç»„é€‰æ‹©æ–°çš„å›¾ç‰‡...`);
            
            const minImagesNeeded = 20;
            
            if (fullImageLibrary.length >= minImagesNeeded) {
                const shuffled = [...fullImageLibrary].sort(() => 0.5 - Math.random());
                imageLibrary = shuffled.slice(0, minImagesNeeded);
            } else {
                imageLibrary = [];
                const originalCount = fullImageLibrary.length;
                for (let i = 0; i < minImagesNeeded; i++) {
                    const originalImg = fullImageLibrary[i % originalCount];
                    imageLibrary.push({
                        ...originalImg,
                        id: i + 1
                    });
                }
                imageLibrary.sort(() => 0.5 - Math.random());
            }
            
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„å›¾ç‰‡é€‰æ‹©å®Œæˆï¼Œå…± ${imageLibrary.length} å¼ å›¾ç‰‡`);
            debugLog(`ğŸ“‹ æœ¬ç»„ä½¿ç”¨çš„å›¾ç‰‡: ${imageLibrary.map(img => img.name.substring(0, 8)).join(', ')}`);
        }

        async function loadImageUrlsFromFile() {
            try {
                const response = await fetch('image_list.txt');
                if (!response.ok) throw new Error('æ–‡ä»¶ä¸å­˜åœ¨');
                
                const text = await response.text();
                const urls = text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0 && !line.startsWith('#'))
                    .filter(line => line.startsWith('http'));
                
                debugLog(`ğŸ“‹ ä»æ–‡ä»¶åŠ è½½äº† ${urls.length} ä¸ªå›¾ç‰‡URL`);
                return urls;
            } catch (error) {
                debugLog(`âŒ åŠ è½½å›¾ç‰‡åˆ—è¡¨æ–‡ä»¶å¤±è´¥: ${error.message}`);
                return null;
            }
        }

        function loadImageWithFallback(imgElement, imageData, callback) {
            debugLog(`ğŸ–¼ï¸ åŠ è½½å›¾ç‰‡: ${imageData.name}`);
            
            const preloadedImageKey = `${imageData.id}_${imageData.url}`;
            if (preloadedImages.has(preloadedImageKey)) {
                const preloadedImg = preloadedImages.get(preloadedImageKey);
                if (preloadedImg.complete && preloadedImg.naturalHeight !== 0) {
                    debugLog(`âœ… ä½¿ç”¨é¢„åŠ è½½çš„å›¾ç‰‡: ${imageData.name}`);
                    imgElement.src = preloadedImg.src;
                    if (callback) callback(true);
                    return;
                }
            }
            
            imgElement.onload = function() {
                debugLog(`âœ… å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½æˆåŠŸ`);
                if (callback) callback(true);
            };
            
            imgElement.onerror = function() {
                debugLog(`âŒ å›¾ç‰‡ ${imageData.name} åŸå§‹URLåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨å›¾ç‰‡`);
                
                imgElement.onload = function() {
                    debugLog(`âœ… å›¾ç‰‡ ${imageData.name} é€šè¿‡å¤‡ç”¨æºåŠ è½½æˆåŠŸ`);
                    if (callback) callback(true);
                };
                
                imgElement.onerror = function() {
                    debugLog(`âŒ å›¾ç‰‡ ${imageData.name} æ‰€æœ‰æºéƒ½æ— æ³•åŠ è½½`);
                    imgElement.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjY2IiBoZWlnaHQ9IjUwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzk5YTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPuWbvueJh+aauOaXoOazleWKoOi9rTwvdGV4dD48L3N2Zz4=';
                    if (callback) callback(false);
                };
                
                imgElement.src = imageData.fallbackUrl;
            };
            
            imgElement.src = imageData.url;
        }

        function preloadImage(imageData) {
            return new Promise((resolve) => {
                const preloadedImageKey = `${imageData.id}_${imageData.url}`;
                
                if (preloadedImages.has(preloadedImageKey)) {
                    resolve(preloadedImages.get(preloadedImageKey));
                    return;
                }
                
                const img = new Image();
                
                img.onload = function() {
                    debugLog(`ğŸš€ é¢„åŠ è½½æˆåŠŸ: ${imageData.name}`);
                    preloadedImages.set(preloadedImageKey, img);
                    resolve(img);
                };
                
                img.onerror = function() {
                    debugLog(`âŒ é¢„åŠ è½½åŸå§‹URLå¤±è´¥ï¼Œå°è¯•å¤‡ç”¨URL: ${imageData.name}`);
                    
                    const fallbackImg = new Image();
                    fallbackImg.onload = function() {
                        debugLog(`ğŸš€ é¢„åŠ è½½å¤‡ç”¨URLæˆåŠŸ: ${imageData.name}`);
                        preloadedImages.set(preloadedImageKey, fallbackImg);
                        resolve(fallbackImg);
                    };
                    
                    fallbackImg.onerror = function() {
                        debugLog(`âŒ é¢„åŠ è½½æ‰€æœ‰URLéƒ½å¤±è´¥: ${imageData.name}`);
                        resolve(null);
                    };
                    
                    fallbackImg.src = imageData.fallbackUrl;
                };
                
                img.src = imageData.url;
            });
        }

        function preloadNextPair() {
            const nextIndex = currentComparisonIndex + 1;
            if (nextIndex < comparisonPairs.length) {
                const nextPair = comparisonPairs[nextIndex];
                debugLog(`ğŸ”„ å¼€å§‹é¢„åŠ è½½ä¸‹ä¸€å¯¹å›¾ç‰‡ (${nextIndex + 1}/${comparisonPairs.length})`);
                
                Promise.all([
                    preloadImage(nextPair.imageA),
                    preloadImage(nextPair.imageB)
                ]).then(() => {
                    debugLog(`âœ… ä¸‹ä¸€å¯¹å›¾ç‰‡é¢„åŠ è½½å®Œæˆ`);
                }).catch((error) => {
                    debugLog(`âŒ é¢„åŠ è½½å¤±è´¥: ${error}`);
                });
            }
        }

        function cleanupPreloadCache() {
            const keepKeys = new Set();
            
            if (currentComparisonIndex < comparisonPairs.length) {
                const currentPair = comparisonPairs[currentComparisonIndex];
                keepKeys.add(`${currentPair.imageA.id}_${currentPair.imageA.url}`);
                keepKeys.add(`${currentPair.imageB.id}_${currentPair.imageB.url}`);
            }
            
            if (currentComparisonIndex + 1 < comparisonPairs.length) {
                const nextPair = comparisonPairs[currentComparisonIndex + 1];
                keepKeys.add(`${nextPair.imageA.id}_${nextPair.imageA.url}`);
                keepKeys.add(`${nextPair.imageB.id}_${nextPair.imageB.url}`);
            }
            
            for (const key of preloadedImages.keys()) {
                if (!keepKeys.has(key)) {
                    preloadedImages.delete(key);
                }
            }
        }

        // ====================================================================
        // æ•°æ®çŠ¶æ€æ˜¾ç¤ºå‡½æ•°
        // ====================================================================
        function showDataStatus(message, type = 'loading') {
            const indicator = document.getElementById('dataStatusIndicator');
            const statusDiv = indicator.querySelector('.status-indicator');
            const textElement = document.getElementById('dataStatusText');
            const spinner = statusDiv.querySelector('.spinner');

            statusDiv.className = 'status-indicator';
            
            switch (type) {
                case 'loading':
                    statusDiv.classList.add('status-warning');
                    spinner.style.display = 'block';
                    break;
                case 'success':
                    statusDiv.classList.add('status-success');
                    spinner.style.display = 'none';
                    break;
                case 'error':
                    statusDiv.classList.add('status-error');
                    spinner.style.display = 'none';
                    break;
                default:
                    statusDiv.classList.add('status-warning');
                    spinner.style.display = 'block';
            }

            textElement.textContent = message;
            indicator.classList.remove('hidden');
        }

        function hideDataStatus() {
            document.getElementById('dataStatusIndicator').classList.add('hidden');
        }

        // ====================================================================
        // è¿›åº¦æ›´æ–°å‡½æ•°
        // ====================================================================
        function updateOverallProgress() {
            const overallProgressTitle = document.getElementById('overallProgressTitle');
            const overallProgressText = document.getElementById('overallProgressText');
            const overallProgressDetail = document.getElementById('overallProgressDetail');
            const overallProgressFill = document.getElementById('overallProgressFill');
            
            if (currentLanguage === 'zh') {
                overallProgressTitle.textContent = 'å®éªŒè¿›åº¦';
                overallProgressText.textContent = `ç¬¬ ${currentGroupNumber} ç»„ / å…± ${MAX_GROUPS} ç»„`;
                overallProgressDetail.textContent = `å½“å‰ç»„è¿›åº¦: ${currentComparisonIndex + 1}/20`;
            } else {
                overallProgressTitle.textContent = 'Experiment Progress';
                overallProgressText.textContent = `Group ${currentGroupNumber} / ${MAX_GROUPS}`;
                overallProgressDetail.textContent = `Current group: ${currentComparisonIndex + 1}/20`;
            }
            
            const groupProgress = (currentGroupNumber - 1) / MAX_GROUPS;
            const currentGroupProgress = (currentComparisonIndex + 1) / 20 / MAX_GROUPS;
            const totalProgress = (groupProgress + currentGroupProgress) * 100;
            
            overallProgressFill.style.width = `${Math.min(totalProgress, 100)}%`;
        }

        function updateContinueProgress() {
            const continueProgressText = document.getElementById('continueProgressText');
            const continueProgressFill = document.getElementById('continueProgressFill');
            
            if (currentLanguage === 'zh') {
                continueProgressText.textContent = `å·²å®Œæˆ ${currentGroupNumber}/${MAX_GROUPS} ç»„`;
            } else {
                continueProgressText.textContent = `Completed ${currentGroupNumber}/${MAX_GROUPS} groups`;
            }
            
            const progressPercentage = (currentGroupNumber / MAX_GROUPS) * 100;
            continueProgressFill.style.width = `${progressPercentage}%`;
        }

        // ====================================================================
        // é—®å·é€»è¾‘
        // ====================================================================
        const texts = {
            zh: {
                surveyTitle: 'è¡—æ™¯æ„ŸçŸ¥é—®å·ï¼šç¬¬ä¸€éƒ¨åˆ†',
                reminderTitle: 'ğŸ”” å®éªŒæé†’',
                reminderText: 'è¯·è®¤çœŸä½œç­”ã€‚æœ¬å®éªŒéœ€è¦å®Œæˆ5ç»„ï¼Œæ¯ç»„20æ¬¡å›¾ç‰‡å¯¹æ¯”ï¼Œè€—æ—¶çº¦20åˆ†é’Ÿï¼Œæ‰èƒ½è·å¾—æœ€ç»ˆæŠ¥é…¬ã€‚',
                reminderDevice: 'ä¸ºä¿è¯å®éªŒæ•ˆæœï¼Œè¯·ä½¿ç”¨ç”µè„‘æˆ–å¹³æ¿ç”µè„‘ä½œç­”ã€‚',
                nicknameLabel: 'æ‚¨çš„æ˜µç§°æ˜¯ï¼š',
                nicknameHint: 'è¯·è®°å¿†ï¼Œä»¥ç”¨äºå…‘æ¢è¢«è¯•è´¹ç”¨ã€‚å»ºè®®ä½¿ç”¨å§“åæ‹¼éŸ³ã€‚',
                genderLabel: 'æ‚¨çš„æ€§åˆ«æ˜¯ï¼š',
                maleLabel: 'ç”·',
                femaleLabel: 'å¥³',
                ageLabel: 'æ‚¨çš„å¹´é¾„ï¼š',
                professionalLabel: 'æ‚¨æ¥è‡ªåŸå¸‚è§„åˆ’/å»ºç­‘/é£æ™¯å›­æ—ç›¸å…³ä¸“ä¸šå—ï¼Ÿ',
                yesLabel: 'æ˜¯',
                noLabel: 'å¦',
                consentTitle: 'å®éªŒçŸ¥æƒ…åŒæ„',
                consentAgree: 'æˆ‘å·²é˜…è¯»å¹¶ç†è§£ä¸Šè¿°è¯´æ˜ï¼ŒåŒæ„å‚ä¸æœ¬å®éªŒ',
                nextButton: 'ä¸‹ä¸€éƒ¨åˆ†',
                compareTitle: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"å"çš„è¡Œä¸ºï¼š',
                hintTitle: 'æç¤º',
                instructions: 'åœ¨æ­¤è°ƒç ”ä¸­ï¼Œæ‚¨éœ€è¦å¯¹æ¯å¯¹å›¾ç‰‡å›ç­”å››ä¸ªä¸åŒçš„è¡Œä¸ºé—®é¢˜ã€‚è¯·æ ¹æ®æ‚¨çš„ç›´è§‰é€‰æ‹©æ‚¨è®¤ä¸ºæ›´åŠ é€‚åˆè¿›è¡Œå„ç§æ´»åŠ¨çš„è¡—æ™¯ã€‚æ‰€æœ‰é—®é¢˜éƒ½å¿…é¡»å›ç­”å®Œæ¯•æ‰èƒ½è¿›å…¥ä¸‹ä¸€å¯¹å›¾ç‰‡ã€‚',
                continueTitle: 'æœ¬ç»„å¯¹æ¯”å·²å®Œæˆ',
                continueButton: 'ç»§ç»­ä¸‹ä¸€ç»„',
                exitButton: 'é€€å‡ºå®éªŒ',
                exitWarningTitle: 'âš ï¸ é€€å‡ºè­¦å‘Š',
                exitWarningMessage: 'æ‚¨è¿˜æœªå®Œæˆå…¨éƒ¨5ç»„å®éªŒï¼Œç°åœ¨é€€å‡ºå°†æ— æ³•è·å¾—æŠ¥é…¬ã€‚\n\nç¡®å®šè¦é€€å‡ºå—ï¼Ÿ',
                backButton: 'è¿”å›ç»§ç»­å®éªŒ',
                forceExitButton: 'ç¡®å®šé€€å‡º',
                finishButton: 'å®Œæˆå®éªŒ',
                thankYouTitle: 'ğŸ‰ æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼',
                thankYouMessage: 'æ‚¨å·²æˆåŠŸå®Œæˆå…¨éƒ¨5ç»„å®éªŒï¼Œæ•°æ®å·²æäº¤ï¼\n\næ„Ÿè°¢æ‚¨ä¸ºè¡—æ™¯æ„ŸçŸ¥ç ”ç©¶åšå‡ºçš„è´¡çŒ®ï¼è¯·è”ç³»ç ”ç©¶äººå‘˜å…‘æ¢æŠ¥é…¬ã€‚',
                restartButton: 'é‡æ–°å¼€å§‹',
                nicknameConfirmText: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼',
                imageALabel: 'å›¾ç‰‡ A',
                imageBLabel: 'å›¾ç‰‡ B',
                optionA: 'å›¾ç‰‡ A',
                optionB: 'å›¾ç‰‡ B',
                question1: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"åæ†©"çš„è¡Œä¸ºï¼š',
                question2: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ¼«æ­¥"çš„è¡Œä¸ºï¼š',
                question3: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"æ…¢è·‘"çš„è¡Œä¸ºï¼š',
                question4: 'ä»¥ä¸‹ä¸¤å¼ è¡—æ™¯ä¸­ï¼Œæ‚¨è®¤ä¸ºå“ªå¼ æ›´åŠ é€‚åˆ"èšä¼šæˆ–èšé›†"çš„è¡Œä¸ºï¼š',
                confirmButtonText: 'ç¡®è®¤å¹¶ç»§ç»­',
                timeWarningText: 'è¯·ä»”ç»†è§‚å¯Ÿå›¾ç‰‡è‡³å°‘6ç§’åå†è¿›è¡Œé€‰æ‹©'
            },
            en: {
                surveyTitle: 'Street View Perception Questionnaire: Part 1',
                reminderTitle: 'ğŸ”” Experiment Reminder',
                reminderText: 'Please answer carefully. This experiment requires completing 5 groups, with 20 image comparisons each, taking about 20 minutes total to receive the final compensation.',
                reminderDevice: 'For best results, please use a computer or tablet.',
                nicknameLabel: 'Your nickname is:',
                nicknameHint: 'Keep this in mind for getting the participant fees. It is recommended to use your First Name.',
                genderLabel: 'Your gender is:',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                ageLabel: 'Your age:',
                professionalLabel: 'Are you from urban planning/architecture/landscape architecture related majors?',
                yesLabel: 'Yes',
                noLabel: 'No',
                consentTitle: 'Informed Consent',
                consentAgree: 'I have read and understood the above information and agree to participate in this experiment',
                nextButton: 'Next Part',
                compareTitle: 'Which of the following two street views do you think is more suitable for sitting:',
                hintTitle: 'Hint',
                instructions: 'In this survey, you need to answer four different behavioral questions for each pair of images. Please choose the street view you think is more suitable for various activities based on your intuition. All questions must be answered before proceeding to the next pair of images.',
                continueTitle: 'Group Comparison Completed',
                continueButton: 'Continue Next Group',
                exitButton: 'Exit Experiment',
                exitWarningTitle: 'âš ï¸ Exit Warning',
                exitWarningMessage: 'You have not completed all 5 groups yet. Exiting now means you will not receive compensation.\n\nAre you sure you want to exit?',
                backButton: 'Return to Continue',
                forceExitButton: 'Confirm Exit',
                finishButton: 'Complete Experiment',
                thankYouTitle: 'ğŸ‰ Thank You for Your Participation!',
                thankYouMessage: 'You have successfully completed all 5 groups! Your data has been submitted.\n\nThank you for contributing to street view perception research! Please contact the researchers to claim your compensation.',
                restartButton: 'Start Over',
                nicknameConfirmText: 'Thank you for your participation!',
                imageALabel: 'Image A',
                imageBLabel: 'Image B',
                optionA: 'Image A',
                optionB: 'Image B',
                question1: 'Which of the following two street views do you think is more suitable for "sitting":',
                question2: 'Which of the following two street views do you think is more suitable for "strolling":',
                question3: 'Which of the following two street views do you think is more suitable for "jogging":',
                question4: 'Which of the following two street views do you think is more suitable for "gathering":',
                confirmButtonText: 'Confirm and Continue',
                timeWarningText: 'Please observe the images carefully for at least 6 seconds before making a selection'
            }
        };

        function selectLanguage(lang) {
            currentLanguage = lang;
            updateTexts();
            showPage('surveyPage');
        }

        function updateTexts() {
            const t = texts[currentLanguage];
            
            Object.keys(t).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (key === 'continueMessage' || key === 'thankYouMessage' || key === 'exitWarningMessage') {
                        element.innerHTML = t[key].replace(/\n/g, '<br>');
                    } else {
                        element.textContent = t[key];
                    }
                }
            });
            
            const optionAElements = document.querySelectorAll('.optionA');
            const optionBElements = document.querySelectorAll('.optionB');
            
            optionAElements.forEach(element => {
                element.textContent = t.optionA;
            });
            
            optionBElements.forEach(element => {
                element.textContent = t.optionB;
            });

            if (currentLanguage === 'en') {
                document.getElementById('consentText').innerHTML = `
                    <p class="mb-3"><strong>Research Institution:</strong> Urban Morphology Studio (UMS), Urban Governance and Design Thrust, Hong Kong University of Science and Technology (Guangzhou)</p>
                    <p class="mb-3"><strong>Research Purpose:</strong> This experiment aims to understand people's perception and preference for behavioral suitability in different street environments. Through systematic comparison of street view images, we seek to identify patterns in how individuals assess spatial affordances for various human activities, contributing to evidence-based urban design practices.</p>
                    <p class="mb-3"><strong>Experimental Process:</strong> During the experiment, we will record:</p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Your basic information (nickname, gender, age, professional background)</li>
                        <li>Your choices regarding behavioral suitability of different street view images</li>
                        <li>Your response time and viewing duration</li>
                        <li>Timestamps of your participation</li>
                    </ul>
                    <p class="mb-3"><strong>Data Usage:</strong> All collected data will be used solely for scientific research related to urban design and spatial perception.</p>
                    <p class="mb-3"><strong>We commit to:</strong></p>
                    <ul class="list-disc list-inside mb-3 ml-4">
                        <li>Strict confidentiality of your personal information</li>
                        <li>Use of data for academic research purposes only</li>
                        <li>Publication of research results in anonymized form</li>
                        <li>Your right to withdraw from the experiment at any time</li>
                    </ul>
                    <p class="mb-3"><strong>Contact Information:</strong> If you have any questions, please contact the research team.</p>
                    <p class="font-semibold">Participation in this experiment indicates that you have fully understood the above content and voluntarily participate.</p>
                `;
            }

            updateContinueMessage();
        }

        function updateContinueMessage() {
            const continueMessage = document.getElementById('continueMessage');
            if (!continueMessage) return;

            const remainingGroups = MAX_GROUPS - currentGroupNumber;
            
            if (currentLanguage === 'zh') {
                if (currentGroupNumber < MAX_GROUPS) {
                    continueMessage.innerHTML = `æ‚¨å·²å®Œæˆäº†ç¬¬${currentGroupNumber}ç»„å›¾ç‰‡å¯¹æ¯”ï¼<br>è¿˜éœ€è¦å®Œæˆ${remainingGroups}ç»„æ‰èƒ½è·å¾—æŠ¥é…¬ã€‚`;
                } else {
                    continueMessage.innerHTML = `æ­å–œï¼æ‚¨å·²å®Œæˆå…¨éƒ¨${MAX_GROUPS}ç»„å®éªŒï¼<br>å¯ä»¥æäº¤æ•°æ®å¹¶è·å¾—æŠ¥é…¬äº†ã€‚`;
                }
            } else {
                if (currentGroupNumber < MAX_GROUPS) {
                    continueMessage.innerHTML = `You have completed group ${currentGroupNumber}!<br>You need to complete ${remainingGroups} more groups to receive compensation.`;
                } else {
                    continueMessage.innerHTML = `Congratulations! You have completed all ${MAX_GROUPS} groups!<br>You can now submit your data and receive compensation.`;
                }
            }
        }

        function showPage(pageId) {
            const pages = ['languagePage', 'surveyPage', 'comparisonPage', 'continuePage', 'exitWarningPage', 'thankYouPage'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function startComparisons() {
            const nickname = document.getElementById('nicknameInput').value.trim();
            const gender = document.querySelector('input[name="gender"]:checked');
            const age = document.getElementById('ageInput').value;
            const professional = document.querySelector('input[name="professional"]:checked');
            const consent = document.getElementById('consentCheckbox').checked;

            if (!nickname || !gender || !age || !professional || !consent) {
                alert(currentLanguage === 'zh' ? 'è¯·å®Œæ•´å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹å¹¶åŒæ„å‚ä¸å®éªŒï¼' : 'Please fill in all required fields and agree to participate!');
                return;
            }

            userData = {
                nickname: nickname,
                gender: gender.value,
                age: age,
                isProfessional: professional.value
            };

            if (!isImageLibraryLoaded) {
                await initializeImageLibrary();
            }

            if (fullImageLibrary.length < 2) {
                alert(currentLanguage === 'zh' ? 'å›¾ç‰‡åº“åŠ è½½å¤±è´¥æˆ–å›¾ç‰‡æ•°é‡ä¸è¶³ï¼' : 'Image library failed to load or insufficient images!');
                return;
            }

            startNewGroup();
        }

        function startNewGroup() {
            preloadedImages.clear();
            selectImagesForCurrentGroup();
            generateComparisonPairs();
            currentComparisonIndex = 0;
            comparisons = [];
            generateNewComparison();
            showPage('comparisonPage');
            updateGroupCounter();
            updateOverallProgress();
        }

        function updateGroupCounter() {
            const groupText = currentLanguage === 'zh' ? `ç¬¬ ${currentGroupNumber} ç»„` : `Group ${currentGroupNumber}`;
            document.getElementById('groupCounter').textContent = groupText;
        }

        function generateComparisonPairs() {
            comparisonPairs = [];
            
            let imagePool = [];
            imageLibrary.forEach(img => {
                imagePool.push(img.id);
                imagePool.push(img.id);
            });
            
            for (let i = imagePool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [imagePool[i], imagePool[j]] = [imagePool[j], imagePool[i]];
            }
            
            debugLog(`ğŸ“Š å›¾ç‰‡æ± åˆ›å»ºå®Œæˆï¼Œå…± ${imagePool.length} ä¸ªå›¾ç‰‡å®ä¾‹`);
            
            for (let i = 0; i < imagePool.length - 1; i += 2) {
                let imageAId = imagePool[i];
                let imageBId = imagePool[i + 1];
                
                if (imageAId === imageBId && i + 2 < imagePool.length) {
                    for (let k = i + 2; k < imagePool.length; k++) {
                        if (imagePool[k] !== imageAId) {
                            [imagePool[i + 1], imagePool[k]] = [imagePool[k], imagePool[i + 1]];
                            imageBId = imagePool[i + 1];
                            break;
                        }
                    }
                }
                
                if (imageAId !== imageBId) {
                    const imageA = imageLibrary.find(img => img.id === imageAId);
                    const imageB = imageLibrary.find(img => img.id === imageBId);
                    
                    if (imageA && imageB) {
                        comparisonPairs.push({ imageA, imageB });
                    }
                }
                
                if (comparisonPairs.length >= 20) {
                    break;
                }
            }
            
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„ç”Ÿæˆäº† ${comparisonPairs.length} ç»„é…å¯¹`);
        }

        function generateNewComparison() {
            if (currentComparisonIndex >= 20) {
                completeCurrentGroup();
                return;
            }
            
            currentPair = comparisonPairs[currentComparisonIndex];

            const imageA_img = document.getElementById('imageA_img');
            const imageB_img = document.getElementById('imageB_img');

            imageA_img.alt = currentPair.imageA.name;
            imageB_img.alt = currentPair.imageB.name;

            loadImageWithFallback(imageA_img, currentPair.imageA);
            loadImageWithFallback(imageB_img, currentPair.imageB);

            preloadNextPair();

            document.getElementById('progressCounter').textContent = `${currentComparisonIndex + 1}/20`;
            
            resetAllSelections();
            startComparisonTimer();
            updateOverallProgress();
        }

        function resetAllSelections() {
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.checked = false;
                });
            });
            
            const confirmButton = document.getElementById('confirmButton');
            confirmButton.disabled = true;
            confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
        }

        function checkAllAnswered() {
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            const allAnswered = radioGroups.every(group => {
                return document.querySelector(`input[name="${group}"]:checked`) !== null;
            });
            
            const confirmButton = document.getElementById('confirmButton');
            if (allAnswered) {
                confirmButton.disabled = false;
                confirmButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                confirmButton.classList.add('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
            } else {
                confirmButton.disabled = true;
                confirmButton.classList.remove('bg-green-600', 'hover:bg-green-700', 'cursor-pointer');
                confirmButton.classList.add('bg-gray-400', 'cursor-not-allowed');
            }
        }

        async function confirmAllSelections() {
            if (!checkMinimumViewTime()) {
                showTimeWarning();
                return;
            }
            
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            const behaviors = ['åæ†©', 'æ¼«æ­¥', 'æ…¢è·‘', 'èšä¼šæˆ–èšé›†'];
            const answers = {};
            
            let allAnswered = true;
            radioGroups.forEach((group, index) => {
                const selected = document.querySelector(`input[name="${group}"]:checked`);
                if (selected) {
                    answers[group] = {
                        behavior: behaviors[index],
                        choice: selected.value,
                        winner: selected.value === 'A' ? currentPair.imageA.id : currentPair.imageB.id,
                        loser: selected.value === 'A' ? currentPair.imageB.id : currentPair.imageA.id,
                        winnerImage: selected.value === 'A' ? currentPair.imageA.name : currentPair.imageB.name,
                        loserImage: selected.value === 'A' ? currentPair.imageB.name : currentPair.imageA.name
                    };
                } else {
                    allAnswered = false;
                }
            });

            if (!allAnswered) {
                alert(currentLanguage === 'zh' ? 'è¯·å›ç­”æ‰€æœ‰é—®é¢˜ï¼' : 'Please answer all questions!');
                return;
            }

            comparisons.push({
                imageA: currentPair.imageA,
                imageB: currentPair.imageB,
                answers: answers,
                timestamp: new Date().toISOString(),
                groupNumber: currentGroupNumber,
                comparisonIndex: currentComparisonIndex + 1,
                viewTime: Date.now() - comparisonStartTime
            });

            currentComparisonIndex++;
            cleanupPreloadCache();
            generateNewComparison();
        }

        async function completeCurrentGroup() {
            debugLog(`âœ… ç¬¬${currentGroupNumber}ç»„å¯¹æ¯”å®Œæˆï¼Œå…±${comparisons.length}æ¬¡å¯¹æ¯”`);
            
            const saveSuccess = await saveUserSession();
            
            if (!saveSuccess) {
                const retryMessage = currentLanguage === 'zh' ? 
                    'æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚æ˜¯å¦é‡è¯•ï¼Ÿ' : 
                    'Data save failed, please check your internet connection. Retry?';
                
                if (confirm(retryMessage)) {
                    const retrySaveSuccess = await saveUserSession();
                    if (!retrySaveSuccess) {
                        alert(currentLanguage === 'zh' ? 
                            'æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·è”ç³»ç ”ç©¶äººå‘˜ã€‚' : 
                            'Data save failed, please contact the researchers.');
                        return;
                    }
                }
            }
            
            updateContinueProgress();
            updateContinueMessage();
            
            if (currentGroupNumber >= MAX_GROUPS) {
                document.getElementById('continueButtons').classList.add('hidden');
                document.getElementById('finishButtons').classList.remove('hidden');
            } else {
                document.getElementById('continueButtons').classList.remove('hidden');
                document.getElementById('finishButtons').classList.add('hidden');
            }
            
            showPage('continuePage');
        }

        function continueNextGroup() {
            if (currentGroupNumber >= MAX_GROUPS) {
                finishSurvey();
                return;
            }
            
            currentGroupNumber++;
            startNewGroup();
        }

        function showExitWarning() {
            if (currentGroupNumber >= MAX_GROUPS) {
                finishSurvey();
                return;
            }
            
            showPage('exitWarningPage');
        }

        function backToContinue() {
            showPage('continuePage');
        }

        function forceExit() {
            restart();
        }

        function finishSurvey() {
            if (currentGroupNumber < MAX_GROUPS) {
                showExitWarning();
                return;
            }
            
            updateThankYouPageWithNickname();
            showPage('thankYouPage');
        }

        function updateThankYouPageWithNickname() {
            const nicknameElement = document.getElementById('thankYouNickname');
            const confirmTextElement = document.getElementById('nicknameConfirmText');
            
            if (userData.nickname) {
                nicknameElement.textContent = userData.nickname;
                
                if (currentLanguage === 'zh') {
                    confirmTextElement.textContent = `æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œ${userData.nickname}ï¼`;
                } else {
                    confirmTextElement.textContent = `Thank you for your participation, ${userData.nickname}!`;
                }
            }
        }

        function restart() {
            userData = { nickname: '', gender: '', age: '', isProfessional: '' };
            comparisons = [];
            currentPair = { imageA: null, imageB: null };
            selectedOption = null;
            comparisonPairs = [];
            currentComparisonIndex = 0;
            currentGroupNumber = 1;
            sessionId = generateSessionId();
            preloadedImages.clear();
            comparisonStartTime = null;
            timeWarningShown = false;
            
            document.querySelectorAll('input[type="radio"]').forEach(input => input.checked = false);
            document.getElementById('nicknameInput').value = '';
            document.getElementById('ageInput').value = '';
            document.getElementById('consentCheckbox').checked = false;
            
            showPage('languagePage');
        }

        // ====================================================================
        // ç®¡ç†å‘˜ç•Œé¢
        // ====================================================================
        const ENCODED_ADMIN_KEY = 'VU1TMjAyNXlncw==';
        
        function getAdminPassword() {
            return atob(ENCODED_ADMIN_KEY);
        }
        
        async function showAdminPanel() {
            const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ï¼š');
            
            if (password === null) {
                return;
            }
            
            if (password !== getAdminPassword()) {
                alert('å¯†ç é”™è¯¯ï¼');
                return;
            }
            
            document.getElementById('adminPanel').classList.remove('hidden');
            await refreshStats();
        }

        function hideAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        // æ›´æ–°ç®¡ç†å‘˜ç•Œé¢ä»¥æ˜¾ç¤ºå¤šbinçŠ¶æ€
        async function refreshStats() {
            try {
                updateDatabaseStatus('æ­£åœ¨è¿æ¥å¤šbinç³»ç»Ÿ...', 'loading');
                disableAdminButtons(true);
                
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                
                const data = await multiBinManager.readAllData();
                const systemStatus = multiBinManager.getSystemStatus();
                
                updateDatabaseStatus(`å¤šbinç³»ç»Ÿè¿æ¥æˆåŠŸ (${systemStatus.totalBins} bins)`, 'success');
                disableAdminButtons(false);
                
                // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
                displaySystemStatus(systemStatus);
                
                // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
                const uniqueSessions = new Map();
                (data.sessions || []).forEach(session => {
                    if (!uniqueSessions.has(session.sessionId) || 
                        session.groupsCompleted > uniqueSessions.get(session.sessionId).groupsCompleted) {
                        uniqueSessions.set(session.sessionId, session);
                    }
                });
                
                const totalUsers = uniqueSessions.size;
                const totalComparisons = (data.comparisons || []).length;
                const avgGroups = totalUsers > 0 ? (totalComparisons / totalUsers / 20).toFixed(1) : '0';
                
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalComparisons').textContent = totalComparisons;
                document.getElementById('avgGroups').textContent = avgGroups;
                
                displayRecentComparisons(data.comparisons || []);
                displayUserDetails(Array.from(uniqueSessions.values()));
                
            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                updateDatabaseStatus('è¿æ¥å¤šbinç³»ç»Ÿå¤±è´¥', 'error');
                disableAdminButtons(true);
            }
        }

        // æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
        function displaySystemStatus(systemStatus) {
            const systemStatusPanel = document.getElementById('systemStatus');
            const systemStatusContent = document.getElementById('systemStatusContent');
            
            systemStatusPanel.classList.remove('hidden');
            
            let statusHtml = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <span class="font-medium">æ€»Binæ•°:</span>
                        <span class="text-blue-600 font-semibold">${systemStatus.totalBins}</span>
                    </div>
                    <div>
                        <span class="font-medium">å½“å‰æ´»è·ƒBin:</span>
                        <span class="text-green-600 font-semibold">${systemStatus.currentBinId?.substring(0, 12) || 'N/A'}...</span>
                    </div>
                    <div>
                        <span class="font-medium">å½“å‰Binä½¿ç”¨ç‡:</span>
                        <span class="text-purple-600 font-semibold">${systemStatus.usagePercentage}%</span>
                    </div>
                    <div>
                        <span class="font-medium">å½“å‰Binå¤§å°:</span>
                        <span class="text-orange-600 font-semibold">${Math.round(systemStatus.currentBinSize / 1024)}KB</span>
                    </div>
                </div>
                
                <div class="mb-4">
                    <div class="text-sm text-gray-600 mb-2">å½“å‰Binå®¹é‡ä½¿ç”¨æƒ…å†µ</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-fill" style="width: ${systemStatus.usagePercentage}%"></div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        ${Math.round(systemStatus.currentBinSize / 1024)}KB / ${Math.round(systemStatus.maxBinSize / 1024)}KB
                    </div>
                </div>
                
                <div>
                    <div class="text-sm font-medium text-gray-700 mb-2">æ‰€æœ‰BinçŠ¶æ€:</div>
                    <div class="space-y-1">
            `;
            
            systemStatus.bins.forEach((bin, index) => {
                const statusClass = bin.status === 'active' ? 'active' : 
                                 bin.status === 'full' ? 'full' : '';
                const statusText = bin.status === 'active' ? 'æ´»è·ƒ' :
                                bin.status === 'full' ? 'å·²æ»¡' : 'ç©ºé—²';
                
                statusHtml += `
                    <div class="bin-status ${statusClass}">
                        <div>
                            <span class="font-medium">Bin ${index + 1}:</span>
                            <span class="text-xs text-gray-600">${bin.binId}</span>
                        </div>
                        <div class="text-sm">
                            <span class="px-2 py-1 rounded text-xs ${
                                bin.status === 'active' ? 'bg-green-100 text-green-700' :
                                bin.status === 'full' ? 'bg-orange-100 text-orange-700' :
                                'bg-gray-100 text-gray-700'
                            }">${statusText}</span>
                            <span class="ml-2 text-gray-600">${bin.sizeKB}KB (${bin.recordCount} è®°å½•)</span>
                        </div>
                    </div>
                `;
            });
            
            statusHtml += `
                    </div>
                </div>
            `;
            
            systemStatusContent.innerHTML = statusHtml;
        }

        function displayRecentComparisons(comparisons) {
            const container = document.getElementById('comparisonData');
            
            if (comparisons.length === 0) {
                container.innerHTML = '<div class="text-gray-500">æš‚æ— å¯¹æ¯”æ•°æ®</div>';
                return;
            }
            
            const recent = comparisons.slice(-20);
            
            let html = `
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2">æ˜µç§°</th>
                            <th class="border border-gray-300 p-2">ç»„å·</th>
                            <th class="border border-gray-300 p-2">å›¾ç‰‡A</th>
                            <th class="border border-gray-300 p-2">å›¾ç‰‡B</th>
                            <th class="border border-gray-300 p-2">åæ†©</th>
                            <th class="border border-gray-300 p-2">æ¼«æ­¥</th>
                            <th class="border border-gray-300 p-2">æ…¢è·‘</th>
                            <th class="border border-gray-300 p-2">èšé›†</th>
                            <th class="border border-gray-300 p-2">æ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            recent.forEach(comp => {
                html += `
                    <tr>
                        <td class="border border-gray-300 p-2">${comp.nickname}</td>
                        <td class="border border-gray-300 p-2">${comp.groupNumber}</td>
                        <td class="border border-gray-300 p-2">${comp.image1_name}</td>
                        <td class="border border-gray-300 p-2">${comp.image2_name}</td>
                        <td class="border border-gray-300 p-2">${comp.sitting === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.strolling === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.jogging === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${comp.gathering === 0 ? 'A' : 'B'}</td>
                        <td class="border border-gray-300 p-2">${new Date(comp.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function displayUserDetails(sessions) {
            const container = document.getElementById('userDetails');
            
            if (sessions.length === 0) {
                container.innerHTML = '<div class="text-gray-500">æš‚æ— ç”¨æˆ·æ•°æ®</div>';
                return;
            }
            
            // æŒ‰æœ€åæ›´æ–°æ—¶é—´æ’åº
            const sortedSessions = sessions.sort((a, b) => 
                new Date(b.lastUpdated || b.timestamp) - new Date(a.lastUpdated || a.timestamp)
            );
            
            let html = `
                <table class="w-full text-sm border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border border-gray-300 p-2">æ˜µç§°</th>
                            <th class="border border-gray-300 p-2">æ€§åˆ«</th>
                            <th class="border border-gray-300 p-2">å¹´é¾„</th>
                            <th class="border border-gray-300 p-2">ä¸“ä¸šèƒŒæ™¯</th>
                            <th class="border border-gray-300 p-2">å®Œæˆç»„æ•°</th>
                            <th class="border border-gray-300 p-2">æ€»å¯¹æ¯”æ¬¡æ•°</th>
                            <th class="border border-gray-300 p-2">è¯­è¨€</th>
                            <th class="border border-gray-300 p-2">å®ŒæˆçŠ¶æ€</th>
                            <th class="border border-gray-300 p-2">æœ€åæ›´æ–°</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sortedSessions.forEach(session => {
                const isComplete = session.groupsCompleted >= 5;
                const statusText = isComplete ? 'å·²å®Œæˆ' : `è¿›è¡Œä¸­ (${session.groupsCompleted}/5)`;
                const statusClass = isComplete ? 'text-green-600 font-semibold' : 'text-blue-600';
                
                html += `
                    <tr>
                        <td class="border border-gray-300 p-2">${session.userData.nickname}</td>
                        <td class="border border-gray-300 p-2">${session.userData.gender === 'male' ? 'ç”·' : 'å¥³'}</td>
                        <td class="border border-gray-300 p-2">${session.userData.age}</td>
                        <td class="border border-gray-300 p-2">${session.userData.isProfessional === 'yes' ? 'æ˜¯' : 'å¦'}</td>
                        <td class="border border-gray-300 p-2">${session.groupsCompleted}</td>
                        <td class="border border-gray-300 p-2">${session.totalComparisons || 0}</td>
                        <td class="border border-gray-300 p-2">${session.language === 'zh' ? 'ä¸­æ–‡' : 'English'}</td>
                        <td class="border border-gray-300 p-2 ${statusClass}">${statusText}</td>
                        <td class="border border-gray-300 p-2">${new Date(session.lastUpdated || session.timestamp).toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateDatabaseStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('databaseStatus');
            
            let html = '';
            switch (type) {
                case 'loading':
                    html = `
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
                case 'success':
                    html = `
                        <div class="status-indicator status-success">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
                case 'error':
                    html = `
                        <div class="status-indicator status-error">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            <span>${message}</span>
                        </div>
                    `;
                    break;
            }
            
            statusDiv.innerHTML = html;
        }

        function disableAdminButtons(disabled) {
            document.getElementById('exportButton').disabled = disabled;
            document.getElementById('clearButton').disabled = disabled;
            
            if (disabled) {
                document.getElementById('exportButton').classList.add('disabled:bg-gray-400');
                document.getElementById('clearButton').classList.add('disabled:bg-gray-400');
            } else {
                document.getElementById('exportButton').classList.remove('disabled:bg-gray-400');
                document.getElementById('clearButton').classList.remove('disabled:bg-gray-400');
            }
        }

        async function exportData() {
            try {
                updateDatabaseStatus('æ­£åœ¨å¯¼å‡ºæ•°æ®...', 'loading');
                
                const data = await multiBinManager.readAllData();
                
                if (!data.comparisons || data.comparisons.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }
                
                // æŒ‰ç…§æ‚¨æŒ‡å®šçš„å­—æ®µæ ¼å¼åˆ›å»ºCSV
                const headers = [
                    'sessionId', 'nickname', 'gender', 'age', 'isProfessional', 
                    'groupNumber', 'comparisonIndex', 'image1_url', 'image2_url', 
                    'image1_name', 'image2_name', 'sitting', 'strolling', 
                    'jogging', 'gathering', 'viewTime_ms', 'timestamp'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                data.comparisons.forEach(comp => {
                    const row = [
                        comp.sessionId,
                        comp.nickname,
                        comp.gender,
                        comp.age,
                        comp.isProfessional,
                        comp.groupNumber,
                        comp.comparisonIndex,
                        `"${comp.image1_url}"`,
                        `"${comp.image2_url}"`,
                        comp.image1_name,
                        comp.image2_name,
                        comp.sitting,
                        comp.strolling,
                        comp.jogging,
                        comp.gathering,
                        comp.viewTime || 0,
                        comp.timestamp
                    ];
                    csvContent += row.join(',') + '\n';
                });
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `è¡—æ™¯é—®å·å¯¹æ¯”æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                updateDatabaseStatus('æ•°æ®å¯¼å‡ºå®Œæˆ', 'success');
                setTimeout(() => {
                    updateDatabaseStatus('å¤šbinç³»ç»Ÿè¿æ¥æˆåŠŸ', 'success');
                }, 2000);
                
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                updateDatabaseStatus('å¯¼å‡ºå¤±è´¥', 'error');
                alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // æ›´æ–°æ¸…ç©ºæ•°æ®å‡½æ•°
        async function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                return;
            }
            
            if (!confirm('æœ€åç¡®è®¤ï¼šå°†åˆ é™¤æ‰€æœ‰binä¸­çš„å®éªŒæ•°æ®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                return;
            }
            
            try {
                updateDatabaseStatus('æ­£åœ¨æ¸…ç©ºæ‰€æœ‰binæ•°æ®...', 'loading');
                
                if (!multiBinManager) {
                    await initializeMultiBinManager();
                }
                
                await multiBinManager.clearAllData();
                
                updateDatabaseStatus('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º', 'success');
                await refreshStats();
                
            } catch (error) {
                console.error('æ¸…ç©ºå¤±è´¥:', error);
                updateDatabaseStatus('æ¸…ç©ºå¤±è´¥', 'error');
                alert('æ¸…ç©ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // ====================================================================
        // é¡µé¢åˆå§‹åŒ–
        // ====================================================================
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('ğŸš€ è¡—æ™¯é—®å·ç³»ç»Ÿå¯åŠ¨ - å¤šBinç‰ˆæœ¬');
            
            // åˆå§‹åŒ–å¤šbinç®¡ç†å™¨
            try {
                await initializeMultiBinManager();
                debugLog('âœ… å¤šbinç³»ç»Ÿåˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                debugLog('âŒ å¤šbinç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œç³»ç»Ÿä»å¯è¿è¡Œä½†å¯èƒ½æœ‰å­˜å‚¨é™åˆ¶');
                console.error('MultiBinåˆå§‹åŒ–é”™è¯¯:', error);
            }
            
            await initializeImageLibrary();
            
            const radioGroups = ['sitting', 'strolling', 'jogging', 'gathering'];
            radioGroups.forEach(group => {
                const radios = document.querySelectorAll(`input[name="${group}"]`);
                radios.forEach(radio => {
                    radio.addEventListener('change', checkAllAnswered);
                });
            });
            
            if (isImageLibraryLoaded) {
                debugLog(`âœ… ç³»ç»Ÿå°±ç»ªï¼Œå®Œæ•´å›¾ç‰‡åº“åŒ…å« ${fullImageLibrary.length} å¼ å›¾ç‰‡`);
            } else {
                debugLog('âš ï¸ å›¾ç‰‡åº“åˆå§‹åŒ–æœ‰é—®é¢˜ï¼Œä½†ç³»ç»Ÿä»å¯è¿è¡Œ');
            }
            
            debugLog('âœ… å¤šBiné…ç½®å®Œæˆ');
            if (multiBinManager) {
                const status = multiBinManager.getSystemStatus();
                debugLog(`ğŸ”— å½“å‰ç³»ç»Ÿ: ${status.totalBins} ä¸ªbinï¼Œæ´»è·ƒbin: ${status.currentBinId?.substring(0, 8)}...`);
            }
        });
    </script>
</body>
</html>
